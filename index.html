<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Exhibition Floorplan</title>
  <style>
    :root { --bg:#0b0f16; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; background:rgba(17,24,39,.8); position:sticky; top:0; backdrop-filter: blur(10px); z-index:10; }
    header h1 { margin:0; font-size:16px; font-weight:600; letter-spacing:.2px; }
    .status { font-size:13px; color:var(--muted); }
    .wrap { padding:14px 16px 24px; }
    .card { background:rgba(17,24,39,.85); border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    #svgHost { width:100%; height:auto; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; padding:10px 12px; border-top:1px solid rgba(255,255,255,.08); color:var(--muted); font-size:13px; }
    .chip { display:flex; gap:8px; align-items:center; }
    .dot { width:10px; height:10px; border-radius:50%; background:#999; border:1px solid rgba(255,255,255,.25); }
    .dot.sold { background:#ef4444; }
    .dot.avail { background:#22c55e; }

    /* Tooltip */
    #tooltip {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.35;
      background: rgba(17,24,39,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      color: var(--text);
      white-space: pre-wrap;
      display:none;
      max-width:min(320px, 80vw);
    }
  </style>
</head>
<body>
  <header>
    <h1>Exhibition Floorplan</h1>
    <div class="status" id="syncStatus">Loadingâ€¦</div>
  </header>

  <div class="wrap">
    <div class="card">
      <div id="svgHost"></div>
      <div class="legend">
        <div class="chip"><span class="dot sold"></span> Sold</div>
        <div class="chip"><span class="dot avail"></span> Available</div>
      </div>
    </div>
  </div>

  <div id="tooltip"></div>

<script>
(() => {
  const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxEq83BUYJ-oewP_2lPFL0tyol4veM2mhukSTTMCaKCZgEJS5m-f8Jqy1EO_bDc3q3a/exec';
  const SVG_URL = './event_plan.svg';

  const syncStatus = document.getElementById('syncStatus');
  const svgHost = document.getElementById('svgHost');
  const tooltip = document.getElementById('tooltip');

  const COLOR_SOLD = '#ef4444';
  const COLOR_AVAILABLE = '#22c55e';

  let svgRoot = null;
  let lastSyncAt = null;

  function setStatusOk(text) {
    syncStatus.textContent = text;
    syncStatus.style.color = '#9ca3af';
  }
  function setStatusErr(text) {
    syncStatus.textContent = text;
    syncStatus.style.color = '#fca5a5';
  }

  function jsonp(url, timeoutMs = 12000) {
    return new Promise((resolve, reject) => {
      const cbName = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      const timer = setTimeout(() => cleanup(new Error('JSONP timeout')), timeoutMs);

      function cleanup(err, data) {
        clearTimeout(timer);
        script.remove();
        try { delete window[cbName]; } catch (e) { window[cbName] = undefined; }
        if (err) reject(err);
        else resolve(data);
      }

      window[cbName] = (data) => cleanup(null, data);

      const sep = url.includes('?') ? '&' : '?';
      script.src = url + sep + 'callback=' + cbName + '&_=' + Date.now();
      script.onerror = () => cleanup(new Error('JSONP network error'));
      document.head.appendChild(script);
    });
  }

  function normalizeStatus(v) {
    v = String(v || '').toLowerCase().trim();
    return v === 'sold' ? 'sold' : 'available';
  }

  function tooltipText(standId, status, company) {
    const s = normalizeStatus(status);
    const lines = [String(standId || '').trim(), s === 'sold' ? 'Sold' : 'Available'];
    if (s === 'sold' && company) lines.push(String(company).trim());
    return lines.join('\n');
  }

  function findStandElements(root) {
    // heuristic: any element with an id that looks like a stand code
    const all = Array.from(root.querySelectorAll('[id]'));
    return all.filter(el => {
      const id = (el.id || '').trim();
      if (!id) return false;
      if (id.toLowerCase().includes('layer')) return false;
      if (id.length > 24) return false;
      return true;
    });
  }

  function applyStandStyle(el, status) {
    const s = normalizeStatus(status);
    el.style.cursor = 'pointer';
    el.style.fill = (s === 'sold') ? COLOR_SOLD : COLOR_AVAILABLE;
    el.style.fillOpacity = '0.5';       // 50% transparent so numbers show through
    el.style.stroke = 'rgba(0,0,0,.55)';
    el.style.strokeWidth = '1';
    el.style.strokeOpacity = '0.9';
  }

  function attachTooltip(el, info) {
    el.addEventListener('mousemove', (evt) => {
      const text = tooltipText(info.standId, info.status, info.company);
      tooltip.textContent = text;
      tooltip.style.left = (evt.clientX + 12) + 'px';
      tooltip.style.top  = (evt.clientY + 12) + 'px';
      tooltip.style.display = 'block';
    });
    el.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });
  }

  function applyStandData(data) {
    if (!svgRoot) return;
    const byId = new Map();
    (Array.isArray(data) ? data : []).forEach(r => {
      if (!r || !r.standId) return;
      byId.set(String(r.standId).trim(), {
        standId: String(r.standId).trim(),
        status: normalizeStatus(r.status),
        company: String(r.company || '').trim()
      });
    });

    const stands = findStandElements(svgRoot);
    stands.forEach(el => {
      const id = String(el.id).trim();
      const info = byId.get(id) || { standId:id, status:'available', company:'' };
      applyStandStyle(el, info.status);
      attachTooltip(el, info);
    });
  }

  async function loadSvg() {
    const res = await fetch(SVG_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load SVG: ' + res.status);
    const text = await res.text();
    svgHost.innerHTML = text;

    svgRoot = svgHost.querySelector('svg');
    if (!svgRoot) throw new Error('SVG root not found');
  }

  async function syncLoop() {
    try {
      const data = await jsonp(SHEET_API_URL);
      applyStandData(data);
      lastSyncAt = new Date();
      setStatusOk('Synced: ' + lastSyncAt.toLocaleString());
    } catch (err) {
      setStatusErr('Sync error: ' + err.message);
    } finally {
      setTimeout(syncLoop, 5000);
    }
  }

  (async () => {
    try {
      await loadSvg();
      await syncLoop();
    } catch (err) {
      setStatusErr('Load error: ' + err.message);
    }
  })();
})();
</script>
</body>
</html>
