<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{--border:#d9d9d9;--muted:#666;--sold:#e53935;--avail:#2ecc71;}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}
  header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;}
  #status{font-size:13px;color:var(--muted);}
  .wrap{padding:12px;}
  .card{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fff;}
  .cardHead{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);}
  .legend{display:flex;gap:10px;flex-wrap:wrap;padding:10px 12px;border-top:1px solid var(--border);}
  .pill{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:#222;border:1px solid var(--border);padding:6px 8px;border-radius:999px;background:#fff;}
  .dot{width:10px;height:10px;border-radius:50%;}
  .dot.sold{background:var(--sold);} .dot.avail{background:var(--avail);}
  #svgHost{overflow:auto;min-height:420px;}
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none;user-select:none;}
  #tooltip{position:fixed;display:none;z-index:9999;pointer-events:none;background:rgba(0,0,0,.85);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;white-space:pre-line;max-width:min(360px,85vw);}

  .soldSection{margin-top:12px;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:#fff;}
  .soldHeader{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  #soldSearch{flex:1;min-width:240px;padding:9px 10px;border:1px solid var(--border);border-radius:8px;font-size:14px;}
  .soldHint{margin-top:6px;font-size:12px;color:var(--muted);}
  .soldListWrap{margin-top:10px;border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:360px;}
  .soldItem{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid #eee;cursor:pointer;background:#fff;}
  .soldItem:nth-child(odd){background:#fafafa;}
  .soldItem:hover{background:#eef3ff;}
  .soldItem.active{background:#eaf0ff;outline:2px solid #b8c7ff;outline-offset:-2px;}
  .soldName{font-weight:700;font-size:13px;line-height:1.2;}
  .soldMeta{font-size:12px;color:var(--muted);white-space:nowrap;}

@media print{
  header, .soldSection{display:none !important;}
  .wrap{padding:0;}
  .card{border:none;border-radius:0;}
  .legend{border-top:none;}
  #svgHost{min-height:auto;}
}
</style>
</head>
<body>
<header>
  <strong>Exhibition Floorplan</strong>
  <div id="status">Loading…</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="cardHead">
      <div style="font-weight:700;">Plan</div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
        <button id="btnClearPins" style="padding:8px 10px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;">Clear pins</button>
        <button id="btnExportPdf" style="padding:8px 10px;border:1px solid var(--border);background:#f7f7f7;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;">Export PDF</button>
      </div>
    </div>

    <div id="svgHost"></div>

    <div class="legend">
      <span class="pill"><span class="dot sold"></span>Sold</span>
      <span class="pill"><span class="dot avail"></span>Available</span>
    </div>
  </div>

  <div class="soldSection">
    <div class="soldHeader">
      <strong>Sold exhibitors</strong>
      <input id="soldSearch" type="text" placeholder="Search company or stand…" />
    </div>
    <div class="soldHint">Click a company name to highlight its stand with a label and pointer line.</div>
    <div class="soldListWrap">
      <div id="soldList"></div>
    </div>
  </div>
</div>

<div id="tooltip"></div>

<script>
(() => {
  const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
  const SVG_URL = './event_plan.svg';
  const FILL_OPACITY = 0.75;
  const SYNC_INTERVAL_MS = 10000;
  const SOLD = '#e53935';
  const AVAIL = '#2ecc71';

  const elStatus = document.getElementById('status');
  const svgHost = document.getElementById('svgHost');
  const tooltip = document.getElementById('tooltip');
  const soldListEl = document.getElementById('soldList');
  const soldSearchEl = document.getElementById('soldSearch');
  const btnClearPins = document.getElementById('btnClearPins');
  const btnExportPdf = document.getElementById('btnExportPdf');

  let svgRoot = null;
  let byId = new Map(); // standId -> {standId,status,company}
  let calloutLayer = null;
  let pinned = new Set();

  // Stand IDs look like: A1, AA1, AB2, AD10, SB20, C6 etc.
  const STAND_ID_RE = /^([A-Z]{1,3})(\d{1,3})$/;

  function setStatus(text, isError=false){
    elStatus.textContent = text;
    elStatus.style.color = isError ? '#b00020' : '#555';
  }

  function normalizeStatus(v){
    return String(v||'').toLowerCase().trim()==='sold' ? 'sold' : 'available';
  }

  function tooltipText(info){
    const s = normalizeStatus(info.status);
    const lines = [info.standId, s==='sold' ? 'Sold' : 'Available'];
    if (s==='sold' && info.company) lines.push(info.company);
    return lines.join('\n');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL, { cache:'no-store' });
    if (!res.ok) throw new Error('SVG not found at ' + SVG_URL + ' (HTTP ' + res.status + ')');
    svgHost.innerHTML = await res.text();
    svgRoot = svgHost.querySelector('svg');
    if (!svgRoot) throw new Error('SVG root <svg> not found');
    svgRoot.style.userSelect = 'none';
  }

  function isStandId(id){
    const s = String(id||'').trim();
    return STAND_ID_RE.test(s);
  }

  function getStandNodes(){
    // Prefer <g id="A1"> groups, else shapes with id.
    const groups = Array.from(svgRoot.querySelectorAll('g[id]'))
      .filter(g => isStandId(g.id));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]'))
      .filter(el => isStandId(el.id));
    return groups.length ? groups : shapes;
  }

  function paintNode(node, status){
    const s = normalizeStatus(status);
    const color = s==='sold' ? SOLD : AVAIL;
    const targets = (node.tagName.toLowerCase()==='g')
      ? node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line')
      : [node];

    targets.forEach(el => {
      el.style.fill = color;
      el.style.fillOpacity = String(FILL_OPACITY);
      el.style.stroke = 'rgba(0,0,0,0.45)';
      el.style.strokeOpacity = '0.6';
      el.style.cursor = 'pointer';
    });
  }

  function svgEl(tag, attrs={}){
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, String(v));
    return el;
  }

  function ensureCalloutLayer(){
    if (!svgRoot) return;
    if (!calloutLayer){
      calloutLayer = svgEl('g', { id:'callouts' });
      svgRoot.appendChild(calloutLayer);
    }
  }

  function clearPins(){
    pinned.clear();
    if (calloutLayer) calloutLayer.innerHTML = '';
    soldListEl?.querySelectorAll('.soldItem.active').forEach(x=>x.classList.remove('active'));
  }

  function togglePin(standId){
    if (pinned.has(standId)) pinned.delete(standId);
    else pinned.add(standId);
    renderPins();
    renderSoldList();
  }

  function renderPins(){
    ensureCalloutLayer();
    if (!calloutLayer) return;
    calloutLayer.innerHTML = '';
    if (!pinned.size) return;

    // Build list of pin infos (sold with company only)
    const pins = Array.from(pinned)
      .map(id => byId.get(id))
      .filter(info => info && normalizeStatus(info.status)==='sold' && info.company);

    if (!pins.length){
      pinned.clear();
      return;
    }

    // Create callouts; try to keep labels readable by stacking them in a column at the side.
    // Column selection: right side if there is space, else left.
    let bounds;
    try{
      const vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
      if (vb && vb.width) bounds = {x:vb.x,y:vb.y,w:vb.width,h:vb.height};
    }catch{}
    if (!bounds){
      try{
        const b = svgRoot.getBBox();
        bounds = {x:b.x,y:b.y,w:b.width,h:b.height};
      }catch{
        bounds = {x:0,y:0,w:2000,h:2000};
      }
    }

    const labelWGuess = 260;
    const rightColX = bounds.x + bounds.w - (labelWGuess + 30);
    const leftColX  = bounds.x + 30;
    const useRight = true;

    // Sort pins by stand position (top-to-bottom) for nicer stacking
    const pinsWithBox = [];
    for (const info of pins){
      const node = svgRoot.querySelector('#' + CSS.escape(info.standId));
      if (!node) continue;
      try{
        const bb = node.getBBox();
        pinsWithBox.push({info, bb, cx: bb.x + bb.width/2, cy: bb.y + bb.height/2});
      }catch{}
    }
    pinsWithBox.sort((a,b)=>a.cy-b.cy);

    const startY = bounds.y + 40;
    const stepY = 44;

    pinsWithBox.forEach((p, idx) => {
      const labelX = useRight ? rightColX : leftColX;
      const labelY = Math.max(bounds.y + 30, Math.min(startY + idx*stepY, bounds.y + bounds.h - 30));

      const line = svgEl('line', {x1:p.cx,y1:p.cy,x2:labelX,y2:labelY,stroke:'#111','stroke-width':2,'stroke-linecap':'round'});
      line.style.opacity = '0.85';
      calloutLayer.appendChild(line);

      const g = svgEl('g', {});
      const text = svgEl('text', {x:labelX,y:labelY,'font-size':18,'font-family':'Arial, Helvetica, sans-serif','font-weight':'700',fill:'#111'});
      text.textContent = p.info.company;
      g.appendChild(text);
      calloutLayer.appendChild(g);

      const pad = 14;
      const tb = text.getBBox();
      const rect = svgEl('rect', {x:tb.x-pad,y:tb.y-pad,width:tb.width+pad*2,height:tb.height+pad*2,rx:10,ry:10,fill:'#fff',stroke:'#111','stroke-width':2});
      rect.style.opacity = '0.92';
      g.insertBefore(rect, text);
    });
  }
  function bindNodeEvents(node){
    const standId = String(node.id||'').trim();
    if (!standId) return;

    node.addEventListener('mousemove', e => {
      const info = byId.get(standId) || { standId, status:'available', company:'' };
      tooltip.textContent = tooltipText(info);
      tooltip.style.left = (e.clientX + 12) + 'px';
      tooltip.style.top  = (e.clientY + 12) + 'px';
      tooltip.style.display = 'block';
    });
    node.addEventListener('mouseleave', () => tooltip.style.display = 'none');

    node.addEventListener('click', () => {
      const info = byId.get(standId);
      if (info && normalizeStatus(info.status)==='sold' && info.company){
        togglePin(standId);
      }
    });
  }

  function renderPlan(){
    getStandNodes().forEach(node => {
      const id = String(node.id||'').trim();
      const info = byId.get(id) || { standId:id, status:'available', company:'' };
      paintNode(node, info.status);
    });
  }

  function renderSoldList(){
    const q = String(soldSearchEl.value||'').toLowerCase().trim();
    const sold = Array.from(byId.values())
      .filter(r => normalizeStatus(r.status)==='sold' && r.company)
      .sort((a,b) => a.company.localeCompare(b.company));

    const filtered = q ? sold.filter(r => r.company.toLowerCase().includes(q) || r.standId.toLowerCase().includes(q)) : sold;

    soldListEl.innerHTML = '';
    filtered.forEach(r => {
      const div = document.createElement('div');
      div.className = 'soldItem' + (pinned.has(r.standId) ? ' active' : '');
      div.dataset.standId = r.standId;
      div.innerHTML = `<div class="soldName">${escapeHtml(r.company)}</div><div class="soldMeta">Stand ${escapeHtml(r.standId)}</div>`;
      div.addEventListener('click', () => {
        togglePin(r.standId);
      });
      soldListEl.appendChild(div);
    });

    if (!filtered.length){
      soldListEl.innerHTML = '<div style="padding:12px;color:#666;">No sold companies yet.</div>';
    }
  }

  async function syncOnce(){
    try{
      const data = await fetchJson(API_BASE + '/stands?ts=' + Date.now());
      byId = new Map((Array.isArray(data)?data:[]).map(r => [String(r.standId).trim(), {
        standId:String(r.standId).trim(),
        status:normalizeStatus(r.status),
        company:String(r.company||'').trim()
      }]));

      renderPlan();
      renderSoldList();

      renderPins();

      setStatus('Synced: ' + new Date().toLocaleTimeString());
    }catch(e){
      setStatus('Sync error: ' + e.message, true);
      console.error(e);
    }
  }

  (async () => {
    try{
      setStatus('Loading…');
      await loadSvg();
      ensureCalloutLayer();
      getStandNodes().forEach(bindNodeEvents);

      soldSearchEl.addEventListener('input', renderSoldList);
      btnClearPins?.addEventListener('click', () => { clearPins(); renderSoldList(); });
      btnExportPdf?.addEventListener('click', () => { window.print(); });

      await syncOnce();
      setInterval(syncOnce, SYNC_INTERVAL_MS);
    }catch(e){
      setStatus('Load error: ' + e.message, true);
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
