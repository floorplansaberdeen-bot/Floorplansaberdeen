<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Exhibition Floorplan</title>
<style>
  :root{
    --bg:#ffffff;
    --ink:#111;
    --muted:#6b6b6b;
    --border:#e6e6e6;

    /* Requested "green" replacement */
    --stands: rgba(213,109,50,0.75);
    --stands-solid: rgb(213,109,50);

    --selected:#e53935;

    --card:#fff;
    --shadow: 0 10px 28px rgba(0,0,0,.12);
    --shadow-soft: 0 6px 18px rgba(0,0,0,.10);

    --radius: 14px;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}

  /* Header */
  header{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--border);
    padding:12px 14px;
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  }
  .hLeft{display:flex; flex-direction:column; gap:4px;}
  #eventName{font-weight:900;font-size:26px;line-height:1.05}
  #updated{font-size:12px;color:var(--muted)}
  #status{font-size:13px;color:#0f7a33;font-weight:700}
  .hRight{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
  .btn{
    appearance:none;border:1px solid var(--border);background:#fafafa;border-radius:10px;
    padding:8px 12px;font-weight:800;font-size:13px;cursor:pointer;
  }
  .btn:disabled{opacity:.55;cursor:not-allowed}

  /* Layout */
  .wrap{max-width:1400px;margin:0 auto;padding:12px;display:grid;gap:12px;grid-template-columns: 1fr 360px;}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr;} }

  /* On phone: keep plan pinned at top, list scrolls */
  @media (max-width: 760px){
    .wrap{padding:10px;gap:10px;}
    .stickyPlan{
      position:sticky; top:78px; z-index:30;
      background:transparent;
    }
  }

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
  .cardPad{padding:12px}

  /* Plan */
  #planCard{min-height:440px}
  #svgHost{position:relative; overflow:hidden;}
  #svgHost svg{width:100%;height:auto;display:block}
  svg text, svg tspan{pointer-events:none; user-select:none;}

  /* Keep the lozenge visible (raise it) */
  .legendPill{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:16px; /* higher so it won't clip */
    display:inline-flex; align-items:center; gap:16px;
    padding:10px 14px;border:1px solid var(--border);border-radius:999px;background:#fff;
    box-shadow: var(--shadow-soft);
    font-size:13px;font-weight:800;
    pointer-events:none;
  }
  .dot{width:12px;height:12px;border-radius:50%;}
  .dot.base{background:var(--stands-solid)}
  .dot.sel{background:var(--selected)}

  /* Right panel */
  .side{display:grid;gap:12px}
  .side h3{margin:0;font-size:13px;color:#222}
  .big{font-size:26px;font-weight:950;line-height:1}
  .subbig{font-size:20px;font-weight:850;margin-top:3px}
  .help{font-size:12px;color:var(--muted);line-height:1.35}

  /* List */
  .search{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px;outline:none}
  #list{
    max-height:520px; overflow:auto;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    /* bottom padding so last row is selectable above browser bar */
    padding-bottom: calc(14px + env(safe-area-inset-bottom));
  }
  .row{
    padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;
    display:flex;flex-direction:column;gap:2px;
  }
  .row:last-child{border-bottom:0}
  .row:hover{background:#fafafa}
  .row .name{font-weight:900;font-size:14px}
  .row .meta{font-size:12px;color:var(--muted)}
  .row.selected{outline:2px solid rgba(0,0,0,.06); background:#fff7f7}

  /* Label overlay */
  #overlay{
    position:absolute; inset:0; pointer-events:none;
  }
  .tag{
    position:absolute;
    min-width:220px;
    max-width: 360px;
    background:var(--selected);
    color:#fff;
    border-radius:14px;
    padding:14px 16px;
    box-shadow: var(--shadow);
    text-align:center;
  }
  .tag .stand{font-weight:950;font-size:40px;letter-spacing:.5px;line-height:1}
  .tag .company{font-weight:850;font-size:20px;margin-top:8px;line-height:1.15}
  /* smaller on phone */
  @media (max-width: 760px){
    .tag{min-width:180px;max-width:320px;padding:12px 14px;border-radius:14px}
    .tag .stand{font-size:34px}
    .tag .company{font-size:18px}
  }

  /* Connection line (SVG in overlay) */
  #overlaySvg{position:absolute; inset:0; width:100%; height:100%;}
  .line{stroke:rgba(0,0,0,.72); stroke-width:3; fill:none}
  .pin{fill:rgba(0,0,0,.72)}
  /* smaller + tasteful */
  .pin{r:6}

  /* Remove big blank space under plan on phone by letting SVG card shrink */
  @media (max-width: 760px){
    #planCard{min-height:auto}
  }
</style>
</head>
<body>
<header>
  <div class="hLeft">
    <div id="eventName">Loading…</div>
    <div id="updated"></div>
    <div id="status"></div>
  </div>
  <div class="hRight">
    <button id="btnPdf" class="btn">Export PDF</button>
    <button id="btnClear" class="btn">Clear selection</button>
  </div>
</header>

<div class="wrap">
  <div class="card stickyPlan" id="planCard">
    <div id="svgHost">
      <div id="overlay">
        <svg id="overlaySvg" viewBox="0 0 100 100" preserveAspectRatio="none">
          <path id="connLine" class="line" d="" />
          <circle id="connDot" class="pin" cx="0" cy="0" r="6"></circle>
        </svg>
        <div id="tag" class="tag" style="display:none">
          <div class="stand" id="tagStand"></div>
          <div class="company" id="tagCompany"></div>
        </div>
      </div>

      <div class="legendPill">
        <span style="display:inline-flex;align-items:center;gap:8px"><span class="dot base"></span> Stands</span>
        <span style="display:inline-flex;align-items:center;gap:8px"><span class="dot sel"></span> Selected</span>
      </div>
    </div>
  </div>

  <div class="side">
    <div class="card">
      <div class="cardPad">
        <h3>Selected exhibitor</h3>
        <div class="big" id="selStand">None</div>
        <div class="subbig" id="selCompany"></div>
        <div class="help" style="margin-top:10px">
          Desktop: click a stand or choose from the list.<br/>
          Phone: use the list (stand tapping is disabled).
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardPad" style="display:grid;gap:10px">
        <h3>Sold exhibitors</h3>
        <input id="q" class="search" placeholder="Search company or stand…" />
        <div id="list"></div>
      </div>
    </div>

    <div class="card">
      <div class="cardPad">
        <h3>Help</h3>
        <div class="help">Selecting an exhibitor makes their stand red with a label + line.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // Safari / old CSS.escape support
  if (!window.CSS) window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (value) {
      return String(value).replace(/[^a-zA-Z0-9_\\-]/g, function (ch) {
        const hex = ch.codePointAt(0).toString(16).toUpperCase();
        return '\\\\' + hex + ' ';
      });
    };
  }

  const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
  const SVG_URL = './event_plan.svg';

  const STANDS_FILL = 'rgba(213, 109, 50, 0.75)';
  const STANDS_STROKE = 'rgba(0,0,0,0.55)';
  const SELECTED_FILL = '#e53935';

  const isPhone = matchMedia('(max-width: 760px)').matches;

  const elEvent = document.getElementById('eventName');
  const elUpdated = document.getElementById('updated');
  const elStatus = document.getElementById('status');

  const svgHost = document.getElementById('svgHost');
  const overlay = document.getElementById('overlay');
  const overlaySvg = document.getElementById('overlaySvg');
  const connLine = document.getElementById('connLine');
  const connDot = document.getElementById('connDot');

  const tag = document.getElementById('tag');
  const tagStand = document.getElementById('tagStand');
  const tagCompany = document.getElementById('tagCompany');

  const selStand = document.getElementById('selStand');
  const selCompany = document.getElementById('selCompany');

  const q = document.getElementById('q');
  const list = document.getElementById('list');

  const btnPdf = document.getElementById('btnPdf');
  const btnClear = document.getElementById('btnClear');

  let svgRoot = null;
  let stands = [];
  let byId = new Map();
  let selectedId = '';
  let selectedCompany = '';

  function setStatus(text, ok=true){
    elStatus.textContent = text;
    elStatus.style.color = ok ? '#0f7a33' : '#b00020';
  }

  async function fetchJson(url){
    const res = await fetch(url,{cache:'no-store'});
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }catch(e){ throw new Error('Bad JSON from API'); }
    if(!res.ok) throw new Error('HTTP '+res.status);
    return data;
  }

  async function loadSettings(){
    try{
      const s = await fetchJson(API_BASE + '/settings?ts=' + Date.now());
      elEvent.textContent = (s && s.eventName) ? s.eventName : 'New Event';
    }catch{
      elEvent.textContent = 'New Event';
    }
  }

  async function loadStands(){
    const data = await fetchJson(API_BASE + '/stands?ts=' + Date.now());
    stands = Array.isArray(data) ? data : [];
    byId = new Map(stands.map(r => [String(r.standId||'').trim(), {
      standId: String(r.standId||'').trim(),
      status: String(r.status||'available').toLowerCase().trim() === 'sold' ? 'sold' : 'available',
      company: String(r.company||'').trim()
    }]));
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL,{cache:'no-store'});
    if(!res.ok) throw new Error('SVG not found');
    svgHost.insertAdjacentHTML('afterbegin', await res.text());
    svgRoot = svgHost.querySelector('svg');
    if(!svgRoot) throw new Error('SVG root not found');
    // Put overlay on top
    svgHost.appendChild(overlay);

    // Disable SVG interaction on phone (prevents iOS freezes)
    if (isPhone){
      svgRoot.style.pointerEvents = 'none';
    }
  }

  function isStandId(id){
    return /^[A-Z]{1,3}\d{1,3}$/i.test(String(id||'').trim());
  }

  function getStandNodes(){
    if(!svgRoot) return [];
    const groups = Array.from(svgRoot.querySelectorAll('g[id]')).filter(g=>isStandId(g.id));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]'))
      .filter(el=>isStandId(el.id));
    return groups.length ? groups : shapes;
  }

  function paintStand(node, isSelected){
    const targets = (node.tagName.toLowerCase()==='g')
      ? node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line')
      : [node];

    targets.forEach(el=>{
      el.style.fill = isSelected ? SELECTED_FILL : STANDS_FILL;
      el.style.fillOpacity = '1';
      el.style.stroke = STANDS_STROKE;
      el.style.strokeWidth = '1.2';
      el.style.cursor = isPhone ? 'default' : 'pointer';
    });
  }

  function renderPlan(){
    const nodes = getStandNodes();
    nodes.forEach(node=>{
      const id = String(node.id||'').trim();
      paintStand(node, id === selectedId);
      if(!isPhone){
        node.style.pointerEvents = 'auto';
        node.addEventListener('click', (e)=>{
          e.preventDefault();
          e.stopPropagation();
          select(id);
        }, {passive:false});
      }
    });
  }

  function soldItems(){
    return Array.from(byId.values())
      .filter(r=>r.status==='sold')
      .map(r=>({standId:r.standId, company:r.company || '(No company)'}))
      .sort((a,b)=>a.company.localeCompare(b.company));
  }

  function renderList(){
    const query = String(q.value||'').toLowerCase().trim();
    const items = soldItems().filter(it=>{
      if(!query) return true;
      return it.company.toLowerCase().includes(query) || it.standId.toLowerCase().includes(query);
    });

    list.innerHTML = '';
    items.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'row' + (it.standId===selectedId ? ' selected' : '');
      div.innerHTML = `<div class="name">${escapeHtml(it.company)}</div><div class="meta">Stand ${escapeHtml(it.standId)}</div>`;
      div.addEventListener('click', ()=>select(it.standId));
      list.appendChild(div);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function getStandBBoxOnScreen(standId){
    const node = svgRoot.querySelector('#' + CSS.escape(standId));
    if(!node) return null;
    let target = node;
    // If group, get bbox of group
    try{
      const bb = target.getBBox();
      const pt = svgRoot.createSVGPoint();
      const ctm = target.getCTM();
      if(!ctm) return null;

      // Corners -> screen
      const corners = [
        [bb.x, bb.y],
        [bb.x+bb.width, bb.y],
        [bb.x+bb.width, bb.y+bb.height],
        [bb.x, bb.y+bb.height]
      ].map(([x,y])=>{
        pt.x=x; pt.y=y;
        const sp = pt.matrixTransform(ctm).matrixTransform(svgRoot.getScreenCTM());
        return {x:sp.x,y:sp.y};
      });

      const xs = corners.map(p=>p.x), ys=corners.map(p=>p.y);
      const minX=Math.min(...xs), maxX=Math.max(...xs);
      const minY=Math.min(...ys), maxY=Math.max(...ys);
      return {left:minX, top:minY, right:maxX, bottom:maxY, width:maxX-minX, height:maxY-minY, cx:(minX+maxX)/2, cy:(minY+maxY)/2};
    }catch{
      return null;
    }
  }

  // Smart placement: choose a position for tag that stays within svgHost
  // and tries to avoid covering the stand bbox by preferring outside areas.
  function placeTag(standId){
    if(!selectedId){
      tag.style.display = 'none';
      connLine.setAttribute('d','');
      connDot.setAttribute('cx',0); connDot.setAttribute('cy',0);
      return;
    }

    const hostRect = svgHost.getBoundingClientRect();
    const stand = getStandBBoxOnScreen(standId);
    if(!stand) return;

    tag.style.display = 'block';

    // Size tag after it becomes visible
    const tagRect = tag.getBoundingClientRect();

    const padding = 14;
    const dotRadius = isPhone ? 5 : 6;

    // Candidate anchors relative to host: try bottom-left, bottom-center, bottom-right, top-left, top-right
    const candidates = [
      {name:'bottom-center', x: stand.cx - tagRect.width/2, y: stand.bottom + 28},
      {name:'bottom-left',   x: stand.left - tagRect.width - 28, y: stand.cy - tagRect.height/2},
      {name:'bottom-right',  x: stand.right + 28, y: stand.cy - tagRect.height/2},
      {name:'top-center',    x: stand.cx - tagRect.width/2, y: stand.top - tagRect.height - 28},
      {name:'top-left',      x: stand.left - tagRect.width - 28, y: stand.top - tagRect.height - 18},
      {name:'top-right',     x: stand.right + 28, y: stand.top - tagRect.height - 18},
    ];

    // Host bounds in screen coords
    const H = {l:hostRect.left+padding, r:hostRect.right-padding, t:hostRect.top+padding, b:hostRect.bottom-padding};

    function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

    function score(pos){
      // clamp into host
      const x = clamp(pos.x, H.l, H.r - tagRect.width);
      const y = clamp(pos.y, H.t, H.b - tagRect.height);

      // intersection with stand bbox (penalize)
      const inter =
        Math.max(0, Math.min(x+tagRect.width, stand.right) - Math.max(x, stand.left)) *
        Math.max(0, Math.min(y+tagRect.height, stand.bottom) - Math.max(y, stand.top));

      // prefer lower positions a bit (so label tends down)
      const downBias = (y - H.t) / (H.b - H.t);

      // distance (prefer farther so line longer)
      const cx = x + tagRect.width/2;
      const cy = y + tagRect.height/2;
      const dist = Math.hypot(cx-stand.cx, cy-stand.cy);

      return {
        x,y,
        val: (inter>0 ? 1e9 : 0) + (1 - downBias)*120 + (-dist) // larger dist -> lower score (better)
      };
    }

    let best = null;
    candidates.forEach(c=>{
      const s = score(c);
      if(!best || s.val < best.val) best = s;
    });

    // Apply position (convert to host-local coords)
    const localX = best.x - hostRect.left;
    const localY = best.y - hostRect.top;
    tag.style.left = localX + 'px';
    tag.style.top  = localY + 'px';

    // Draw connector line in overlay SVG using host-local coords
    const standLocal = {
      x: stand.cx - hostRect.left,
      y: stand.cy - hostRect.top
    };
    const tagLocal = {
      x: localX + tagRect.width/2,
      y: localY + tagRect.height/2
    };

    // Set overlaySvg viewBox to match pixels so line coords are easy
    overlaySvg.setAttribute('viewBox', `0 0 ${hostRect.width} ${hostRect.height}`);

    connLine.setAttribute('d', `M ${standLocal.x} ${standLocal.y} L ${tagLocal.x} ${tagLocal.y}`);
    connDot.setAttribute('cx', standLocal.x);
    connDot.setAttribute('cy', standLocal.y);
    connDot.setAttribute('r', dotRadius);
  }

  function select(standId){
    const info = byId.get(standId);
    if(!info) return;

    selectedId = standId;
    selectedCompany = info.company || '(No company)';

    // Update card
    selStand.textContent = selectedId;
    selCompany.textContent = info.company ? info.company : '';

    // Tag
    tagStand.textContent = selectedId;
    tagCompany.textContent = info.company ? info.company : '';
    renderPlan();
    renderList();
    placeTag(selectedId);
  }

  function clearSelection(){
    selectedId = '';
    selectedCompany = '';
    selStand.textContent = 'None';
    selCompany.textContent = '';
    tag.style.display = 'none';
    connLine.setAttribute('d','');
    renderPlan();
    renderList();
  }

  async function exportPdf(){
    // Lightweight export: open print dialog of current view.
    // If you previously used html2canvas/jsPDF, it can be re-added, but this is dependable.
    window.print();
  }

  async function sync(){
    try{
      await loadSettings();
      await loadStands();
      renderPlan();
      renderList();
      elUpdated.textContent = 'Updated: ' + new Date().toLocaleTimeString();
      setStatus('Ready ✅', true);

      // keep selection in sync if still sold
      if(selectedId){
        const info = byId.get(selectedId);
        if(info && info.status==='sold'){
          select(selectedId);
        }else{
          clearSelection();
        }
      }
    }catch(err){
      setStatus('Load error: ' + err.message, false);
      console.error(err);
    }
  }

  function onResize(){
    if(selectedId) placeTag(selectedId);
  }

  btnClear.addEventListener('click', clearSelection);
  btnPdf.addEventListener('click', exportPdf);
  q.addEventListener('input', renderList);
  window.addEventListener('resize', onResize);

  (async ()=>{
    try{
      await loadSvg();
      await sync();
      setInterval(sync, 12000);
    }catch(err){
      setStatus('Load error: ' + err.message, false);
      console.error(err);
    }
  })();
})();
</script>
</body>
</html>
