<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Exhibition Floorplan</title>
  <style>
    body { margin: 0; font-family: sans-serif; }
    svg { width: 100%; height: auto; }
    .stand-available { fill: #4CAF50 !important; }
    .stand-sold { fill: #E53935 !important; }
  </style>
</head>
<body>

<div id="svg-container"></div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbxEq83BUYJ-oewP_2lPFL0tyol4veM2mhukSTTMCaKCZgEJS5m-f8Jqy1EO_bDc3q3a/exec";

let svgRoot = null;
let svgReady = false;
let pendingSheetData = null;

/* =========================
   SVG LOAD
   ========================= */
fetch("event_plan.svg")
  .then(r => r.text())
  .then(svg => {
    document.getElementById("svg-container").innerHTML = svg;
    svgRoot = document.querySelector("svg");
    svgReady = true;
    if (pendingSheetData) applyData(pendingSheetData);
  });

/* =========================
   JSONP LOAD
   ========================= */
function loadDataFromSheet() {
  return new Promise(resolve => {
    const cb = "cb_" + Date.now();
    window[cb] = data => {
      delete window[cb];
      script.remove();
      resolve(data);
    };

    const script = document.createElement("script");
    script.src = `${SCRIPT_URL}?callback=${cb}`;
    document.body.appendChild(script);
  });
}

async function refresh() {
  const data = await loadDataFromSheet();
  if (!svgReady) {
    pendingSheetData = data;
  } else {
    applyData(data);
  }
}

/* =========================
   APPLY COLOURS
   ========================= */
function applyData(data) {
  if (!svgRoot || !Array.isArray(data)) return;

  data.forEach(row => {
    const stand = findStand(row.standId);
    if (!stand) return;

    stand.classList.remove("stand-available", "stand-sold");
    stand.classList.add(
      row.status === "sold" ? "stand-sold" : "stand-available"
    );

    stand.onmouseenter = () => {
      stand.title = row.status === "sold"
        ? row.company
        : "Available";
    };
  });
}

/* =========================
   STAND RESOLVER
   ========================= */
function findStand(id) {
  return [...svgRoot.querySelectorAll("[id],[data-name]")]
    .find(el =>
      el.getAttribute("data-name") === id ||
      el.id === id
    );
}

/* =========================
   POLL
   ========================= */
refresh();
setInterval(refresh, 30000);
</script>

</body>
</html>
