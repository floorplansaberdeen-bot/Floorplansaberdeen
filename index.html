<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{
    --border:#e6e6e6;
    --muted:#666;
    --card:#fff;
    --shadow: 0 10px 25px rgba(0,0,0,.10);
    --shadow2: 0 14px 28px rgba(0,0,0,.18);
    --selected:#e53935;
    --standRGB: 213,109,50;
  }

  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}

  header{
    padding:14px 16px;border-bottom:1px solid var(--border);
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
    background:#fff; position:sticky; top:0; z-index:30;
  }
  .titleWrap{display:grid;gap:4px}
  #eventName{font-size:26px;font-weight:900;line-height:1;}
  #updated{font-size:13px;color:var(--muted);}
  #status{font-size:14px;color:#0a7a2a;font-weight:700;}

  .topBtns{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{
    border:1px solid var(--border);background:#f8f8f8;border-radius:10px;
    padding:10px 14px;font-weight:800;cursor:pointer;font-size:14px;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .btn.primary{background:#fff;}

  /* Layout: on desktop we keep two columns, plan column is sticky */
  .layout{
    display:grid;grid-template-columns:2.3fr 1fr;gap:14px;
    padding:14px;
    align-items:start;
  }
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr;}
  }

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;}

  /* Sticky plan column (desktop) */
  .planCol{
    position:sticky;
    top:92px; /* header height-ish */
    align-self:start;
    z-index:10;
  }
  @media (max-width: 980px){
    .planCol{ position:relative; top:auto; }
  }

  .planCard{position:relative;overflow:hidden;}
  #svgHost{
    overflow:auto;
    padding:12px;
    max-height: min(72vh, 760px); /* prevent tall whitespace + keep it viewable */
  }
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none;user-select:none;}

  /* Legend lozenges - moved up */
  .legend{
    position:absolute;left:50%;transform:translateX(-50%);
    bottom:10px; /* higher than before */
    background:#fff;border:1px solid var(--border);border-radius:999px;
    padding:9px 12px;display:flex;gap:16px;align-items:center;
    box-shadow: var(--shadow);
    font-weight:800;
  }
  .dot{width:12px;height:12px;border-radius:50%;}
  .dot.stand{background:rgba(var(--standRGB),.75);}
  .dot.sel{background:var(--selected);}

  /* NEW: Callout bar OUTSIDE the SVG, below the plan, no covering */
  .calloutBar{
    border-top:1px solid var(--border);
    background:#fff;
    padding:10px 12px;
    display:none;
  }
  .calloutInner{
    margin:0 auto;
    max-width:540px;
    background:var(--selected);
    color:#fff;
    border-radius:16px;
    padding:10px 12px;
    box-shadow: var(--shadow2);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .calloutLeft{
    display:grid;gap:2px;
  }
  .calloutStand{
    font-weight:900;
    font-size:22px;
    line-height:1;
  }
  .calloutCompany{
    font-weight:800;
    font-size:15px;
    line-height:1.2;
    opacity:.98;
  }
  .calloutBtn{
    border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.16);
    color:#fff;
    border-radius:12px;
    padding:8px 10px;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }

  /* Right column panels */
  .side{display:grid;gap:12px;}
  .panelTitle{font-weight:900;margin:0 0 6px 0;}
  .selBox{
    border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;
  }
  #selStand{font-size:20px;font-weight:900;line-height:1.1;}
  #selCompany{font-size:18px;font-weight:800;margin-top:4px;}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}

  .listBox{border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden;}
  .listHead{padding:12px;border-bottom:1px solid var(--border);}
  #search{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;}
  #list{max-height:520px;overflow:auto;}
  .row{
    padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;
    display:grid;gap:2px;
  }
  .row:hover{background:#fafafa;}
  .row strong{font-size:14px;}
  .row small{color:var(--muted);font-weight:700;}
  .row.active{outline:2px solid rgba(0,0,0,.12);background:#fff;}

  /* Phone: make plan fixed area feel “at top”, list scrolls below */
  @media (max-width: 600px){
    #eventName{font-size:22px;}
    #svgHost{max-height: 54vh; padding:10px;}
    .legend{bottom:12px;}
    .calloutStand{font-size:18px;}
    .calloutCompany{font-size:13px;}
  }
</style>
</head>
<body>

<header>
  <div class="titleWrap">
    <div id="eventName">Loading…</div>
    <div id="updated">Updated: —</div>
    <div id="status">Loading…</div>
  </div>

  <div class="topBtns">
    <button class="btn primary" id="btnPdf">Export PDF</button>
    <button class="btn" id="btnClear">Clear selection</button>
  </div>
</header>

<div class="layout">
  <!-- Sticky Plan Column -->
  <div class="planCol">
    <div class="card planCard">
      <div id="svgHost"></div>

      <div class="legend" aria-hidden="true">
        <span style="display:flex;align-items:center;gap:8px;"><span class="dot stand"></span>Stands</span>
        <span style="display:flex;align-items:center;gap:8px;"><span class="dot sel"></span>Selected</span>
      </div>

      <!-- Callout lives OUTSIDE svg so it never covers stands -->
      <div class="calloutBar" id="calloutBar">
        <div class="calloutInner">
          <div class="calloutLeft">
            <div class="calloutStand" id="calloutStand">—</div>
            <div class="calloutCompany" id="calloutCompany"></div>
          </div>
          <button class="calloutBtn" id="btnCenter">Center on stand</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right side -->
  <div class="side">
    <div class="selBox">
      <div class="panelTitle">Selected exhibitor</div>
      <div id="selStand">None</div>
      <div id="selCompany"></div>
      <div class="hint">
        Desktop: click a stand or choose from the list.<br>
        Phone: use the list (stand tapping is disabled).
      </div>
    </div>

    <div class="listBox">
      <div class="listHead">
        <div class="panelTitle">Sold exhibitors</div>
        <input id="search" placeholder="Search company or stand…" />
      </div>
      <div id="list"></div>
    </div>

    <div class="selBox">
      <div class="panelTitle">Help</div>
      <div class="hint">All stands are in the main colour. Selecting an exhibitor makes their stand red.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  const API_BASE = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const SVG_URL  = "./event_plan.svg";

  const STAND_FILL_RGB = "213,109,50";
  const STAND_OPACITY  = 0.75;
  const SELECTED_FILL  = "#e53935";

  const STAND_ID_RE = /^([A-Z]{1,3})(\d{1,3})$/;
  const isPhone = matchMedia("(max-width: 600px)").matches;

  const elEvent  = document.getElementById("eventName");
  const elUpdated= document.getElementById("updated");
  const elStatus = document.getElementById("status");

  const svgHost  = document.getElementById("svgHost");
  const listEl   = document.getElementById("list");
  const searchEl = document.getElementById("search");

  const selStand = document.getElementById("selStand");
  const selCo    = document.getElementById("selCompany");

  const calloutBar = document.getElementById("calloutBar");
  const calloutStand = document.getElementById("calloutStand");
  const calloutCompany = document.getElementById("calloutCompany");
  const btnCenter = document.getElementById("btnCenter");

  const btnClear = document.getElementById("btnClear");
  const btnPdf   = document.getElementById("btnPdf");

  let svgRoot = null;
  let stands = [];
  let byId = new Map();
  let selectedId = "";

  function setStatus(txt, ok=true){
    elStatus.textContent = txt;
    elStatus.style.color = ok ? "#0a7a2a" : "#b00020";
  }

  function normalizeStatus(v){
    const s = String(v||"").toLowerCase().trim();
    return (s === "sold" || s === "booked" || s === "reserved") ? "sold" : "available";
  }

  function isStandId(id){ return STAND_ID_RE.test(String(id||"").trim()); }

  function pick(obj, keys, fallback=""){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
    }
    return fallback;
  }

  function normalizeRow(r){
    const standId = String(pick(r, ["standId","Stand","stand","id","ID","stand_id"], "")).trim();
    const status  = normalizeStatus(pick(r, ["status","Status","state","State"], "available"));
    const company = String(pick(r, ["company","Company","exhibitor","Exhibitor","name","Name","soldTo","SoldTo"], "")).trim();
    return { standId, status, company };
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text();
    const json = JSON.parse(text);
    if(!res.ok) throw new Error("HTTP "+res.status);
    return json;
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("SVG not found: "+SVG_URL+" (HTTP "+res.status+")");
    svgHost.innerHTML = await res.text();
    svgRoot = svgHost.querySelector("svg");
    if(!svgRoot) throw new Error("SVG missing <svg> root");

    // remove any svg text to keep it clean (no stand numbers)
    svgRoot.querySelectorAll("text,tspan").forEach(t=>t.remove());
  }

  function getStandNodes(){
    const shapes = Array.from(svgRoot.querySelectorAll("path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]"))
      .filter(el => isStandId(el.id));
    if (shapes.length) return shapes;
    return Array.from(svgRoot.querySelectorAll("g[id]")).filter(g=>isStandId(g.id));
  }

  function paintStandNode(node, isSelected){
    const targets = (node.tagName.toLowerCase()==="g")
      ? node.querySelectorAll("path,rect,polygon,circle,ellipse,polyline,line")
      : [node];

    const fill = isSelected ? SELECTED_FILL : `rgb(${STAND_FILL_RGB})`;
    const op   = isSelected ? "0.88" : String(STAND_OPACITY);

    targets.forEach(el=>{
      el.style.fill = fill;
      el.style.fillOpacity = op;
      el.style.stroke = "rgba(0,0,0,0.45)";
      el.style.strokeOpacity = "0.6";
      el.style.cursor = isPhone ? "default" : "pointer";
    });
  }

  function repaintAll(){
    if(!svgRoot) return;
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      paintStandNode(node, id === selectedId);
    });
  }

  function standBBox(standId){
    const node = svgRoot.querySelector("#"+CSS.escape(standId));
    if(!node) return null;
    try{ return node.getBBox(); }catch(_){ return null; }
  }

  function centerOnStand(standId){
    if(!standId) return;
    const bb = standBBox(standId);
    if(!bb) return;
    // Scroll inside svgHost to center bbox
    const svgRect = svgRoot.getBoundingClientRect();
    const hostRect = svgHost.getBoundingClientRect();
    const scaleX = svgRect.width / (svgRoot.viewBox.baseVal.width || svgRect.width);
    const scaleY = svgRect.height / (svgRoot.viewBox.baseVal.height || svgRect.height);

    const cx = (bb.x + bb.width/2) * scaleX;
    const cy = (bb.y + bb.height/2) * scaleY;

    const targetLeft = Math.max(0, cx - hostRect.width/2);
    const targetTop  = Math.max(0, cy - hostRect.height/2);

    svgHost.scrollTo({ left: targetLeft, top: targetTop, behavior: "smooth" });
  }

  function setSelected(standId){
    selectedId = standId || "";

    if(!selectedId){
      selStand.textContent = "None";
      selCo.textContent = "";
      calloutBar.style.display = "none";
      repaintAll();
      renderList();
      return;
    }

    const info = byId.get(selectedId) || { standId:selectedId, company:"" };
    selStand.textContent = info.standId;
    selCo.textContent = (info.company || "").trim();

    calloutStand.textContent = info.standId;
    calloutCompany.textContent = (info.company || "").trim();
    calloutBar.style.display = "block";

    repaintAll();
    renderList();
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function renderList(){
    const q = String(searchEl.value||"").toLowerCase().trim();

    const sold = stands
      .filter(s => normalizeStatus(s.status)==="sold")
      .map(s => ({ standId: s.standId, company: s.company }))
      .sort((a,b) => (a.company||a.standId).localeCompare((b.company||b.standId)));

    const filtered = !q ? sold : sold.filter(x =>
      (x.company||"").toLowerCase().includes(q) || x.standId.toLowerCase().includes(q)
    );

    listEl.innerHTML = "";
    filtered.forEach(item=>{
      const row = document.createElement("div");
      row.className = "row" + (item.standId===selectedId ? " active":"");
      const title = item.company ? escapeHtml(item.company) : `<em style="font-weight:900;">(No company)</em>`;
      row.innerHTML = `<strong>${title}</strong><small>Stand ${escapeHtml(item.standId)}</small>`;
      row.addEventListener("click", ()=>{
        setSelected(item.standId);
        // Keep plan visible and center stand when chosen from list
        centerOnStand(item.standId);
      });
      listEl.appendChild(row);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.padding = "12px";
      empty.style.color = "#777";
      empty.textContent = "No sold stands found.";
      listEl.appendChild(empty);
    }
  }

  async function sync(){
    try{
      const settings = await fetchJson(API_BASE + "/settings?ts=" + Date.now());
      elEvent.textContent = (settings && settings.eventName) ? settings.eventName : "New Event";
    }catch(_){
      elEvent.textContent = "New Event";
    }

    const raw = await fetchJson(API_BASE + "/stands?ts=" + Date.now());
    const arr = Array.isArray(raw) ? raw : [];
    stands = arr.map(normalizeRow).filter(r => r.standId);

    byId = new Map(stands.map(s => [s.standId, s]));
    elUpdated.textContent = "Updated: " + new Date().toLocaleTimeString();

    renderList();

    if(selectedId && !byId.has(selectedId)) selectedId = "";
    repaintAll();
  }

  function bindStandClick(){
    if(isPhone) return;
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      node.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        setSelected(id);
        centerOnStand(id);
      });
    });
  }

  async function exportPdf(){
    try{
      btnPdf.disabled = true;
      setStatus("Preparing PDF…", true);

      const svg = svgRoot.cloneNode(true);
      svg.removeAttribute("width");
      svg.removeAttribute("height");

      const svgText = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([svgText], { type:"image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const img = new Image();
      img.crossOrigin = "anonymous";
      await new Promise((resolve,reject)=>{
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });

      const canvas = document.createElement("canvas");
      const w = img.width || 1600;
      const h = img.height || 900;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: w >= h ? "landscape" : "portrait",
        unit: "pt",
        format: [w, h]
      });

      const dataUrl = canvas.toDataURL("image/png");
      pdf.addImage(dataUrl, "PNG", 0, 0, w, h);
      pdf.save((elEvent.textContent || "floorplan") + ".pdf");

      setStatus("Ready ✅", true);
    }catch(e){
      console.error(e);
      setStatus("PDF export failed", false);
    }finally{
      btnPdf.disabled = false;
    }
  }

  (async ()=>{
    try{
      setStatus("Loading…", true);
      await loadSvg();
      await sync();
      bindStandClick();
      setSelected("");
      repaintAll();
      setStatus("Ready ✅", true);
      setInterval(()=>sync().catch(()=>{}), 15000);
    }catch(e){
      console.error(e);
      setStatus("Load error", false);
      elEvent.textContent = "New Event";
    }
  })();

  searchEl.addEventListener("input", renderList);
  btnClear.addEventListener("click", ()=>setSelected(""));
  btnPdf.addEventListener("click", exportPdf);
  btnCenter.addEventListener("click", ()=>centerOnStand(selectedId));

})();
</script>
</body>
</html>
