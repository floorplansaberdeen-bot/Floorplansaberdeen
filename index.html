<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{--border:#d9d9d9;--bg:#f6f7f9;--card:#fff;--text:#111;--muted:#666;--sold:#e74c3c;--avail:#2ecc71}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:18px 18px 10px;font-weight:900;font-size:18px}
  .wrap{max-width:1200px;margin:0 auto;padding:0 12px 20px}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1.6fr 1fr;align-items:start}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid var(--border);border-radius:999px;padding:7px 10px;background:#fff;cursor:pointer;font-weight:800;font-size:13px}
  .pill:hover{background:#f3f3f3}
  .pill.active{background:#111;color:#fff;border-color:#111}
  .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:13px;color:var(--muted)}
  .swatch{width:14px;height:14px;border-radius:3px;border:1px solid var(--border)}
  .status{font-size:13px;color:var(--muted)}
  #svgHost{width:100%;height: min(72vh, 720px);overflow:hidden;border-radius:12px;border:1px solid var(--border);background:#fff}
  #svgHost svg{width:100%;height:100%}
  #tooltip{position:fixed;z-index:50;display:none;pointer-events:none;background:#111;color:#fff;padding:8px 10px;border-radius:10px;font-size:13px;max-width:260px;box-shadow:0 8px 22px rgba(0,0,0,.18)}
  .soldHeader{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .soldBox{max-height: 420px;overflow:auto;border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
  .soldItem{display:flex;justify-content:space-between;gap:10px;padding:8px 6px;border-radius:10px;cursor:pointer}
  .soldItem:hover{background:#f5f5f7}
  .soldLeft{display:flex;flex-direction:column;gap:2px}
  .soldName{font-weight:900}
  .soldMeta{font-size:12px;color:var(--muted)}
  .soldStand{font-weight:900;font-size:12px;color:#111;border:1px solid var(--border);border-radius:999px;padding:5px 9px;background:#fff;height:fit-content}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer}
  .btn:hover{background:#f3f3f3}
  .btnPrimary{background:#111;color:#fff;border-color:#111}
  .btnPrimary:hover{background:#000}
  input[type="text"]{border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-weight:700}
  small{color:var(--muted)}
  /* Overlay support */
  #svgWrap{width:100%;height:100%;}
  #svgHost{width:100%;height:100%;}
  #iosOverlay{cursor:pointer; touch-action: manipulation;}
</style>
</head>

<body>
<header>Exhibition Floorplan</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="legend">
          <span class="swatch" style="background:rgba(46,204,113,.75)"></span> Available
          <span class="swatch" style="background:rgba(231,76,60,.75)"></span> Sold
          <span class="swatch" style="background:#fff"></span> Unlisted
        </div>
        <div class="row">
          <button class="btn" id="clearPinsBtn">Clear pins</button>
          <button class="btn btnPrimary" id="pdfBtn">Export PDF</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="status" id="status">Loading…</div>
        <div style="flex:1"></div>
        <small id="printSummary"></small>
      </div>

      <div id="svgWrap" style="position:relative;width:100%;height:100%;">
        <div id="iosOverlay" style="display:none;position:absolute;inset:0;z-index:5;"></div>
        <div id="svgHost"></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="pill active" id="filterAll">All</button>
        <button class="pill" id="filterAvail">Available</button>
        <button class="pill" id="filterSold">Sold</button>
        <span style="flex:1"></span>
        <input type="text" id="eventName" placeholder="Event name (for PDF filename)" style="min-width:240px;">
      </div>

      <div class="row" style="margin-top:8px;">
        <label class="row" style="gap:8px;font-size:13px;color:var(--muted);">
          <input type="checkbox" id="printPins" checked> Include pins in PDF
        </label>
        <label class="row" style="gap:8px;font-size:13px;color:var(--muted);">
          <input type="checkbox" id="printLegend" checked> Print map legend
        </label>
        <label class="row" style="gap:8px;font-size:13px;color:var(--muted);">
          <input type="checkbox" id="printSoldList"> Print exhibitor list
        </label>
      </div>
    </div>

    <div class="card">
      <div class="soldHeader">
        <div style="font-weight:900;">Sold exhibitors</div>
        <small id="soldCount">0</small>
      </div>
      <div class="soldBox" id="soldList"></div>
    </div>
  </div>
</div>

<div id="tooltip"></div>

<script>
(() => {
  // Safari compatibility: CSS.escape polyfill
  if (!window.CSS) window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (value) {
      return String(value).replace(/[^a-zA-Z0-9_\-]/g, function (ch) {
        const hex = ch.codePointAt(0).toString(16).toUpperCase();
        return '\\' + hex + ' ';
      });
    };
  }

  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  const isIOSSafari = isIOS && isSafari;

  const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
  const SYNC_INTERVAL_MS = 25000;

  const svgHost = document.getElementById('svgHost');
  const tooltip = document.getElementById('tooltip');
  const statusEl = document.getElementById('status');

  const filterAll = document.getElementById('filterAll');
  const filterAvail = document.getElementById('filterAvail');
  const filterSold = document.getElementById('filterSold');

  const soldList = document.getElementById('soldList');
  const soldCount = document.getElementById('soldCount');

  const clearPinsBtn = document.getElementById('clearPinsBtn');
  const pdfBtn = document.getElementById('pdfBtn');

  const eventNameInput = document.getElementById('eventName');
  const printPins = document.getElementById('printPins');
  const printLegend = document.getElementById('printLegend');
  const printSoldList = document.getElementById('printSoldList');
  const printSummary = document.getElementById('printSummary');

  let svgRoot = null;
  let byId = new Map();
  let pinned = new Set();
  let bboxCache = new Map();
  let pinsRaf = 0;
  let tipRaf = 0;
  let isPointerDown = false;
  let hoverDisabledUntil = 0;

  function setStatus(msg, isError=false){
    statusEl.textContent = msg;
    statusEl.style.color = isError ? '#b00020' : 'var(--muted)';
  }

  function tooltipText(info){
    const stand = info.standId || '';
    const status = (info.status === 'sold') ? 'sold' : 'available';
    const company = info.company ? info.company.trim() : '';
    let lines = [stand, status];
    if (status === 'sold' && company) lines.push(company);
    return lines.join(' • ');
  }

  function svgEl(name, attrs={}){
    const el = document.createElementNS('http://www.w3.org/2000/svg', name);
    Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k, v));
    return el;
  }

  function normalizeStatus(value){
    const v = String(value||'').toLowerCase().trim();
    return (v === 'sold') ? 'sold' : 'available';
  }

  function isStandId(id){
    if(!id) return false;
    if(id === 'legend' || id === 'pinsLayer' || id === 'calloutLayer') return false;
    // stands look like A1, AA1, SB12 etc
    return /^[A-Z]{1,3}\d{1,3}$/i.test(id);
  }

  function scheduleTooltipUpdate(){
    if (tipRaf) return;
    tipRaf = requestAnimationFrame(() => {
      tipRaf = 0;
    });
  }

  function scheduleRenderPins(){
    if (pinsRaf) return;
    pinsRaf = requestAnimationFrame(() => {
      pinsRaf = 0;
      renderPins();
    });
  }

  function getStandBox(standId){
    if (bboxCache.has(standId)) return bboxCache.get(standId);
    const node = svgRoot.querySelector('#' + CSS.escape(standId));
    if (!node) return null;
    try{
      const bb = node.getBBox();
      const info = { bb, cx: bb.x + bb.width/2, cy: bb.y + bb.height/2 };
      bboxCache.set(standId, info);
      return info;
    }catch{
      return null;
    }
  }

  // iOS Safari: handle taps via an overlay (avoids SVG click/hit-test stalls)
  let iosBoxes = [];
  function buildIOSHitMap(){
    iosBoxes = [];
    if(!svgRoot) return;
    const nodes = getStandNodes();
    nodes.forEach(n=>{
      const id = n.id;
      if(!id) return;
      const box = getStandBox(id);
      if(!box) return;
      const bb = box.bb;
      if (bb.width < 2 || bb.height < 2) return;
      iosBoxes.push({ id, bb });
    });
  }

  function iosHitTest(clientX, clientY){
    if(!svgRoot || !iosBoxes.length) return null;
    const pt = svgRoot.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svgRoot.getScreenCTM();
    if(!ctm) return null;
    const inv = ctm.inverse();
    const sp = pt.matrixTransform(inv);

    let best = null;
    let bestArea = Infinity;
    for (const it of iosBoxes){
      const bb = it.bb;
      if (sp.x >= bb.x && sp.x <= bb.x + bb.width && sp.y >= bb.y && sp.y <= bb.y + bb.height){
        const area = bb.width * bb.height;
        if (area < bestArea){ bestArea = area; best = it.id; }
      }
    }
    return best;
  }

  function showTapTooltip(clientX, clientY, info){
    try{
      tooltip.textContent = tooltipText(info);
      tooltip.style.left = (clientX + 12) + 'px';
      tooltip.style.top  = (clientY + 12) + 'px';
      tooltip.style.display = 'block';
      setTimeout(()=>{ try{ tooltip.style.display='none'; }catch{} }, 1500);
    }catch{}
  }

  function splitLines(text, maxLen){
    const words = String(text||'').split(/\s+/).filter(Boolean);
    const lines = [];
    let line = '';
    words.forEach(w=>{
      if(!line) { line = w; return; }
      if((line + ' ' + w).length <= maxLen) line += ' ' + w;
      else { lines.push(line); line = w; }
    });
    if(line) lines.push(line);
    return lines.length ? lines : [String(text||'')];
  }

  function getStandNodes(){
    if(!svgRoot) return [];
    const groups = Array.from(svgRoot.querySelectorAll('g[id]')).filter(el=>isStandId(el.id));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]')).filter(el=>isStandId(el.id));
    return groups.length ? groups : shapes;
  }

  function ensureLayers(){
    let pinsLayer = svgRoot.querySelector('#pinsLayer');
    let calloutLayer = svgRoot.querySelector('#calloutLayer');
    if(!pinsLayer){
      pinsLayer = svgEl('g', { id:'pinsLayer' });
      svgRoot.appendChild(pinsLayer);
    }
    if(!calloutLayer){
      calloutLayer = svgEl('g', { id:'calloutLayer' });
      svgRoot.appendChild(calloutLayer);
    }
    return { pinsLayer, calloutLayer };
  }

  function paintNode(standId, status){
    const node = svgRoot.querySelector('#' + CSS.escape(standId));
    if(!node) return;
    const fill = (status === 'sold')
      ? 'rgba(231,76,60,0.75)'
      : (status === 'available')
        ? 'rgba(46,204,113,0.75)'
        : 'rgba(255,255,255,0.0)';
    try{
      if(node.tagName.toLowerCase() === 'g'){
        node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch => ch.style.fill = fill);
      }else{
        node.style.fill = fill;
      }
    }catch{}
  }

  function bindNodeEvents(node){
    const standId = node.id;
    if(!isStandId(standId)) return;

    try{ node.style.pointerEvents='auto'; }catch{}

    node.addEventListener('mouseenter', () => {
      const info = byId.get(standId) || { standId, status:'available', company:'' };
      tooltip.textContent = tooltipText(info);
      tooltip.style.display = 'block';
    });

    node.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });

    node.addEventListener('mousemove', e => {
      if (isPointerDown || Date.now() < hoverDisabledUntil) return;
      const info = byId.get(standId) || { standId, status:'available', company:'' };
      tooltip.textContent = tooltipText(info);
      tooltip.style.left = (e.clientX + 12) + 'px';
      tooltip.style.top  = (e.clientY + 12) + 'px';
      tooltip.style.display = 'block';
    });

    node.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      tooltip.style.display = 'none';
      hoverDisabledUntil = Date.now() + 250;
      togglePin(standId);
    });
  }

  function setFilter(which){
    [filterAll, filterAvail, filterSold].forEach(b=>b.classList.remove('active'));
    if(which==='all') filterAll.classList.add('active');
    if(which==='available') filterAvail.classList.add('active');
    if(which==='sold') filterSold.classList.add('active');
    renderPlan();
    renderSoldList();
    scheduleRenderPins();
  }

  function currentFilter(){
    if(filterAvail.classList.contains('active')) return 'available';
    if(filterSold.classList.contains('active')) return 'sold';
    return 'all';
  }

  function renderPlan(){
    const f = currentFilter();
    byId.forEach((info, id)=>{
      if(f==='all') paintNode(id, info.status);
      else if(f===info.status) paintNode(id, info.status);
      else paintNode(id, 'none');
    });
  }

  function renderSoldList(){
    const sold = Array.from(byId.values()).filter(x=>x.status==='sold');
    sold.sort((a,b)=>(a.company||a.standId).localeCompare(b.company||b.standId));
    soldCount.textContent = String(sold.length);

    soldList.innerHTML = '';
    sold.forEach(info=>{
      const item = document.createElement('div');
      item.className = 'soldItem';
      const name = (info.company && info.company.trim()) ? info.company.trim() : '(no company)';
      item.innerHTML = `
        <div class="soldLeft">
          <div class="soldName">${name}</div>
          <div class="soldMeta">${info.standId}</div>
        </div>
        <div class="soldStand">${info.standId}</div>
      `;
      item.addEventListener('click', ()=>{
        // pin and show label
        pinned.add(info.standId);
        scheduleRenderPins();
      });
      soldList.appendChild(item);
    });
  }

  function renderPins(){
    const { calloutLayer } = ensureLayers();
    calloutLayer.innerHTML = '';
    if (!pinned.size) return;

    const pins = [];
    pinned.forEach(id=>{
      const info = byId.get(id) || { standId:id, status:'available', company:'' };
      pins.push({ standId:id, info });
    });

    // Sort pins by stand position (top-to-bottom) for nicer stacking
    const pinsWithBox = [];
    for (const p of pins){
      const box = getStandBox(p.standId);
      if (!box) continue;
      pinsWithBox.push({info: p.info, standId:p.standId, bb: box.bb, cx: box.cx, cy: box.cy});
    }
    pinsWithBox.sort((a,b)=>a.cy-b.cy);

    pinsWithBox.slice(0, 50).forEach((p, idx) => {  // cap to keep Safari responsive
      const isSold = p.info.status === 'sold';
      const label = (p.info.company && p.info.company.trim())
        ? p.info.company.trim()
        : p.info.standId;

      const lines = splitLines(label, 26);
      const baseFont = (label.length > 28) ? 12 : 14;

      // leader line
      const offsetX = 160;
      const direction = (idx % 2 === 0) ? 1 : -1;
      const labelX = p.cx + (offsetX * direction);
      const labelY = p.cy;

      const line = svgEl('line', {
        x1: p.cx, y1: p.cy,
        x2: labelX, y2: labelY,
        stroke: '#111', 'stroke-width': 2
      });
      line.style.opacity = '0.85';
      calloutLayer.appendChild(line);

      // Estimate label box size (avoid expensive text measurement)
      const charW = baseFont * 0.62;
      const maxLineLen = Math.max(...lines.map(l => l.length), 1);
      const pad = 10;
      const lineH = baseFont + 4;
      const boxW = Math.min(360, Math.max(120, Math.ceil(maxLineLen * charW) + pad * 2));
      const boxH = Math.ceil(lines.length * lineH) + pad * 2;

      const rect = svgEl('rect', {
        x: labelX,
        y: labelY - (boxH/2),
        width: boxW,
        height: boxH,
        rx: 10, ry: 10,
        fill: '#fff',
        stroke: '#111',
        'stroke-width': 2
      });
      rect.style.opacity = '0.92';
      calloutLayer.appendChild(rect);

      const textX = labelX + pad;
      const textY = (labelY - (boxH/2)) + pad;
      const text = svgEl('text', {
        x: textX,
        y: textY,
        'font-size': baseFont,
        'font-family': 'Arial, Helvetica, sans-serif',
        'font-weight': '700',
        fill: '#111',
        'dominant-baseline': 'hanging'
      });

      lines.forEach((ln, i) => {
        const t = svgEl('tspan', { x: textX, dy: i === 0 ? 0 : lineH });
        t.textContent = ln;
        text.appendChild(t);
      });
      calloutLayer.appendChild(text);
    });
  }

  function updatePrintSummary(){
    const parts = [];
    parts.push(`Pins in PDF: ${printPins.checked ? 'Included' : 'Excluded'}`);
    parts.push(`Legend: ${printLegend.checked ? 'Included' : 'Excluded'}`);
    parts.push(`${printSoldList.checked ? 'Exhibitor list: Included' : 'Exhibitor list: Excluded'}`);
    printSummary.textContent = parts.join(' • ');
  }

  async function exportPdf(){
    // uses browser print-to-PDF, with a print-only view
    const title = (eventNameInput.value || 'event').trim().replace(/\s+/g,'_');
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const fname = `${title}_${yyyy}-${mm}-${dd}.pdf`;

    const win = window.open('', '_blank');
    if(!win){ alert('Popup blocked'); return; }

    const svgClone = svgHost.querySelector('svg').cloneNode(true);

    // optionally remove pins/callouts
    if(!printPins.checked){
      const c = svgClone.querySelector('#calloutLayer'); if(c) c.remove();
    }

    const legendHtml = printLegend.checked ? `
      <div style="font-family:system-ui;padding:10px 0 14px;color:#111;">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;font-size:13px;color:#444;">
          <span style="width:14px;height:14px;border-radius:3px;border:1px solid #ddd;background:rgba(46,204,113,.75)"></span> Available
          <span style="width:14px;height:14px;border-radius:3px;border:1px solid #ddd;background:rgba(231,76,60,.75)"></span> Sold
        </div>
      </div>
    ` : '';

    let soldHtml = '';
    if(printSoldList.checked){
      const sold = Array.from(byId.values()).filter(x=>x.status==='sold');
      sold.sort((a,b)=>(a.company||a.standId).localeCompare(b.company||b.standId));
      soldHtml = `
        <h3 style="font-family:system-ui;margin:18px 0 8px;">Exhibitor list</h3>
        <div style="font-family:system-ui;font-size:12.5px;column-count:2;column-gap:18px;">
          ${sold.map(s=>{
            const name=(s.company&&s.company.trim())?s.company.trim():'(no company)';
            return `<div style="break-inside:avoid;padding:2px 0;"><strong>${name}</strong> <span style="color:#666;">(${s.standId})</span></div>`;
          }).join('')}
        </div>
      `;
    }

    win.document.write(`
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>${fname}</title>
<style>
  @page{size:A4 landscape;margin:12mm;}
  body{margin:0;}
  .page{padding:0;margin:0;}
  svg{width:100%;height:auto;}
</style>
</head>
<body>
  <div class="page">
    <h2 style="font-family:system-ui;margin:0 0 6px;">${(eventNameInput.value||'Exhibition Floorplan')}</h2>
    ${legendHtml}
    ${svgClone.outerHTML}
    ${soldHtml}
  </div>
<script>
  // Auto open print dialog; user chooses "Save as PDF"
  window.onload=()=>{ window.print(); };
</script>
</body>
</html>
    `);
    win.document.close();
  }

  function togglePin(standId){
    if (pinned.has(standId)) pinned.delete(standId);
    else pinned.add(standId);
    scheduleRenderPins();
  }

  clearPinsBtn.addEventListener('click', ()=>{
    pinned.clear();
    scheduleRenderPins();
  });

  filterAll.addEventListener('click', ()=>setFilter('all'));
  filterAvail.addEventListener('click', ()=>setFilter('available'));
  filterSold.addEventListener('click', ()=>setFilter('sold'));

  pdfBtn.addEventListener('click', exportPdf);

  [printPins, printLegend, printSoldList].forEach(cb => cb.addEventListener('change', updatePrintSummary));
  updatePrintSummary();

  async function loadSvg(){
    const resp = await fetch('event_plan.svg', { cache:'no-store' });
    if(!resp.ok) throw new Error('Failed to load SVG');
    const txt = await resp.text();
    svgHost.innerHTML = txt;
    svgRoot = svgHost.querySelector('svg');
    if(!svgRoot) throw new Error('SVG root not found');
    ensureLayers();
  }

  async function fetchData(){
    const resp = await fetch(API_BASE, { cache:'no-store' });
    if(!resp.ok) throw new Error('Failed to fetch data');
    const arr = await resp.json();
    byId = new Map();
    arr.forEach(r=>{
      const standId = String(r.standId||'').trim();
      if(!standId) return;
      byId.set(standId, {
        standId,
        status: normalizeStatus(r.status),
        company: String(r.company||'').trim()
      });
    });
  }

  async function syncOnce(){
    try{
      setStatus('Syncing…');
      await fetchData();
      renderPlan();
      renderSoldList();
      scheduleRenderPins();
      setStatus('Last sync: ' + new Date().toLocaleTimeString());
    }catch(e){
      setStatus('Sync error: ' + e.message, true);
      console.error(e);
    }
  }

  (async () => {
    try{
      setStatus('Loading…');
      await loadSvg();
      bboxCache = new Map();
      if (isIOSSafari){ try{ buildIOSHitMap(); }catch{} }
      // bind interactions
      getStandNodes().forEach(bindNodeEvents);

      if (isIOSSafari){
        try{ document.getElementById('svgHost').style.pointerEvents = 'none'; }catch{}
        try{
          const ov = document.getElementById('iosOverlay');
          if (ov){
            ov.style.display = 'block';
            buildIOSHitMap();
            ov.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); }, {passive:false});
            ov.addEventListener('click', (e)=>{
              e.preventDefault(); e.stopPropagation();
              const id = iosHitTest(e.clientX, e.clientY);
              if(!id) return;
              const info = byId.get(id) || { standId:id, status:'available', company:'' };
              showTapTooltip(e.clientX, e.clientY, info);
              togglePin(id);
            });
          }
        }catch{}
      }

      await syncOnce();
      setInterval(syncOnce, SYNC_INTERVAL_MS);
    }catch(e){
      setStatus('Load error: ' + e.message, true);
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
