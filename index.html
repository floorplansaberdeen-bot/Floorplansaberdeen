<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Floorplan</title>
  <style>
    :root{
      --bg:#fafafa;
      --card:#ffffff;
      --border:#e6e6e6;
      --text:#111;
      --muted:#666;
      --accent:rgba(213,109,50,0.75); /* stand fill */
      --selected:#e53935;           /* selected fill */
      --shadow:0 10px 24px rgba(0,0,0,.12);
      --radius:16px;
      --labelW:260px;
      --labelH:74px;
      --labelPad:14px;
      --dotR:5; /* marker radius */
      --lineW:3;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;padding:18px 18px 8px}
    .title h1{margin:0;font-size:44px;letter-spacing:-.02em}
    .title .meta{margin-top:4px;color:var(--muted);font-size:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:active{transform:translateY(1px)}
    main{display:grid;grid-template-columns: minmax(420px, 1fr) 420px;gap:16px;padding:0 18px 18px}
    @media (max-width: 980px){
      header{position:sticky;top:0;background:var(--bg);z-index:30;padding-bottom:12px}
      main{grid-template-columns:1fr}
    }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .cardHead{padding:12px 14px;border-bottom:1px solid #f0f0f0;font-weight:700}
    .planWrap{position:relative;display:flex;flex-direction:column;min-height:520px}
    .svgArea{position:relative;flex:1;min-height:320px}
    .svgHost{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:12px}
    .svgHost svg{width:100%;height:100%;max-height:100%;max-width:100%}
    .labelArea{position:relative;height:140px;border-top:1px solid #f0f0f0;background:#fff}
    .labelBox{
      position:absolute;left:50%;top:50%;
      width:var(--labelW);height:var(--labelH);
      transform:translate(-50%,-50%);
      background:var(--selected);
      border-radius:14px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:#fff;
      box-shadow:var(--shadow);
      text-align:center;
      pointer-events:none;
    }
    .labelBox .id{font-size:26px;font-weight:900;line-height:1;margin-bottom:6px;letter-spacing:.02em}
    .labelBox .name{font-size:16px;font-weight:700;line-height:1.1;opacity:.95}
    .labelHidden{display:none !important;}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .overlay line{stroke:#222;stroke-width:var(--lineW);stroke-linecap:round}
    .overlay circle{fill:#222}

    /* sidebar */
    .side{padding:14px}
    .box{border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px;background:#fff}
    .box h3{margin:0 0 10px;font-size:16px}
    .selectedBig{font-size:44px;font-weight:900;line-height:1;margin:2px 0 6px}
    .selectedName{font-size:22px;font-weight:800;margin:0 0 10px}
    .help{color:var(--muted);font-size:13px}
    .search{display:flex;gap:10px;margin:10px 0 12px}
    input[type="search"]{width:100%;padding:12px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px}
    .list{max-height:460px;overflow:auto;border:1px solid var(--border);border-radius:14px;background:#fff}
    .row{padding:12px 12px;border-bottom:1px solid #f2f2f2;cursor:pointer}
    .row:last-child{border-bottom:none}
    .row strong{display:block;font-size:16px}
    .row small{color:var(--muted)}
    .row.active{background:#fff5f5}
    /* iOS bottom bar padding so last row can be tapped */
    .list{padding-bottom:calc(14px + env(safe-area-inset-bottom))}
    .error{color:#b00020;font-weight:700;margin-top:6px}

    /* phone behaviour */
    @media (max-width: 980px){
      main{padding-bottom:24px}
      .planCard{position:sticky;top:92px;z-index:20}
      .planWrap{min-height:420px}
      .labelArea{height:120px}
      :root{ --labelW:220px; --labelH:64px; --dotR:4; --lineW:3; }
      .title h1{font-size:40px}
    }
    /* Disable stand clicking on touch phones (list only) */
    @media (hover: none) and (pointer: coarse){
      .svgHost{pointer-events:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1 id="eventTitle">Floorplan</h1>
      <div class="meta">Updated: <span id="updatedAt">—</span> · <span id="statusText">Loading…</span></div>
      <div id="errorText" class="error" style="display:none"></div>
    </div>
    <div class="actions">
      <button id="exportPdfBtn">Export PDF</button>
      <button id="clearBtn">Clear selection</button>
    </div>
  </header>

  <main>
    <section class="card planCard">
      <div class="cardHead">Plan</div>
      <div class="planWrap" id="planWrap">
        <div class="svgArea">
          <div class="svgHost" id="svgHost"></div>
          <svg class="overlay" id="overlaySvg"></svg>
        </div>
        <div class="labelArea">
          <div class="labelBox labelHidden" id="labelBox">
            <div class="id" id="labelId"></div>
            <div class="name" id="labelName"></div>
          </div>
        </div>
      </div>
    </section>

    <aside class="side">
      <div class="box">
        <h3>Selected exhibitor</h3>
        <div class="selectedBig" id="selStand">None</div>
        <div class="selectedName" id="selName"></div>
        <div class="help">Desktop: click a stand or choose from the list.<br/>Phone: use the list (stand tapping is disabled).</div>
      </div>

      <div class="box">
        <h3>Sold exhibitors</h3>
        <div class="search">
          <input id="searchInput" type="search" placeholder="Search company or stand…"/>
        </div>
        <div class="list" id="soldList"></div>
      </div>

      <div class="box">
        <h3>Help</h3>
        <div class="help">Selecting an exhibitor makes their stand red with a label + line.</div>
      </div>
    </aside>
  </main>

<script>
(() => {
  const DEFAULT_BACKEND = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const STANDS_ENDPOINT = "/stands"; // expects JSON array [{standId,status,company}]
  const SVG_URL = "event_plan.svg";

  const COLORS = {
    base: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || "rgba(213,109,50,0.75)",
    selected: getComputedStyle(document.documentElement).getPropertyValue('--selected').trim() || "#e53935"
  };

  const el = (id) => document.getElementById(id);

  const state = {
    backend: getBackendBase(),
    svgEl: null,
    standElById: new Map(),
    stands: [],
    selectedId: null,
    updatedAt: null
  };

  function getBackendBase(){
    const saved = localStorage.getItem("floorplan_backend_base");
    if (saved && /^https?:\/\//i.test(saved)) return saved.replace(/\/+$/,'');
    return DEFAULT_BACKEND;
  }

  function setStatus(text, ok=true){
    el("statusText").textContent = text;
    el("statusText").style.color = ok ? "#0a7a2b" : "#b00020";
  }
  function showError(msg){
    const e = el("errorText");
    e.style.display = "block";
    e.textContent = msg;
  }
  function clearError(){
    const e = el("errorText");
    e.style.display = "none";
    e.textContent = "";
  }

  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.text();
  }

  async function loadSvg(){
    const host = el("svgHost");
    host.innerHTML = "";
    const svgText = await fetchText(SVG_URL);
    const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
    const svg = doc.documentElement;
    // Ensure responsive
    svg.removeAttribute("width"); svg.removeAttribute("height");
    svg.setAttribute("preserveAspectRatio","xMidYMid meet");
    svg.style.width="100%"; svg.style.height="100%";
    host.appendChild(svg);
    state.svgEl = svg;

    // Build stand element map on demand (by id)
    state.standElById.clear();
  }

  function findStandEl(standId){
    if(state.standElById.has(standId)) return state.standElById.get(standId);
    if(!state.svgEl) return null;
    // Common patterns: element id == standId
    let node = state.svgEl.querySelector(`#${CSS.escape(standId)}`);
    if(!node){
      node = state.svgEl.querySelector(`[data-stand="${standId}"]`);
    }
    state.standElById.set(standId, node || null);
    return node || null;
  }

  function applyStandColors(){
    if(!state.svgEl) return;
    // reset all known stand ids
    for(const s of state.stands){
      const node = findStandEl(s.standId);
      if(!node) continue;
      // base is always base on public
      node.style.fill = COLORS.base;
      node.style.cursor = "pointer";
      node.style.transition = "fill 120ms ease";
    }
    if(state.selectedId){
      const node = findStandEl(state.selectedId);
      if(node) node.style.fill = COLORS.selected;
    }
  }

  function standCenterInPlan(standId){
    const node = findStandEl(standId);
    if(!node) return null;
    const planRect = el("planWrap").getBoundingClientRect();
    const r = node.getBoundingClientRect();
    return {
      x: (r.left + r.right)/2 - planRect.left,
      y: (r.top + r.bottom)/2 - planRect.top
    };
  }

  function updateLabelAndPointer(){
    const labelBox = el("labelBox");
    const overlay = el("overlaySvg");
    overlay.innerHTML = "";
    overlay.setAttribute("width","100%");
    overlay.setAttribute("height","100%");
    overlay.setAttribute("viewBox", `0 0 ${el("planWrap").clientWidth} ${el("planWrap").clientHeight}`);

    if(!state.selectedId){
      labelBox.classList.add("labelHidden");
      return;
    }

    const sel = state.stands.find(s => s.standId === state.selectedId);
    el("labelId").textContent = state.selectedId;
    el("labelName").textContent = (sel && sel.company) ? sel.company : "";
    labelBox.classList.remove("labelHidden");

    const planWrap = el("planWrap");
    const planRect = planWrap.getBoundingClientRect();
    const labelRect = labelBox.getBoundingClientRect();
    const p = standCenterInPlan(state.selectedId);
    if(!p) return;

    // label top-middle
    const lx = (labelRect.left + labelRect.right)/2 - planRect.left;
    const ly = (labelRect.top) - planRect.top;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", lx);
    line.setAttribute("y1", ly);
    line.setAttribute("x2", p.x);
    line.setAttribute("y2", p.y);
    overlay.appendChild(line);

    const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
    const r = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dotR')) || 5;
    dot.setAttribute("cx", p.x);
    dot.setAttribute("cy", p.y);
    dot.setAttribute("r", r);
    overlay.appendChild(dot);
  }

  function setSelected(standId){
    state.selectedId = standId;
    const s = state.stands.find(x => x.standId === standId) || null;
    el("selStand").textContent = standId || "None";
    el("selName").textContent = s && s.company ? s.company : "";
    applyStandColors();
    updateLabelAndPointer();
    renderSoldList(); // to highlight active row
  }

  function clearSelection(){
    state.selectedId = null;
    el("selStand").textContent = "None";
    el("selName").textContent = "";
    applyStandColors();
    updateLabelAndPointer();
    renderSoldList();
  }

  function wireStandClicksDesktopOnly(){
    if(!state.svgEl) return;
    // On touch phones we disabled pointer events via CSS.
    for(const s of state.stands){
      const node = findStandEl(s.standId);
      if(!node) continue;
      node.addEventListener("click", (e) => {
        setSelected(s.standId);
      });
    }
  }

  async function fetchStands(){
    const url = state.backend + STANDS_ENDPOINT;
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`Backend error ${res.status}`);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("Unexpected backend response");
    state.stands = data.map(x => ({
      standId: String(x.standId || "").trim(),
      status: String(x.status || "").toLowerCase(),
      company: String(x.company || "").trim()
    })).filter(x => x.standId);
    state.updatedAt = new Date();
    el("updatedAt").textContent = state.updatedAt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }

  function soldStandsFiltered(){
    const q = (el("searchInput").value || "").trim().toLowerCase();
    return state.stands
      .filter(s => s.status === "sold")
      .filter(s => !q || s.standId.toLowerCase().includes(q) || (s.company||"").toLowerCase().includes(q))
      .sort((a,b) => a.standId.localeCompare(b.standId, undefined, {numeric:true}));
  }

  function renderSoldList(){
    const list = el("soldList");
    list.innerHTML = "";
    const items = soldStandsFiltered();
    for(const s of items){
      const row = document.createElement("div");
      row.className = "row" + (state.selectedId === s.standId ? " active" : "");
      row.innerHTML = `<strong>${escapeHtml(s.company || "(No company)")}</strong><small>Stand ${escapeHtml(s.standId)}</small>`;
      row.addEventListener("click", () => setSelected(s.standId));
      list.appendChild(row);
    }
    if(items.length === 0){
      const empty = document.createElement("div");
      empty.className = "row";
      empty.style.cursor = "default";
      empty.innerHTML = `<strong>No sold stands</strong><small>Nothing matches your search.</small>`;
      list.appendChild(empty);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  async function init(){
    clearError();
    try{
      setStatus("Loading…", true);
      await loadSvg();
      await fetchStands();
      applyStandColors();
      wireStandClicksDesktopOnly();
      renderSoldList();
      setStatus("Ready ✅", true);
    }catch(err){
      console.error(err);
      setStatus("Error loading ✗", false);
      showError(`Failed to load. Backend: ${state.backend}. (${err.message || err})`);
      // still try to load SVG at least
      try{
        if(!state.svgEl) await loadSvg();
      }catch(_e){}
    }
    updateLabelAndPointer();
  }

  // UI events
  el("searchInput").addEventListener("input", renderSoldList);
  el("clearBtn").addEventListener("click", clearSelection);

  el("exportPdfBtn").addEventListener("click", () => window.print());

  // Keep pointer correct on resize/scroll
  window.addEventListener("resize", () => { updateLabelAndPointer(); });
  window.addEventListener("scroll", () => { updateLabelAndPointer(); }, {passive:true});

  init();
})();
</script>
</body>
</html>
