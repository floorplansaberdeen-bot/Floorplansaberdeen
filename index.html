<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{
    --border:#e6e6e6;
    --muted:#666;
    --card:#fff;
    --shadow: 0 10px 25px rgba(0,0,0,.10);
    --selected:#e53935;
    --standRGB: 213,109,50;
  }

  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}
  header{
    padding:14px 16px;border-bottom:1px solid var(--border);
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
  }
  .titleWrap{display:grid;gap:4px}
  #eventName{font-size:26px;font-weight:900;line-height:1;}
  #updated{font-size:13px;color:var(--muted);}
  #status{font-size:14px;color:#0a7a2a;font-weight:700;}

  .topBtns{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{
    border:1px solid var(--border);background:#f8f8f8;border-radius:10px;
    padding:10px 14px;font-weight:800;cursor:pointer;font-size:14px;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .btn.primary{background:#fff;}

  .layout{display:grid;grid-template-columns:2.3fr 1fr;gap:14px;padding:14px;}
  @media (max-width: 980px){
    .layout{grid-template-columns:1fr;}
  }

  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;
  }
  .planCard{position:relative;overflow:hidden;}
  #svgHost{min-height:480px; overflow:auto; padding:12px;}
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none;user-select:none;}

  /* Legend lozenge */
  .legend{
    position:absolute;left:50%;transform:translateX(-50%);
    bottom:14px;
    background:#fff;border:1px solid var(--border);border-radius:999px;
    padding:10px 14px;display:flex;gap:18px;align-items:center;
    box-shadow: var(--shadow);
    font-weight:800;
  }
  .dot{width:12px;height:12px;border-radius:50%;}
  .dot.stand{background:rgba(var(--standRGB),.75);}
  .dot.sel{background:var(--selected);}

  @media (max-width: 600px){
    #eventName{font-size:22px;}
    #svgHost{min-height:360px; padding:10px;}
    .legend{bottom:22px;} /* higher so it doesn't get clipped */
  }

  .side{display:grid;gap:12px;}
  .panelTitle{font-weight:900;margin:0 0 6px 0;}
  .selBox{
    border:1px solid var(--border);border-radius:14px;padding:12px;
    background:#fff;
  }
  #selStand{font-size:20px;font-weight:900;line-height:1.1;}
  #selCompany{font-size:18px;font-weight:800;margin-top:4px;}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}

  .listBox{
    border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden;
  }
  .listHead{padding:12px;border-bottom:1px solid var(--border);}
  #search{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;}
  #list{max-height:520px;overflow:auto;}
  .row{
    padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;
    display:grid;gap:2px;
  }
  .row:hover{background:#fafafa;}
  .row strong{font-size:14px;}
  .row small{color:var(--muted);font-weight:700;}
  .row.active{outline:2px solid rgba(0,0,0,.12);background:#fff;}

  @media (max-width: 600px){
    .calloutTitle{font-size:20px !important;}
    .calloutSub{font-size:14px !important;}
  }
</style>
</head>
<body>

<header>
  <div class="titleWrap">
    <div id="eventName">Loading…</div>
    <div id="updated">Updated: —</div>
    <div id="status">Loading…</div>
  </div>

  <div class="topBtns">
    <button class="btn primary" id="btnPdf">Export PDF</button>
    <button class="btn" id="btnClear">Clear selection</button>
  </div>
</header>

<div class="layout">
  <div class="card planCard">
    <div id="svgHost"></div>

    <div class="legend" aria-hidden="true">
      <span style="display:flex;align-items:center;gap:8px;"><span class="dot stand"></span>Stands</span>
      <span style="display:flex;align-items:center;gap:8px;"><span class="dot sel"></span>Selected</span>
    </div>
  </div>

  <div class="side">
    <div class="selBox">
      <div class="panelTitle">Selected exhibitor</div>
      <div id="selStand">None</div>
      <div id="selCompany"></div>
      <div class="hint">
        Desktop: click a stand or choose from the list.<br>
        Phone: use the list (stand tapping is disabled).
      </div>
    </div>

    <div class="listBox">
      <div class="listHead">
        <div class="panelTitle">Sold exhibitors</div>
        <input id="search" placeholder="Search company or stand…" />
      </div>
      <div id="list"></div>
    </div>

    <div class="selBox">
      <div class="panelTitle">Help</div>
      <div class="hint">All stands are in the main colour. Selecting an exhibitor makes their stand red with a label + line.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  const API_BASE = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const SVG_URL  = "./event_plan.svg";

  const STAND_FILL_RGB = "213,109,50";
  const STAND_OPACITY  = 0.75;
  const SELECTED_FILL  = "#e53935";

  const STAND_ID_RE = /^([A-Z]{1,3})(\d{1,3})$/;
  const isPhone = matchMedia("(max-width: 600px)").matches;

  const elEvent  = document.getElementById("eventName");
  const elUpdated= document.getElementById("updated");
  const elStatus = document.getElementById("status");

  const svgHost  = document.getElementById("svgHost");
  const listEl   = document.getElementById("list");
  const searchEl = document.getElementById("search");

  const selStand = document.getElementById("selStand");
  const selCo    = document.getElementById("selCompany");

  const btnClear = document.getElementById("btnClear");
  const btnPdf   = document.getElementById("btnPdf");

  let svgRoot = null;
  let stands = [];
  let byId = new Map();
  let selectedId = "";
  let calloutG = null;

  // NEW: cache overall plan bounding box so labels stay outside it
  let planBBox = null;

  function setStatus(txt, ok=true){
    elStatus.textContent = txt;
    elStatus.style.color = ok ? "#0a7a2a" : "#b00020";
  }
  function normalizeStatus(v){
    return String(v||"").toLowerCase().trim()==="sold" ? "sold" : "available";
  }
  function isStandId(id){ return STAND_ID_RE.test(String(id||"").trim()); }

  async function fetchJson(url){
    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text();
    const json = JSON.parse(text);
    if(!res.ok) throw new Error("HTTP "+res.status);
    return json;
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("SVG not found: "+SVG_URL+" (HTTP "+res.status+")");
    svgHost.innerHTML = await res.text();
    svgRoot = svgHost.querySelector("svg");
    if(!svgRoot) throw new Error("SVG missing <svg> root");

    svgRoot.querySelectorAll("text,tspan").forEach(t=>{
      t.style.pointerEvents = "none";
      t.style.userSelect = "none";
    });

    calloutG = document.createElementNS("http://www.w3.org/2000/svg", "g");
    calloutG.setAttribute("id","__callout");
    svgRoot.appendChild(calloutG);

    computePlanBBox();
    ensureLabelLaneSpace();
  }

  function getStandNodes(){
    const shapes = Array.from(svgRoot.querySelectorAll("path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id]"))
      .filter(el => isStandId(el.id));
    if (shapes.length) return shapes;
    return Array.from(svgRoot.querySelectorAll("g[id]")).filter(g=>isStandId(g.id));
  }

  function paintStandNode(node, isSelected){
    const targets = (node.tagName.toLowerCase()==="g")
      ? node.querySelectorAll("path,rect,polygon,circle,ellipse,polyline,line")
      : [node];

    const fill = isSelected ? SELECTED_FILL : `rgb(${STAND_FILL_RGB})`;
    const op   = isSelected ? "0.85" : String(STAND_OPACITY);

    targets.forEach(el=>{
      el.style.fill = fill;
      el.style.fillOpacity = op;
      el.style.stroke = "rgba(0,0,0,0.45)";
      el.style.strokeOpacity = "0.6";
      el.style.cursor = isPhone ? "default" : "pointer";
    });
  }

  function repaintAll(){
    if(!svgRoot) return;
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      paintStandNode(node, id === selectedId);
    });
  }

  function standBBox(standId){
    const node = svgRoot.querySelector("#"+CSS.escape(standId));
    if(!node) return null;
    try{ return node.getBBox(); }catch(_){ return null; }
  }

  function getViewBox(){
    let vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
    if(!vb || !vb.width){
      try{
        const rootBB = svgRoot.getBBox();
        svgRoot.setAttribute("viewBox", `${rootBB.x} ${rootBB.y} ${rootBB.width} ${rootBB.height}`);
        vb = svgRoot.viewBox.baseVal;
      }catch(_){
        vb = {x:0,y:0,width:1000,height:700};
      }
    }
    return vb;
  }

  // NEW: compute union bbox of all stands so we know the "plan area"
  function computePlanBBox(){
    const nodes = getStandNodes();
    let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
    nodes.forEach(n=>{
      try{
        const b = (n.tagName.toLowerCase()==="g") ? n.getBBox() : n.getBBox();
        minX = Math.min(minX, b.x);
        minY = Math.min(minY, b.y);
        maxX = Math.max(maxX, b.x + b.width);
        maxY = Math.max(maxY, b.y + b.height);
      }catch(_){}
    });
    if(minX!==Infinity){
      planBBox = { x:minX, y:minY, width:maxX-minX, height:maxY-minY };
    }else{
      planBBox = null;
    }
  }

  // NEW: make sure the svg has extra room BELOW the plan for the label lane
  function ensureLabelLaneSpace(){
    const vb = getViewBox();
    if(!planBBox) return;

    const laneHeight = isPhone ? 210 : 180;   // space reserved for label below
    const needBottom = planBBox.y + planBBox.height + laneHeight;
    const vbBottom   = vb.y + vb.height;

    if(vbBottom < needBottom){
      const extra = needBottom - vbBottom;
      svgRoot.setAttribute("viewBox", `${vb.x} ${vb.y} ${vb.width} ${vb.height + extra}`);
    }
  }

  // NEW: callout is always placed in the label lane below the planBBox
  function chooseLanePosition(standBB){
    const vb = getViewBox();

    const w = isPhone ? 260 : 320;
    const h = isPhone ? 92  : 104;

    const laneTop = planBBox ? (planBBox.y + planBBox.height + (isPhone ? 35 : 30)) : (vb.y + vb.height - h - 30);

    // Center the label roughly under the stand, but clamp to viewBox.
    const standCx = standBB.x + standBB.width/2;
    const pad = 18;

    const x = Math.max(vb.x + pad, Math.min(standCx - w/2, vb.x + vb.width - w - pad));
    const y = Math.max(laneTop, vb.y + pad);

    return {x,y,w,h};
  }

  function clearCallout(){
    if(calloutG) calloutG.innerHTML = "";
  }

  function drawCallout(standId){
    clearCallout();
    if(!standId) return;

    // always re-evaluate plan bbox + lane space (in case SVG changes)
    computePlanBBox();
    ensureLabelLaneSpace();

    const info = byId.get(standId) || { standId, company:"" };
    const bb = standBBox(standId);
    if(!bb) return;

    const vb = getViewBox();
    const box = chooseLanePosition(bb);

    const standCx = bb.x + bb.width/2;
    const standCy = bb.y + bb.height/2;

    // anchor point on box (top-center)
    const ax = box.x + box.w/2;
    const ay = box.y;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", ax);
    line.setAttribute("y1", ay);
    line.setAttribute("x2", standCx);
    line.setAttribute("y2", standCy);
    line.setAttribute("stroke", "rgba(0,0,0,.75)");
    line.setAttribute("stroke-width", isPhone ? "6" : "4");
    line.setAttribute("stroke-linecap","round");

    const pin = document.createElementNS("http://www.w3.org/2000/svg","circle");
    pin.setAttribute("cx", standCx);
    pin.setAttribute("cy", standCy);
    pin.setAttribute("r", isPhone ? "16" : "12");
    pin.setAttribute("fill", "rgba(0,0,0,.75)");

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", box.x);
    rect.setAttribute("y", box.y);
    rect.setAttribute("width", box.w);
    rect.setAttribute("height", box.h);
    rect.setAttribute("rx", "16");
    rect.setAttribute("ry", "16");
    rect.setAttribute("fill", SELECTED_FILL);
    rect.setAttribute("fill-opacity","0.95");
    rect.style.filter = "drop-shadow(0px 10px 16px rgba(0,0,0,.22))";

    const t1 = document.createElementNS("http://www.w3.org/2000/svg","text");
    t1.setAttribute("x", box.x + box.w/2);
    t1.setAttribute("y", box.y + (isPhone ? 42 : 46));
    t1.setAttribute("text-anchor","middle");
    t1.setAttribute("fill","#fff");
    t1.style.fontFamily = "Arial, Helvetica, sans-serif";
    t1.style.fontWeight = "900";
    t1.style.fontSize = isPhone ? "28px" : "34px";
    t1.setAttribute("class","calloutTitle");
    t1.textContent = info.standId;

    const t2 = document.createElementNS("http://www.w3.org/2000/svg","text");
    t2.setAttribute("x", box.x + box.w/2);
    t2.setAttribute("y", box.y + (isPhone ? 74 : 82));
    t2.setAttribute("text-anchor","middle");
    t2.setAttribute("fill","#fff");
    t2.style.fontFamily = "Arial, Helvetica, sans-serif";
    t2.style.fontWeight = "800";
    t2.style.fontSize = isPhone ? "16px" : "18px";
    t2.setAttribute("class","calloutSub");
    t2.textContent = (info.company || "").trim();

    calloutG.appendChild(line);
    calloutG.appendChild(pin);
    calloutG.appendChild(rect);
    calloutG.appendChild(t1);
    if(t2.textContent) calloutG.appendChild(t2);
  }

  function setSelected(standId){
    selectedId = standId || "";
    if(!selectedId){
      selStand.textContent = "None";
      selCo.textContent = "";
      clearCallout();
      repaintAll();
      renderList();
      return;
    }
    const info = byId.get(selectedId) || { standId:selectedId, company:"" };
    selStand.textContent = info.standId;
    selCo.textContent = (info.company || "").trim();
    repaintAll();
    renderList();
    drawCallout(selectedId);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function renderList(){
    const q = String(searchEl.value||"").toLowerCase().trim();
    const sold = stands
      .filter(s => normalizeStatus(s.status)==="sold")
      .filter(s => String(s.company||"").trim() !== "")
      .map(s => ({ standId:String(s.standId).trim(), company:String(s.company||"").trim() }))
      .sort((a,b)=>a.company.localeCompare(b.company));

    const filtered = !q ? sold : sold.filter(x =>
      x.company.toLowerCase().includes(q) || x.standId.toLowerCase().includes(q)
    );

    listEl.innerHTML = "";
    filtered.forEach(item=>{
      const row = document.createElement("div");
      row.className = "row" + (item.standId===selectedId ? " active":"");
      row.innerHTML = `<strong>${escapeHtml(item.company)}</strong><small>Stand ${escapeHtml(item.standId)}</small>`;
      row.addEventListener("click", ()=>setSelected(item.standId));
      listEl.appendChild(row);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.padding = "12px";
      empty.style.color = "#777";
      empty.textContent = "No sold exhibitors found.";
      listEl.appendChild(empty);
    }
  }

  async function sync(){
    try{
      const settings = await fetchJson(API_BASE + "/settings?ts=" + Date.now());
      elEvent.textContent = (settings && settings.eventName) ? settings.eventName : "New Event";
    }catch(_){
      elEvent.textContent = "New Event";
    }

    stands = await fetchJson(API_BASE + "/stands?ts=" + Date.now());
    if(!Array.isArray(stands)) stands = [];

    byId = new Map(stands.map(s => [String(s.standId).trim(), {
      standId: String(s.standId).trim(),
      status: normalizeStatus(s.status),
      company: String(s.company||"").trim()
    }]));

    elUpdated.textContent = "Updated: " + new Date().toLocaleTimeString();
    renderList();

    if(selectedId && !byId.has(selectedId)) selectedId = "";
    repaintAll();
    if(selectedId) drawCallout(selectedId);
  }

  function bindStandClick(){
    if(isPhone) return;
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      node.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        setSelected(id);
      });
    });
  }

  async function exportPdf(){
    try{
      btnPdf.disabled = true;
      setStatus("Preparing PDF…", true);

      const svg = svgRoot.cloneNode(true);
      svg.removeAttribute("width");
      svg.removeAttribute("height");

      const svgText = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([svgText], { type:"image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const img = new Image();
      img.crossOrigin = "anonymous";
      await new Promise((resolve,reject)=>{
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });

      const canvas = document.createElement("canvas");
      const w = img.width || 1600;
      const h = img.height || 900;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0);

      URL.revokeObjectURL(url);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: w >= h ? "landscape" : "portrait",
        unit: "pt",
        format: [w, h]
      });

      const dataUrl = canvas.toDataURL("image/png");
      pdf.addImage(dataUrl, "PNG", 0, 0, w, h);
      pdf.save((elEvent.textContent || "floorplan") + ".pdf");

      setStatus("Ready ✅", true);
    }catch(e){
      console.error(e);
      setStatus("PDF export failed", false);
    }finally{
      btnPdf.disabled = false;
    }
  }

  (async ()=>{
    try{
      setStatus("Loading…", true);
      await loadSvg();
      await sync();
      bindStandClick();
      setSelected("");
      repaintAll();
      setStatus("Ready ✅", true);
      setInterval(()=>sync().catch(()=>{}), 15000);
    }catch(e){
      console.error(e);
      setStatus("Load error", false);
      elEvent.textContent = "New Event";
    }
  })();

  searchEl.addEventListener("input", renderList);
  btnClear.addEventListener("click", ()=>setSelected(""));
  btnPdf.addEventListener("click", exportPdf);

})();
</script>
</body>
</html>
