<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Floorplan</title>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --border: #e7e7e7;
      --text: #111;
      --muted: #666;
      --mainFill: rgba(213, 109, 50, 0.75); /* requested */
      --selectedFill: #e53935;
      --selectedLabel: #e53935;
      --shadow: 0 14px 28px rgba(0,0,0,.12), 0 6px 12px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .topbar{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:18px 18px 10px}
    .titlewrap h1{margin:0;font-size:44px;line-height:1.05}
    .meta{margin-top:6px;color:var(--muted);font-size:14px}
    .status{margin-top:6px;font-weight:700;color:#0a7a2c}
    .actions{display:flex;gap:10px}
    .btn{border:1px solid var(--border);background:#f9f9f9;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .wrap{display:grid;grid-template-columns: minmax(520px, 1fr) 420px;gap:14px;padding:0 18px 18px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card .hd{padding:12px 14px;border-bottom:1px solid #f1f1f1;font-weight:800}
    .card .bd{padding:14px}
    /* Plan area */
    .planShell{padding:14px}
    .planFrame{border:1px solid #ededed;border-radius:14px;background:#fff;overflow:hidden}
    .planStage{position:relative;}
    .planObject{display:block;width:100%;height:420px;border:0;}
    .labelArea{height:140px;position:relative;}
    .labelBox{position:absolute;left:50%;top:18px;transform:translateX(-50%);min-width:220px;max-width:min(520px, 80vw);
      background:var(--selectedLabel);color:#fff;border-radius:14px;padding:16px 18px;text-align:center;
      box-shadow:var(--shadow);}
    .labelBox.hidden{display:none}
    .labelBox .stand{font-size:40px;font-weight:900;line-height:1}
    .labelBox .company{margin-top:6px;font-size:18px;font-weight:700;opacity:.95}
    .overlaySvg{position:absolute;inset:0;pointer-events:none}
    /* Side panel */
    .panelTitle{font-weight:900;font-size:14px;margin-bottom:6px}
    .bigSel{font-size:44px;font-weight:950;line-height:1;margin:6px 0 2px}
    .selCompany{font-size:22px;font-weight:800;margin:0 0 8px}
    .hint{color:var(--muted);font-size:13px;line-height:1.35}
    .search{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;outline:none}
    .list{margin-top:10px;border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:560px;
      padding-bottom:calc(28px + env(safe-area-inset-bottom));}
    .row{padding:12px 12px;border-top:1px solid #f1f1f1;cursor:pointer}
    .row:first-child{border-top:none}
    .row.active{background:#fff2f2}
    .row .nm{font-weight:900;font-size:20px}
    .row .st{color:var(--muted);margin-top:1px}
    .help{color:var(--muted);font-size:13px}
    .error{color:#b00020;font-weight:900}
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
      .planObject{height:340px}
      .labelArea{height:120px}
      .titlewrap h1{font-size:40px}
    }
    @media (max-width: 560px){
      .topbar{padding:14px 14px 8px}
      .wrap{padding:0 14px 14px}
      .titlewrap h1{font-size:42px}
      .planObject{height:300px}
      .labelArea{height:110px}
      .labelBox .stand{font-size:34px}
      .labelBox .company{font-size:16px}
    }
    @media print {
      .actions,.card.side{display:none}
      .wrap{grid-template-columns:1fr}
      .labelArea{height:120px}
      body{background:#fff}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="titlewrap">
      <h1 id="eventTitle">Floorplan</h1>
      <div class="meta">Updated: <span id="updated">—</span></div>
      <div class="status" id="status">Loading…</div>
      <div class="error" id="error" style="display:none"></div>
    </div>
    <div class="actions">
      <button class="btn" id="exportBtn">Export PDF</button>
      <button class="btn" id="clearBtn">Clear selection</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="hd">Plan</div>
      <div class="planShell">
        <div class="planFrame">
          <div class="planStage" id="planStage">
            <object id="planObj" class="planObject" type="image/svg+xml" data="event_plan.svg"></object>
            <svg id="overlay" class="overlaySvg"></svg>
          </div>
          <div class="labelArea" id="labelArea">
            <div class="labelBox hidden" id="labelBox">
              <div class="stand" id="labelStand">—</div>
              <div class="company" id="labelCompany"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card side">
      <div class="bd">
        <div class="panelTitle">Selected exhibitor</div>
        <div class="bigSel" id="selStand">None</div>
        <div class="selCompany" id="selCompany" style="display:none"></div>
        <div class="hint">
          Desktop: click a stand or choose from the list.<br/>
          Phone: use the list (stand tapping is disabled).
        </div>
      </div>
      <div class="bd" style="padding-top:0">
        <div class="panelTitle">Sold exhibitors</div>
        <input class="search" id="search" placeholder="Search company or stand…" />
        <div class="list" id="list"></div>
      </div>
      <div class="bd" style="padding-top:0">
        <div class="panelTitle">Help</div>
        <div class="help">Selecting an exhibitor makes their stand red with a label + line.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_BACKEND = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const state = {
    backend: localStorage.getItem("floorplan_backend") || DEFAULT_BACKEND,
    svgDoc: null,
    svgRoot: null,
    stands: [],
    selectedId: null,
    isPhone: window.matchMedia("(max-width: 700px)").matches || /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent),
  };

  const el = (id) => document.getElementById(id);

  function setStatus(txt, ok=true) {
    el("status").textContent = txt;
    el("status").style.color = ok ? "#0a7a2c" : "#b00020";
  }
  function showError(msg) {
    el("error").style.display = "block";
    el("error").textContent = msg;
  }
  function clearError() {
    el("error").style.display = "none";
    el("error").textContent = "";
  }

  async function fetchJson(path, opts={}) {
    const url = state.backend.replace(/\/$/, "") + path;
    const res = await fetch(url, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        ...(opts.headers||{})
      },
      cache: "no-store",
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText} ${txt ? "- " + txt.slice(0,120) : ""}`);
    }
    return res.json();
  }

  // SVG loading (object tag = reliable on GitHub Pages)
  function waitForSvgObject(obj) {
    return new Promise((resolve, reject) => {
      const done = () => {
        const doc = obj.contentDocument;
        if (!doc) return reject(new Error("SVG not available"));
        const svg = doc.querySelector("svg");
        if (!svg) return reject(new Error("SVG root missing"));
        resolve({doc, svg});
      };
      if (obj.contentDocument && obj.contentDocument.querySelector("svg")) return done();
      obj.addEventListener("load", done, {once:true});
      obj.addEventListener("error", () => reject(new Error("Failed to load event_plan.svg")), {once:true});
    });
  }

  function getStandElements() {
    if (!state.svgDoc) return [];
    // Stands are groups/paths/rects with id equal to standId
    return Array.from(state.svgDoc.querySelectorAll("[id]")).filter(n => /^([A-Z]{1,2}\d{1,2}|A\d+|B\d+|C\d+|SB\d+|AA\d+|AB\d+|AC\d+|AD\d+)$/i.test(n.id));
  }

  function applyStandColors() {
    if (!state.svgDoc) return;
    const all = getStandElements();
    all.forEach(node => {
      node.style.cursor = state.isPhone ? "default" : "pointer";
      node.style.fill = "var(--mainFill)";
      node.style.fillOpacity = "1";
    });
    if (state.selectedId) {
      const sel = state.svgDoc.getElementById(state.selectedId);
      if (sel) sel.style.fill = "var(--selectedFill)";
    }
  }

  function wireClicksDesktopOnly() {
    if (!state.svgDoc) return;
    const all = getStandElements();
    all.forEach(node => {
      node.onclick = null;
      if (state.isPhone) return;
      node.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        selectStand(node.id);
      });
    });
  }

  function getStandById(id) {
    return state.stands.find(s => String(s.standId).toUpperCase() === String(id).toUpperCase()) || null;
  }

  function renderList() {
    const q = el("search").value.trim().toLowerCase();
    const sold = state.stands.filter(s => String(s.status).toLowerCase() === "sold");
    const filtered = sold.filter(s => {
      const sid = (s.standId||"").toLowerCase();
      const c = (s.company||"").toLowerCase();
      return !q || sid.includes(q) || c.includes(q);
    });
    filtered.sort((a,b) => (a.company||"").localeCompare(b.company||"") || (a.standId||"").localeCompare(b.standId||""));
    const list = el("list");
    list.innerHTML = "";
    filtered.forEach(s => {
      const row = document.createElement("div");
      row.className = "row" + (state.selectedId && state.selectedId === s.standId ? " active" : "");
      row.innerHTML = `<div class="nm">${(s.company||"(No company)")}</div><div class="st">Stand ${s.standId}</div>`;
      row.addEventListener("click", () => selectStand(s.standId));
      list.appendChild(row);
    });
  }

  function clearOverlay() {
    const ov = el("overlay");
    ov.innerHTML = "";
  }

  function updateLabelAndPointer() {
    // Hide if nothing selected
    const box = el("labelBox");
    if (!state.selectedId || !state.svgRoot) {
      box.classList.add("hidden");
      clearOverlay();
      return;
    }

    const st = getStandById(state.selectedId) || {standId: state.selectedId, company: ""};
    el("labelStand").textContent = st.standId || state.selectedId;
    el("labelCompany").textContent = st.company || "";
    box.classList.remove("hidden");

    // Compute anchor points in screen pixels
    const standEl = state.svgDoc.getElementById(state.selectedId);
    if (!standEl || !standEl.getBBox) {
      clearOverlay();
      return;
    }

    // Get stand center in SVG coordinates then map to screen
    const bbox = standEl.getBBox();
    const cxSvg = bbox.x + bbox.width/2;
    const cySvg = bbox.y + bbox.height/2;

    // Map SVG coords -> screen coords:
    const pt = state.svgRoot.createSVGPoint();
    pt.x = cxSvg; pt.y = cySvg;
    const screenPt = pt.matrixTransform(standEl.getScreenCTM());

    const stageRect = el("planStage").getBoundingClientRect();
    const labelRect = box.getBoundingClientRect();

    const x1 = screenPt.x - stageRect.left;
    const y1 = screenPt.y - stageRect.top;

    // line starts at top-middle of label box
    const x2 = (labelRect.left + labelRect.width/2) - stageRect.left;
    const y2 = (labelRect.top) - stageRect.top;

    // Draw line + dot in overlay svg that spans stage+labelArea
    const ov = el("overlay");
    ov.setAttribute("width", stageRect.width);
    ov.setAttribute("height", stageRect.height + el("labelArea").getBoundingClientRect().height);
    ov.setAttribute("viewBox", `0 0 ${stageRect.width} ${stageRect.height + el("labelArea").getBoundingClientRect().height}`);

    ov.innerHTML = "";
    const ns = "http://www.w3.org/2000/svg";

    const line = document.createElementNS(ns, "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", x2); line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#111");
    line.setAttribute("stroke-width", "3");
    line.setAttribute("stroke-linecap", "round");
    ov.appendChild(line);

    const dot = document.createElementNS(ns, "circle");
    dot.setAttribute("cx", x1);
    dot.setAttribute("cy", y1);
    dot.setAttribute("r", "6");  // match admin
    dot.setAttribute("fill", "#111");
    dot.setAttribute("opacity", "0.85");
    ov.appendChild(dot);
  }

  function selectStand(id) {
    state.selectedId = String(id).toUpperCase();
    const st = getStandById(state.selectedId) || null;
    el("selStand").textContent = st ? st.standId : state.selectedId;
    if (st && st.company) {
      el("selCompany").style.display = "block";
      el("selCompany").textContent = st.company;
    } else {
      el("selCompany").style.display = "none";
      el("selCompany").textContent = "";
    }
    applyStandColors();
    renderList();
    // Defer pointer calc until layout stabilizes
    requestAnimationFrame(() => updateLabelAndPointer());
  }

  function clearSelection() {
    state.selectedId = null;
    el("selStand").textContent = "None";
    el("selCompany").style.display = "none";
    applyStandColors();
    renderList();
    updateLabelAndPointer();
  }

  async function loadSettings() {
    try {
      const s = await fetchJson("/settings");
      if (s && s.eventName) el("eventTitle").textContent = s.eventName;
      if (s && s.updatedAt) el("updated").textContent = s.updatedAt;
      else el("updated").textContent = "—";
    } catch(e) {
      // non-fatal
      el("updated").textContent = "—";
    }
  }

  async function loadStands() {
    const data = await fetchJson("/stands");
    if (!Array.isArray(data)) throw new Error("Backend returned unexpected data");
    // normalize
    state.stands = data.map(s => ({
      standId: String(s.standId||"").toUpperCase(),
      status: String(s.status||"").toLowerCase(),
      company: String(s.company||""),
    }));
  }

  async function init() {
    clearError();
    try {
      setStatus("Loading…", true);

      // Load SVG
      const obj = el("planObj");
      const {doc, svg} = await waitForSvgObject(obj);
      state.svgDoc = doc;
      state.svgRoot = svg;

      // Load backend data
      await Promise.all([loadSettings(), loadStands()]);

      applyStandColors();
      wireClicksDesktopOnly();
      renderList();

      setStatus("Ready ✅", true);
    } catch(err) {
      console.error(err);
      setStatus("Error loading ✗", false);
      showError("Failed to fetch/load from backend: " + state.backend + " (" + (err.message||err) + ")");
      // still show SVG if available
      try {
        if (!state.svgDoc) {
          const {doc, svg} = await waitForSvgObject(el("planObj"));
          state.svgDoc = doc; state.svgRoot = svg;
          applyStandColors();
          wireClicksDesktopOnly();
        }
      } catch(_) {}
    }
    updateLabelAndPointer();
  }

  // Recalculate pointer on resize/scroll (lightweight)
  let resizeTimer = null;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => updateLabelAndPointer(), 50);
  });
  window.addEventListener("scroll", () => {
    // only matters on mobile where address bar changes viewport
    if (state.isPhone) requestAnimationFrame(() => updateLabelAndPointer());
  }, {passive:true});

  el("search").addEventListener("input", renderList);
  el("clearBtn").addEventListener("click", clearSelection);
  el("exportBtn").addEventListener("click", () => window.print());

  // start
  init();
})();
</script>
</body>
</html>
