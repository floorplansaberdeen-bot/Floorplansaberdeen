<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{--border:#d9d9d9;--muted:#666;--sold:#e53935;--avail:#2ecc71;}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}
  header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px;}
  #status{font-size:13px;color:var(--muted);}
  #wrap{padding:12px;}
  #svgHost{border:1px solid var(--border);border-radius:8px;overflow:auto;min-height:420px;}
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none;user-select:none;}
  .legend{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px;font-size:13px;color:#333;}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 8px;border-radius:999px;background:#fff;}
  .dot{width:10px;height:10px;border-radius:50%;}
  .dot.sold{background:var(--sold);} .dot.avail{background:var(--avail);}
  #tooltip{position:fixed;display:none;z-index:9999;pointer-events:none;background:rgba(0,0,0,.85);color:#fff;padding:8px 10px;border-radius:8px;font-size:13px;white-space:pre-line;max-width:min(360px,85vw);} 
.soldSection{margin-top:14px;border:1px solid var(--border);border-radius:8px;padding:10px 12px;background:#fff;}
.soldHeader{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px;}
#soldSearch{flex:1;min-width:200px;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px;}
.soldList{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:6px;}
.soldItem{display:flex;gap:8px;align-items:center;border:1px solid #eee;border-radius:8px;padding:8px 10px;background:#fafafa;cursor:pointer;}
.soldItem:hover{background:#f0f3ff;border-color:#d7ddff;}
.soldItem.active{background:#eaf0ff;border-color:#b8c7ff;}
.soldName{font-weight:700;font-size:13px;line-height:1.2;}
.soldMeta{font-size:12px;color:var(--muted);}
.soldHint{margin-top:8px;font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<header>
  <strong>Exhibition Floorplan</strong>
  <span id="status">Loading…</span>
</header>

<div id="wrap">
  <div id="svgHost"></div>
  <div class="legend">
    <span class="pill"><span class="dot sold"></span>Sold</span>
    <span class="pill"><span class="dot avail"></span>Available</span>
  </div>

  <div class="soldSection">
    <div class="soldHeader">
      <strong>Sold exhibitors</strong>
      <input id="soldSearch" type="text" placeholder="Search company…" />
    </div>
    <div class="soldList" id="soldList"></div>
    <div class="soldHint">Click a company to highlight its stand with a label and pointer line.</div>
  </div>

</div>

<div id="tooltip"></div>

<script>
(() => {
  const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
  const SVG_URL = './event_plan.svg';
  const FILL_OPACITY = 0.75;
  const SYNC_INTERVAL_MS = 10000;

  const SOLD = '#e53935';
  const AVAIL = '#2ecc71';

  const elStatus = document.getElementById('status');
  const svgHost = document.getElementById('svgHost');
  const tooltip = document.getElementById('tooltip');
  const soldListEl = document.getElementById('soldList');
  const soldSearchEl = document.getElementById('soldSearch');

  let svgRoot = null;
  let byId = new Map();
  let calloutLayer = null;
  let activeCalloutStand = '';

  function setStatus(text, isError=false){
    elStatus.textContent = text;
    elStatus.style.color = isError ? '#b00020' : '#555';
  }
  function normalizeStatus(v){ return String(v||'').toLowerCase().trim()==='sold'?'sold':'available'; }
  function isStandId(id){ return /^[A-Za-z]{1,4}\d+$/.test(id); } // A1, AA1, SB10, AD18 etc.

  function tooltipText(info){
    const s = normalizeStatus(info.status);
    const lines=[info.standId, s==='sold'?'Sold':'Available'];
    if (s==='sold' && info.company) lines.push(info.company);
    return lines.join('\n');
  
  function svgEl(tag, attrs={}){
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (const [k,v] of Object.entries(attrs)) el.setAttribute(k, String(v));
    return el;
  }

  function ensureCalloutLayer(){
    if (!svgRoot) return;
    if (!calloutLayer){
      calloutLayer = svgEl('g', { id:'callouts' });
      svgRoot.appendChild(calloutLayer);
    }
  }

  function clearCallout(){
    activeCalloutStand = '';
    if (calloutLayer) calloutLayer.innerHTML = '';
    // clear active highlight in list
    if (soldListEl){
      soldListEl.querySelectorAll('.soldItem.active').forEach(x=>x.classList.remove('active'));
    }
  }

  function showCalloutFor(standId){
    ensureCalloutLayer();
    if (!calloutLayer) return;

    const info = byId.get(standId);
    if (!info) return;

    // Only meaningful for sold stands with a company name
    if (normalizeStatus(info.status) !== 'sold' || !info.company){
      clearCallout();
      return;
    }

    const node = svgRoot.querySelector(`#${CSS.escape(standId)}`);
    if (!node) return;

    let bbox;
    try { bbox = node.getBBox(); } catch { return; }
    const cx = bbox.x + bbox.width/2;
    const cy = bbox.y + bbox.height/2;

    // get overall bounds for safe label placement
    let vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
    let bounds = vb && vb.width ? {x:vb.x,y:vb.y,w:vb.width,h:vb.height} : null;
    if (!bounds){
      try{
        const b = svgRoot.getBBox();
        bounds = {x:b.x,y:b.y,w:b.width,h:b.height};
      }catch{
        bounds = {x:0,y:0,w:1000,h:1000};
      }
    }

    // choose label position (right by default, else left)
    const pad = 18;
    const labelXRight = bbox.x + bbox.width + 40;
    const labelXLeft  = bbox.x - 240;
    const labelY = Math.max(bounds.y + 20, Math.min(cy, bounds.y + bounds.h - 20));

    const labelX = (labelXRight + 220 <= bounds.x + bounds.w) ? labelXRight : Math.max(bounds.x + 20, labelXLeft);

    calloutLayer.innerHTML = '';

    // pointer line
    const line = svgEl('line', { x1:cx, y1:cy, x2:labelX, y2:labelY, stroke:'#111', 'stroke-width':2, 'stroke-linecap':'round' });
    line.style.opacity = '0.85';

    // label group
    const g = svgEl('g', {});
    const text = svgEl('text', { x:labelX, y:labelY, 'font-size':18, 'font-family':'Arial, Helvetica, sans-serif', 'font-weight':'700', fill:'#111' });
    text.textContent = info.company;

    // Add first so we can measure
    g.appendChild(text);
    calloutLayer.appendChild(line);
    calloutLayer.appendChild(g);

    const tb = text.getBBox();
    const rect = svgEl('rect', {
      x: tb.x - pad,
      y: tb.y - pad,
      width: tb.width + pad*2,
      height: tb.height + pad*2,
      rx: 10, ry: 10,
      fill: '#ffffff',
      stroke: '#111',
      'stroke-width': 2
    });
    rect.style.opacity = '0.92';

    // Put rect behind text
    g.insertBefore(rect, text);

    activeCalloutStand = standId;

    // mark active in list
    if (soldListEl){
      soldListEl.querySelectorAll('.soldItem').forEach(it=>{
        it.classList.toggle('active', it.dataset.standId === standId);
      });
    }
  }

  function renderSoldList(){
    if (!soldListEl) return;

    const q = String(soldSearchEl?.value || '').toLowerCase().trim();
    const sold = Array.from(byId.values())
      .filter(r => normalizeStatus(r.status)==='sold' && r.company)
      .sort((a,b)=>a.company.localeCompare(b.company));

    const filtered = q ? sold.filter(r => r.company.toLowerCase().includes(q) || r.standId.toLowerCase().includes(q)) : sold;

    soldListEl.innerHTML = '';
    if (!filtered.length){
      soldListEl.innerHTML = '<div style="color:#666;font-size:13px;padding:6px 2px;">No sold companies yet.</div>';
      return;
    }

    filtered.forEach(r=>{
      const item = document.createElement('div');
      item.className = 'soldItem' + (r.standId===activeCalloutStand ? ' active' : '');
      item.dataset.standId = r.standId;
      item.innerHTML = `<div>
          <div class="soldName">${escapeHtml(r.company)}</div>
          <div class="soldMeta">Stand ${escapeHtml(r.standId)}</div>
        </div>`;
      item.addEventListener('click', ()=>{
        if (activeCalloutStand === r.standId) clearCallout();
        else showCalloutFor(r.standId);
      });
      soldListEl.appendChild(item);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
}

  async function fetchJson(url){
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return await res.json();
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL,{cache:'no-store'});
    if(!res.ok) throw new Error('SVG not found at '+SVG_URL+' (HTTP '+res.status+')');
    svgHost.innerHTML = await res.text();
    svgRoot = svgHost.querySelector('svg');
    if(!svgRoot) throw new Error('SVG root <svg> not found');
  }

  function getStandNodes(){
    const groups = Array.from(svgRoot.querySelectorAll('g[id]'))
      .filter(g => isStandId(g.id));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]'))
      .filter(el => isStandId(el.id));
    // Merge by id (prefer group if exists)
    const map = new Map();
    groups.forEach(g => map.set(g.id, g));
    shapes.forEach(s => { if(!map.has(s.id)) map.set(s.id, s); });
    return Array.from(map.values());
  }

  function paintNode(node, status){
    const s = normalizeStatus(status);
    const color = s==='sold'?SOLD:AVAIL;
    const targets = (node.tagName.toLowerCase()==='g')
      ? node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line')
      : [node];
    targets.forEach(el=>{
      el.style.fill = color;
      el.style.fillOpacity = String(FILL_OPACITY);
      el.style.stroke = 'rgba(0,0,0,0.45)';
      el.style.strokeOpacity = '0.6';
      el.style.cursor = 'pointer';
    });
  }

  function bindNodeEvents(node){
    const id = String(node.id||'').trim();
    if(!id) return;
    const getInfo = () => byId.get(id) || {standId:id,status:'available',company:''};

    node.addEventListener('mousemove', e => {
      const info = getInfo();
      tooltip.textContent = tooltipText(info);
      tooltip.style.left = (e.clientX+12)+'px';
      tooltip.style.top = (e.clientY+12)+'px';
      tooltip.style.display='block';
    });
    node.addEventListener('mouseleave', ()=> tooltip.style.display='none');
  }

  function renderPlan(){
    getStandNodes().forEach(node => {
      const id = String(node.id||'').trim();
      const info = byId.get(id) || {standId:id,status:'available',company:''};
      paintNode(node, info.status);
    });
  }

  async function syncOnce(){
    try{
      const data = await fetchJson(API_BASE+'/stands?ts='+Date.now());
      byId = new Map((Array.isArray(data)?data:[]).map(r=>[
        String(r.standId).trim(),
        {standId:String(r.standId).trim(), status:normalizeStatus(r.status), company:String(r.company||'').trim()}
      ]));
      renderPlan();
      renderSoldList();
      // re-render callout if active (e.g. company/status changed)
      if (activeCalloutStand) showCalloutFor(activeCalloutStand);
      setStatus('Synced: '+new Date().toLocaleTimeString());
    }catch(e){
      setStatus('Sync error: '+e.message, true);
      console.error(e);
    }
  }

  (async()=>{
    try{
      setStatus('Loading…');
      await loadSvg();
      ensureCalloutLayer();
      if (soldSearchEl) soldSearchEl.addEventListener('input', renderSoldList);
      getStandNodes().forEach(bindNodeEvents);
      await syncOnce();
      setInterval(syncOnce, SYNC_INTERVAL_MS);
    }catch(e){
      setStatus('Load error: '+e.message, true);
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
