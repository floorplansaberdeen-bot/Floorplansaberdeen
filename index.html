<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Exhibition Floorplan</title>
<style>
  :root{
    --border:#e6e6e6;
    --muted:#666;
    --card:#fff;
    --shadow: 0 10px 25px rgba(0,0,0,.10);
    --selected:#e53935;
    --standRGB: 213,109,50;
  }

  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}

  header{
    padding:14px 16px;border-bottom:1px solid var(--border);
    display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap;
    background:#fff; position:sticky; top:0; z-index:30;
  }
  .titleWrap{display:grid;gap:4px}
  #eventName{font-size:26px;font-weight:900;line-height:1;}
  #updated{font-size:13px;color:var(--muted);}
  #status{font-size:14px;color:#0a7a2a;font-weight:700;}

  .topBtns{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{
    border:1px solid var(--border);background:#f8f8f8;border-radius:10px;
    padding:10px 14px;font-weight:800;cursor:pointer;font-size:14px;
  }
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .btn.primary{background:#fff;}

  /* Desktop layout */
  .layout{
    display:grid;grid-template-columns:2.3fr 1fr;gap:14px;
    padding:14px;
    align-items:start;
  }
  @media (max-width: 980px){ .layout{grid-template-columns:1fr;} }

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;}

  /* Sticky plan column (desktop) */
  .planCol{
    position:sticky;
    top:92px;
    align-self:start;
    z-index:10;
  }
  @media (max-width: 980px){ .planCol{ position:relative; top:auto; } }

  .planCard{position:relative;overflow:hidden;}
  #svgHost{
    overflow:auto;
    padding:12px;
    max-height: min(72vh, 760px);
  }
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none;user-select:none;}

  /* Legend lozenges - moved up a bit */
  .legend{
    position:absolute;left:50%;transform:translateX(-50%);
    bottom:10px;
    background:#fff;border:1px solid var(--border);border-radius:999px;
    padding:9px 12px;display:flex;gap:16px;align-items:center;
    box-shadow: var(--shadow);
    font-weight:800;
    z-index:5;
  }
  .dot{width:12px;height:12px;border-radius:50%;}
  .dot.stand{background:rgba(var(--standRGB),.75);}
  .dot.sel{background:var(--selected);}

  .side{display:grid;gap:12px;}
  .panelTitle{font-weight:900;margin:0 0 6px 0;}
  .selBox{
    border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;
  }
  #selStand{font-size:20px;font-weight:900;line-height:1.1;}
  #selCompany{font-size:18px;font-weight:800;margin-top:4px;}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35;}

  .listBox{border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden;}
  .listHead{padding:12px;border-bottom:1px solid var(--border);}
  #search{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;}

  /* list scroller */
  #list{
    max-height:520px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    /* IMPORTANT: bottom padding so last row isn’t hidden by browser bar */
    padding-bottom: calc(24px + env(safe-area-inset-bottom, 0px) + 70px);
  }

  .row{
    padding:10px 12px;border-bottom:1px solid #f0f0f0;cursor:pointer;
    display:grid;gap:2px;
  }
  .row:hover{background:#fafafa;}
  .row strong{font-size:14px;}
  .row small{color:var(--muted);font-weight:700;}
  .row.active{outline:2px solid rgba(0,0,0,.12);background:#fff;}

  /* Phone: fixed plan at top, list scrolls */
  @media (max-width: 600px){
    header{padding:12px 12px;}
    #eventName{font-size:22px;}

    /* fixed regions */
    body{height:100vh;overflow:hidden;}

    .layout{
      height:calc(100vh - 86px); /* header */
      padding:10px;
      display:grid;
      grid-template-columns:1fr;
      grid-template-rows:auto 1fr; /* plan then list */
      gap:10px;
      overflow:hidden;
    }

    /* plan fixed at top */
    .planCol{position:relative;top:auto;}
    .planCard{
      height:44vh;               /* ✅ less dead white space than before */
      display:flex;
      flex-direction:column;
    }

    #svgHost{
      flex:1;
      max-height:none;
      padding:10px;
      overflow:auto;
    }

    .legend{bottom:12px;}

    /* hide extra panels on phone to save space */
    .side{height:100%;overflow:hidden;}
    .side .selBox{display:none;}

    .listBox{
      height:100%;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #list{
      flex:1;
      max-height:none;
      overflow:auto;
      padding-bottom: calc(28px + env(safe-area-inset-bottom, 0px) + 90px); /* ✅ extra bottom padding */
    }
  }
</style>
</head>
<body>

<header>
  <div class="titleWrap">
    <div id="eventName">Loading…</div>
    <div id="updated">Updated: —</div>
    <div id="status">Loading…</div>
  </div>

  <div class="topBtns">
    <button class="btn primary" id="btnPdf">Export PDF</button>
    <button class="btn" id="btnClear">Clear</button>
  </div>
</header>

<div class="layout">
  <!-- Plan -->
  <div class="planCol">
    <div class="card planCard">
      <div id="svgHost"></div>

      <div class="legend" aria-hidden="true">
        <span style="display:flex;align-items:center;gap:8px;"><span class="dot stand"></span>Stands</span>
        <span style="display:flex;align-items:center;gap:8px;"><span class="dot sel"></span>Selected</span>
      </div>
    </div>
  </div>

  <!-- List -->
  <div class="side">
    <div class="selBox">
      <div class="panelTitle">Selected exhibitor</div>
      <div id="selStand">None</div>
      <div id="selCompany"></div>
      <div class="hint">
        Desktop: click a stand or choose from the list.<br>
        Phone: use the list.
      </div>
    </div>

    <div class="listBox">
      <div class="listHead">
        <div class="panelTitle">Sold exhibitors</div>
        <input id="search" placeholder="Search company or stand…" />
      </div>
      <div id="list"></div>
    </div>

    <div class="selBox">
      <div class="panelTitle">Help</div>
      <div class="hint">Selecting an exhibitor makes their stand red with label + line.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(() => {
  const API_BASE = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const SVG_URL  = "./event_plan.svg";

  const STAND_FILL_RGB = "213,109,50";
  const STAND_OPACITY  = 0.75;
  const SELECTED_FILL  = "#e53935";

  const STAND_ID_RE = /^([A-Z]{1,3})(\d{1,3})$/;
  const isPhone = matchMedia("(max-width: 600px)").matches;

  const elEvent  = document.getElementById("eventName");
  const elUpdated= document.getElementById("updated");
  const elStatus = document.getElementById("status");

  const svgHost  = document.getElementById("svgHost");
  const listEl   = document.getElementById("list");
  const searchEl = document.getElementById("search");

  const btnClear = document.getElementById("btnClear");
  const btnPdf   = document.getElementById("btnPdf");

  let svgRoot = null;
  let calloutG = null;

  let stands = [];
  let byId = new Map();
  let selectedId = "";

  function setStatus(txt, ok=true){
    elStatus.textContent = txt;
    elStatus.style.color = ok ? "#0a7a2a" : "#b00020";
  }

  function normalizeStatus(v){
    const s = String(v||"").toLowerCase().trim();
    return (s === "sold" || s === "booked" || s === "reserved") ? "sold" : "available";
  }

  function isStandId(id){ return STAND_ID_RE.test(String(id||"").trim()); }

  function pick(obj, keys, fallback=""){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
    }
    return fallback;
  }

  function normalizeRow(r){
    const standId = String(pick(r, ["standId","Stand","stand","id","ID","stand_id"], "")).trim();
    const status  = normalizeStatus(pick(r, ["status","Status","state","State"], "available"));
    const company = String(pick(r, ["company","Company","exhibitor","Exhibitor","name","Name","soldTo","SoldTo"], "")).trim();
    return { standId, status, company };
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache:"no-store" });
    const text = await res.text();
    const json = JSON.parse(text);
    if(!res.ok) throw new Error("HTTP "+res.status);
    return json;
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("SVG not found: "+SVG_URL+" (HTTP "+res.status+")");
    svgHost.innerHTML = await res.text();
    svgRoot = svgHost.querySelector("svg");
    if(!svgRoot) throw new Error("SVG missing <svg> root");

    // keep plan clean (remove any text labels exported with svg)
    svgRoot.querySelectorAll("text,tspan").forEach(t=>t.remove());

    calloutG = document.createElementNS("http://www.w3.org/2000/svg", "g");
    calloutG.setAttribute("id","__callout");
    svgRoot.appendChild(calloutG);
  }

  function getStandNodes(){
    const shapes = Array.from(svgRoot.querySelectorAll("path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]"))
      .filter(el => isStandId(el.id));
    if (shapes.length) return shapes;
    return Array.from(svgRoot.querySelectorAll("g[id]")).filter(g=>isStandId(g.id));
  }

  function paintStandNode(node, isSelected){
    const targets = (node.tagName.toLowerCase()==="g")
      ? node.querySelectorAll("path,rect,polygon,circle,ellipse,polyline,line")
      : [node];

    const fill = isSelected ? SELECTED_FILL : `rgb(${STAND_FILL_RGB})`;
    const op   = isSelected ? "0.88" : String(STAND_OPACITY);

    targets.forEach(el=>{
      el.style.fill = fill;
      el.style.fillOpacity = op;
      el.style.stroke = "rgba(0,0,0,0.45)";
      el.style.strokeOpacity = "0.6";
      el.style.cursor = isPhone ? "default" : "pointer";
    });
  }

  function repaintAll(){
    if(!svgRoot) return;
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      paintStandNode(node, id === selectedId);
    });
  }

  function standBBox(standId){
    const node = svgRoot.querySelector("#"+CSS.escape(standId));
    if(!node) return null;
    try{ return node.getBBox(); }catch(_){ return null; }
  }

  function getViewBox(){
    let vb = svgRoot.viewBox && svgRoot.viewBox.baseVal ? svgRoot.viewBox.baseVal : null;
    if(!vb || !vb.width){
      try{
        const rootBB = svgRoot.getBBox();
        svgRoot.setAttribute("viewBox", `${rootBB.x} ${rootBB.y} ${rootBB.width} ${rootBB.height}`);
        vb = svgRoot.viewBox.baseVal;
      }catch(_){
        vb = {x:0,y:0,width:1000,height:700};
      }
    }
    return vb;
  }

  function clearCallout(){
    if(calloutG) calloutG.innerHTML = "";
  }

  // Smart callout placement (inside SVG) but avoids the bottom legend area on phone
  function chooseCalloutPosition(bb){
    const vb = getViewBox();

    const w = isPhone ? 260 : 320;
    const h = isPhone ? 92  : 104;

    const pad = 18;
    const standCx = bb.x + bb.width/2;

    // Put label ABOVE the plan on phone more often (reduces "dead space" feeling)
    // but clamp within viewBox.
    const preferTop = isPhone;

    const x = Math.max(vb.x + pad, Math.min(standCx - w/2, vb.x + vb.width - w - pad));

    // y candidates: above stand or below stand
    const yAbove = bb.y - h - 22;
    const yBelow = bb.y + bb.height + 22;

    // On phone: try above first, else below, else clamp
    let y = preferTop ? yAbove : yBelow;

    // Avoid going off top
    if (y < vb.y + pad) y = yBelow;

    // Avoid colliding with legend bottom area (approx)
    // Keep callout away from bottom 120 units of viewBox (legend zone)
    const legendZoneTop = (vb.y + vb.height) - (isPhone ? 160 : 130);
    if (y + h > legendZoneTop) y = Math.min(yAbove, legendZoneTop - h - 10);

    // Final clamp
    y = Math.max(vb.y + pad, Math.min(y, vb.y + vb.height - h - pad));

    return {x,y,w,h};
  }

  function drawCallout(standId){
    clearCallout();
    if(!standId) return;

    const info = byId.get(standId) || { standId, company:"" };
    const bb = standBBox(standId);
    if(!bb) return;

    const box = chooseCalloutPosition(bb);

    const standCx = bb.x + bb.width/2;
    const standCy = bb.y + bb.height/2;

    // anchor point on box (bottom-center if box above, else top-center)
    const boxCenterX = box.x + box.w/2;
    const boxIsAbove = box.y < bb.y;

    const ax = boxCenterX;
    const ay = boxIsAbove ? (box.y + box.h) : box.y;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", ax);
    line.setAttribute("y1", ay);
    line.setAttribute("x2", standCx);
    line.setAttribute("y2", standCy);
    line.setAttribute("stroke", "rgba(0,0,0,.75)");
    line.setAttribute("stroke-width", isPhone ? "6" : "4");
    line.setAttribute("stroke-linecap","round");

    const pin = document.createElementNS("http://www.w3.org/2000/svg","circle");
    pin.setAttribute("cx", standCx);
    pin.setAttribute("cy", standCy);
    pin.setAttribute("r", isPhone ? "16" : "12");
    pin.setAttribute("fill", "rgba(0,0,0,.75)");

    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute("x", box.x);
    rect.setAttribute("y", box.y);
    rect.setAttribute("width", box.w);
    rect.setAttribute("height", box.h);
    rect.setAttribute("rx", "16");
    rect.setAttribute("ry", "16");
    rect.setAttribute("fill", SELECTED_FILL);
    rect.setAttribute("fill-opacity","0.95");
    rect.style.filter = "drop-shadow(0px 10px 16px rgba(0,0,0,.22))";

    const t1 = document.createElementNS("http://www.w3.org/2000/svg","text");
    t1.setAttribute("x", box.x + box.w/2);
    t1.setAttribute("y", box.y + (isPhone ? 42 : 46));
    t1.setAttribute("text-anchor","middle");
    t1.setAttribute("fill","#fff");
    t1.style.fontFamily = "Arial, Helvetica, sans-serif";
    t1.style.fontWeight = "900";
    t1.style.fontSize = isPhone ? "28px" : "34px";
    t1.textContent = info.standId;

    const company = (info.company || "").trim();
    if(company){
      const t2 = document.createElementNS("http://www.w3.org/2000/svg","text");
      t2.setAttribute("x", box.x + box.w/2);
      t2.setAttribute("y", box.y + (isPhone ? 74 : 82));
      t2.setAttribute("text-anchor","middle");
      t2.setAttribute("fill","#fff");
      t2.style.fontFamily = "Arial, Helvetica, sans-serif";
      t2.style.fontWeight = "800";
      t2.style.fontSize = isPhone ? "16px" : "18px";
      t2.textContent = company;
      calloutG.appendChild(t2);
    }

    calloutG.appendChild(line);
    calloutG.appendChild(pin);
    calloutG.appendChild(rect);
    calloutG.appendChild(t1);
  }

  function setSelected(standId){
    selectedId = standId || "";
    if(!selectedId){
      clearCallout();
      repaintAll();
      renderList();
      return;
    }
    repaintAll();
    renderList();
    drawCallout(selectedId);
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function renderList(){
    const q = String(searchEl.value||"").toLowerCase().trim();

    const sold = stands
      .filter(s => normalizeStatus(s.status)==="sold")
      .map(s => ({ standId: s.standId, company: s.company }))
      .sort((a,b) => (a.company||a.standId).localeCompare((b.company||b.standId)));

    const filtered = !q ? sold : sold.filter(x =>
      (x.company||"").toLowerCase().includes(q) || x.standId.toLowerCase().includes(q)
    );

    listEl.innerHTML = "";
    filtered.forEach(item=>{
      const row = document.createElement("div");
      row.className = "row" + (item.standId===selectedId ? " active":"");
      const title = item.company ? escapeHtml(item.company) : `<em style="font-weight:900;">(No company)</em>`;
      row.innerHTML = `<strong>${title}</strong><small>Stand ${escapeHtml(item.standId)}</small>`;
      row.addEventListener("click", ()=>{
        setSelected(item.standId);
      });
      listEl.appendChild(row);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.padding = "12px";
      empty.style.color = "#777";
      empty.textContent = "No sold stands found.";
      listEl.appendChild(empty);
    }
  }

  async function sync(){
    try{
      const settings = await fetchJson(API_BASE + "/settings?ts=" + Date.now());
      elEvent.textContent = (settings && settings.eventName) ? settings.eventName : "New Event";
    }catch(_){
      elEvent.textContent = "New Event";
    }

    const raw = await fetchJson(API_BASE + "/stands?ts=" + Date.now());
    const arr = Array.isArray(raw) ? raw : [];
    stands = arr.map(normalizeRow).filter(r => r.standId);

    byId = new Map(stands.map(s => [s.standId, s]));
    elUpdated.textContent = "Updated: " + new Date().toLocaleTimeString();

    renderList();

    if(selectedId && !byId.has(selectedId)) selectedId = "";
    repaintAll();
    if(selectedId) drawCallout(selectedId);
  }

  function bindStandClick(){
    if(isPhone) return; // phone uses list
    getStandNodes().forEach(node=>{
      const id = String(node.id||"").trim();
      node.addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        setSelected(id);
      });
    });
  }

  async function exportPdf(){
    try{
      btnPdf.disabled = true;
      setStatus("Preparing PDF…", true);

      const svg = svgRoot.cloneNode(true);
      svg.removeAttribute("width");
      svg.removeAttribute("height");

      const svgText = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([svgText], { type:"image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const img = new Image();
      img.crossOrigin = "anonymous";
      await new Promise((resolve,reject)=>{
        img.onload = resolve;
        img.onerror = reject;
        img.src = url;
      });

      const canvas = document.createElement("canvas");
      const w = img.width || 1600;
      const h = img.height || 900;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: w >= h ? "landscape" : "portrait",
        unit: "pt",
        format: [w, h]
      });

      const dataUrl = canvas.toDataURL("image/png");
      pdf.addImage(dataUrl, "PNG", 0, 0, w, h);
      pdf.save((elEvent.textContent || "floorplan") + ".pdf");

      setStatus("Ready ✅", true);
    }catch(e){
      console.error(e);
      setStatus("PDF export failed", false);
    }finally{
      btnPdf.disabled = false;
    }
  }

  (async ()=>{
    try{
      setStatus("Loading…", true);
      await loadSvg();
      await sync();
      bindStandClick();
      setSelected("");
      repaintAll();
      setStatus("Ready ✅", true);
      setInterval(()=>sync().catch(()=>{}), 15000);
    }catch(e){
      console.error(e);
      setStatus("Load error", false);
      elEvent.textContent = "New Event";
    }
  })();

  searchEl.addEventListener("input", renderList);
  btnClear.addEventListener("click", ()=>setSelected(""));
  btnPdf.addEventListener("click", exportPdf);

})();
</script>
</body>
</html>
