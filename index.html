<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Exhibition Floorplan</title>
<style>
  :root{
    --border:#d9d9d9;
    --muted:#666;

    /* Main stand colour (available) */
    --standMain: rgba(213, 109, 50, 0.75);

    /* Selected stand colour */
    --selected: #e53935;

    --cardRadius: 18px;
  }

  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}
  header{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
  }
  .titleWrap{display:flex;flex-direction:column;gap:6px;}
  #eventTitle{font-size:28px;font-weight:900;line-height:1.05;}
  #updated{font-size:13px;color:var(--muted);}
  #ready{font-size:14px;font-weight:900;display:inline-flex;align-items:center;gap:8px;}
  #ready .tick{font-size:18px}

  .topBtns{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
  .btn{
    padding:10px 14px;border:1px solid var(--border);background:#f7f7f7;border-radius:12px;
    font-weight:900;cursor:pointer;
  }
  .btn:disabled{opacity:.55;cursor:not-allowed;}

  .layout{
    display:grid;
    grid-template-columns: 2.2fr 1fr;
    gap:12px;
    padding:12px;
  }
  @media (max-width: 900px){
    .layout{grid-template-columns:1fr;}
  }

  .card{
    border:1px solid var(--border);
    border-radius: var(--cardRadius);
    background:#fff;
    overflow:hidden;
  }

  /* PLAN CARD */
  .planCardInner{position:relative;}
  #svgHost{
    min-height:520px;
    overflow:hidden;
    position:relative;
  }
  #svgHost svg{width:100%;height:auto;display:block;}
  svg text, svg tspan{pointer-events:none; user-select:none;}

  /* Overlay for label + line (HTML overlay) */
  #overlay{
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index:10;
  }
  #pinDot{
    position:absolute;
    width:12px;height:12px;border-radius:50%;
    background:#111;
    transform:translate(-50%,-50%);
    display:none;
  }
  #pinLine{
    position:absolute;
    left:0; top:0;
    width:100%; height:100%;
    display:none;
  }

  /* Label box */
  #labelBox{
    position:absolute;
    min-width:220px;
    max-width:min(420px, 85vw);
    border-radius:16px;
    background: var(--selected);
    color:#fff;
    padding:18px 22px;
    box-shadow: 0 16px 38px rgba(0,0,0,0.22);
    transform: translate(-50%, -50%);
    display:none;
  }
  #labelStand{
    font-size:34px;
    font-weight:1000;
    line-height:1.0;
    letter-spacing:0.5px;
    margin-bottom:8px;
  }
  #labelCompany{
    font-size:22px;
    font-weight:900;
    opacity:0.95;
    line-height:1.15;
  }

  /* Make label smaller on phones */
  @media (max-width: 600px){
    #labelBox{ min-width:200px; padding:14px 16px; border-radius:14px; }
    #labelStand{ font-size:28px; }
    #labelCompany{ font-size:18px; }
  }

  /* Legend lozenge */
  .legend{
    position:absolute;
    left:50%;
    bottom:14px;
    transform:translateX(-50%);
    background:#fff;
    border:1px solid var(--border);
    border-radius:999px;
    padding:10px 14px;
    display:flex;
    gap:18px;
    align-items:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.08);
    z-index:6;
  }
  .legItem{display:flex;align-items:center;gap:8px;font-weight:900;font-size:14px;}
  .dot{width:12px;height:12px;border-radius:50%;}
  .dot.main{background: rgba(213, 109, 50, 0.95);}
  .dot.sel{background: var(--selected);}

  /* On phones, lift legend a bit so it never gets cut off */
  @media (max-width: 600px){
    .legend{bottom:22px;}
  }

  /* SIDE PANEL */
  .panel{padding:12px; display:grid; gap:12px;}
  .panelCard{
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px;
    background:#fff;
  }
  .panelCard h3{margin:0 0 8px 0; font-size:14px; font-weight:1000;}
  .selBig{font-size:28px;font-weight:1000;margin-top:6px;}
  .selSmall{font-size:18px;font-weight:900;margin-top:2px;color:#222;}
  .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px;}

  .search{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    font-size:14px;
  }
  .list{
    border:1px solid var(--border);
    border-radius:16px;
    overflow:auto;
    max-height:480px;
    background:#fff;
  }
  .item{
    padding:10px 12px;
    border-bottom:1px solid #eee;
    cursor:pointer;
  }
  .item:last-child{border-bottom:0;}
  .item:hover{background:#fafafa;}
  .item .name{font-weight:1000;}
  .item .sub{font-size:12px;color:var(--muted);margin-top:2px;}
  .item.selected{background:#fff3f3;}

  /* Phone layout: keep plan visible at top */
  @media (max-width: 600px){
    header{position:sticky; top:0; background:#fff; z-index:50;}
    .planSticky{
      position: sticky;
      top: 84px; /* header height-ish */
      z-index:20;
      background:#fff;
    }
    #svgHost{min-height:420px;}
    .list{max-height:320px;}
  }

  /* Print for PDF */
  @media print{
    header, .panel, .btn, .legend{display:none !important;}
    .layout{grid-template-columns:1fr; padding:0;}
    .card{border:0;}
    #svgHost{min-height:auto;}
  }
</style>
</head>

<body>
<header>
  <div class="titleWrap">
    <div id="eventTitle">Loading…</div>
    <div id="updated">Updated: —</div>
    <div id="ready"><span>Ready</span> <span class="tick">✅</span></div>
  </div>
  <div class="topBtns">
    <button class="btn" id="btnPdf">Export PDF</button>
    <button class="btn" id="btnClear" disabled>Clear selection</button>
  </div>
</header>

<div class="layout">
  <div class="card planCardInner planSticky">
    <div id="svgHost">
      <div id="overlay">
        <svg id="pinLine"></svg>
        <div id="pinDot"></div>
        <div id="labelBox">
          <div id="labelStand"></div>
          <div id="labelCompany"></div>
        </div>
      </div>

      <div class="legend" id="legend">
        <div class="legItem"><span class="dot main"></span>Stands</div>
        <div class="legItem"><span class="dot sel"></span>Selected</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="panel">
      <div class="panelCard">
        <h3>Selected exhibitor</h3>
        <div class="selBig" id="selStand">None</div>
        <div class="selSmall" id="selCompany"></div>
        <div class="hint">
          Desktop: click a stand or choose from the list.<br>
          Phone: use the list (stand tapping is disabled).
        </div>
      </div>

      <div class="panelCard">
        <h3>Sold exhibitors</h3>
        <input class="search" id="search" placeholder="Search company or stand…" />
        <div class="list" id="list"></div>
      </div>

      <div class="panelCard">
        <h3>Help</h3>
        <div class="hint">All stands are in the main colour. Selecting an exhibitor makes their stand red with a label + line.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  /* Safari compatibility: CSS.escape polyfill */
  if (!window.CSS) window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (value) {
      return String(value).replace(/[^a-zA-Z0-9_\-]/g, function (ch) {
        const hex = ch.codePointAt(0).toString(16).toUpperCase();
        return '\\' + hex + ' ';
      });
    };
  }

  const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
  const SVG_URL  = './event_plan.svg';
  const SYNC_MS  = 15000;

  const MAIN_RGB = 'rgb(213, 109, 50)';
  const MAIN_OP  = 0.75;
  const SELECTED = '#e53935';

  const isPhone = matchMedia('(max-width: 600px)').matches;

  const elEvent   = document.getElementById('eventTitle');
  const elUpdated = document.getElementById('updated');
  const btnClear  = document.getElementById('btnClear');
  const btnPdf    = document.getElementById('btnPdf');

  const svgHost   = document.getElementById('svgHost');
  const overlay   = document.getElementById('overlay');
  const pinDot    = document.getElementById('pinDot');
  const pinLine   = document.getElementById('pinLine');
  const labelBox  = document.getElementById('labelBox');
  const labelStand= document.getElementById('labelStand');
  const labelCompany = document.getElementById('labelCompany');

  const selStand  = document.getElementById('selStand');
  const selCompany= document.getElementById('selCompany');

  const searchEl  = document.getElementById('search');
  const listEl    = document.getElementById('list');

  let svgRoot = null;
  let standData = []; // array of {standId,status,company}
  let byId = new Map();
  let selectedId = '';

  function normalizeStatus(v){
    return String(v||'').toLowerCase().trim() === 'sold' ? 'sold' : 'available';
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache:'no-store' });
    const text = await res.text();
    let json = null;
    try{ json = JSON.parse(text); }catch{}
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return json;
  }

  async function loadSvg(){
    const res = await fetch(SVG_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('SVG not found: ' + SVG_URL);
    svgHost.insertAdjacentHTML('afterbegin', await res.text());
    svgRoot = svgHost.querySelector('svg');
    if(!svgRoot) throw new Error('SVG root not found');
    svgRoot.style.userSelect = 'none';
  }

  function getStandNodes(){
    if(!svgRoot) return [];
    // Prefer g[id], else shapes
    const groups = Array.from(svgRoot.querySelectorAll('g[id]'));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]'));

    const exists = id => byId.has(String(id||'').trim());
    const g = groups.filter(n => exists(n.id));
    if(g.length) return g;
    return shapes.filter(n => exists(n.id));
  }

  function paintNode(node, fillRgb, opacity){
    const targets = (node.tagName.toLowerCase()==='g')
      ? node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line')
      : [node];

    targets.forEach(el=>{
      el.style.fill = fillRgb;
      el.style.fillOpacity = String(opacity);
      el.style.stroke = 'rgba(0,0,0,0.45)';
      el.style.strokeOpacity = '0.6';
    });
  }

  function renderPlan(){
    const nodes = getStandNodes();
    nodes.forEach(node=>{
      paintNode(node, MAIN_RGB, MAIN_OP);
    });

    // Then selected stand in red
    if(selectedId && byId.has(selectedId)){
      const selNode = svgRoot.querySelector('#' + CSS.escape(selectedId));
      if(selNode){
        paintNode(selNode, SELECTED, 0.80);
      }
    }
  }

  function renderList(){
    const q = String(searchEl.value||'').toLowerCase().trim();
    const sold = standData
      .filter(s => normalizeStatus(s.status)==='sold')
      .filter(s => (s.company||'').trim().length > 0)
      .sort((a,b)=>(a.company||'').localeCompare(b.company||'', undefined, {numeric:true}));

    const filtered = sold.filter(s=>{
      if(!q) return true;
      return s.standId.toLowerCase().includes(q) || (s.company||'').toLowerCase().includes(q);
    });

    listEl.innerHTML = '';
    if(!filtered.length){
      const d = document.createElement('div');
      d.className = 'item';
      d.style.cursor = 'default';
      d.textContent = 'No exhibitors found.';
      listEl.appendChild(d);
      return;
    }

    filtered.forEach(s=>{
      const div = document.createElement('div');
      div.className = 'item' + (s.standId===selectedId ? ' selected' : '');
      div.innerHTML = `<div class="name">${escapeHtml(s.company)}</div><div class="sub">Stand ${escapeHtml(s.standId)}</div>`;
      div.addEventListener('click', ()=> selectStand(s.standId));
      listEl.appendChild(div);
    });
  }

  function escapeHtml(str){
    return String(str||'').replace(/[&<>"']/g, (m)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }

  function clearSelection(){
    selectedId = '';
    btnClear.disabled = true;
    selStand.textContent = 'None';
    selCompany.textContent = '';
    hideLabel();
    renderPlan();
    renderList();
  }

  function hideLabel(){
    pinDot.style.display = 'none';
    pinLine.style.display = 'none';
    labelBox.style.display = 'none';
    pinLine.innerHTML = '';
  }

  function selectStand(id){
    id = String(id||'').trim();
    if(!id || !byId.has(id)) return;

    selectedId = id;
    btnClear.disabled = false;

    const info = byId.get(id);
    selStand.textContent = info.standId;
    selCompany.textContent = info.company || '';

    renderPlan();
    renderList();
    drawLabelSmart(id, info.company || '');
  }

  function getNodeBBoxInClient(id){
    const node = svgRoot.querySelector('#' + CSS.escape(id));
    if(!node) return null;

    let bb;
    try{ bb = node.getBBox(); }catch{ return null; }

    const ctm = node.getScreenCTM();
    if(!ctm) return null;

    // Convert SVG bb corners to screen coords
    const p = svgRoot.createSVGPoint();
    function xform(x,y){
      p.x=x; p.y=y;
      const sp = p.matrixTransform(ctm);
      return {x: sp.x, y: sp.y};
    }
    const a = xform(bb.x, bb.y);
    const b = xform(bb.x + bb.width, bb.y);
    const c = xform(bb.x + bb.width, bb.y + bb.height);
    const d = xform(bb.x, bb.y + bb.height);

    const xs = [a.x,b.x,c.x,d.x], ys=[a.y,b.y,c.y,d.y];
    const left = Math.min(...xs), right=Math.max(...xs);
    const top = Math.min(...ys), bottom=Math.max(...ys);

    return {
      left, top, right, bottom,
      cx: (left+right)/2,
      cy: (top+bottom)/2
    };
  }

  function drawLabelSmart(id, company){
    const bb = getNodeBBoxInClient(id);
    if(!bb){ hideLabel(); return; }

    labelStand.textContent = id;
    labelCompany.textContent = company;

    // ensure box is measurable
    labelBox.style.display = 'block';
    labelBox.style.left = '0px';
    labelBox.style.top  = '0px';

    // Convert plan container bounds
    const hostRect = svgHost.getBoundingClientRect();

    // Candidate label positions (screen coords)
    const pad = isPhone ? 22 : 28;
    const candidates = [
      { name:'bottom', x: bb.cx, y: bb.bottom + pad },
      { name:'left',   x: bb.left - pad, y: bb.cy },
      { name:'right',  x: bb.right + pad, y: bb.cy },
      { name:'top',    x: bb.cx, y: bb.top - pad }
    ];

    const boxW = labelBox.offsetWidth;
    const boxH = labelBox.offsetHeight;

    function score(pos){
      // compute label box rect at this pos (centered)
      const L = pos.x - boxW/2, R = pos.x + boxW/2;
      const T = pos.y - boxH/2, B = pos.y + boxH/2;

      // heavy penalty if outside host
      let penalty = 0;
      if(L < hostRect.left) penalty += (hostRect.left - L) * 10;
      if(R > hostRect.right) penalty += (R - hostRect.right) * 10;
      if(T < hostRect.top) penalty += (hostRect.top - T) * 10;
      if(B > hostRect.bottom) penalty += (B - hostRect.bottom) * 10;

      // penalty if overlaps stand bbox
      const overlap =
        !(R < bb.left || L > bb.right || B < bb.top || T > bb.bottom);
      if(overlap) penalty += 20000;

      // slight preference for bottom
      if(pos.name === 'bottom') penalty -= 300;

      // prefer closer
      const dx = pos.x - bb.cx, dy = pos.y - bb.cy;
      penalty += (dx*dx + dy*dy) * 0.01;

      return penalty;
    }

    candidates.sort((a,b)=>score(a)-score(b));
    const best = candidates[0];

    // clamp best to host bounds (keep inside)
    let x = best.x, y = best.y;
    x = Math.max(hostRect.left + boxW/2 + 8, Math.min(hostRect.right - boxW/2 - 8, x));
    y = Math.max(hostRect.top + boxH/2 + 8, Math.min(hostRect.bottom - boxH/2 - 8, y));

    // Place label in overlay coordinates (relative to svgHost)
    const relX = x - hostRect.left;
    const relY = y - hostRect.top;
    labelBox.style.left = relX + 'px';
    labelBox.style.top  = relY + 'px';

    // Pin dot at stand center (relative)
    const dotX = bb.cx - hostRect.left;
    const dotY = bb.cy - hostRect.top;
    pinDot.style.left = dotX + 'px';
    pinDot.style.top  = dotY + 'px';
    pinDot.style.display = 'block';

    // Draw line (SVG in overlay)
    pinLine.setAttribute('viewBox', `0 0 ${hostRect.width} ${hostRect.height}`);
    pinLine.setAttribute('preserveAspectRatio','none');
    pinLine.innerHTML = '';

    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', dotX);
    line.setAttribute('y1', dotY);
    line.setAttribute('x2', relX);
    line.setAttribute('y2', relY);
    line.setAttribute('stroke', '#111');
    line.setAttribute('stroke-width', isPhone ? '6' : '4');
    line.setAttribute('stroke-linecap','round');
    line.setAttribute('opacity','0.8');

    pinLine.appendChild(line);
    pinLine.style.display = 'block';
  }

  function bindStandClicks(){
    // Phone: disable stand tapping
    if(isPhone) return;

    getStandNodes().forEach(node=>{
      node.style.cursor = 'pointer';
      node.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        const id = String(node.id||'').trim();
        if(byId.has(id)) selectStand(id);
      });
    });
  }

  async function syncData(){
    const data = await fetchJson(API_BASE + '/stands?ts=' + Date.now());
    standData = Array.isArray(data) ? data : [];
    byId = new Map(standData.map(s=>[String(s.standId||'').trim(), {
      standId:String(s.standId||'').trim(),
      status:normalizeStatus(s.status),
      company:String(s.company||'').trim()
    }]).filter(([k])=>k));

    renderPlan();
    renderList();

    // keep selection alive
    if(selectedId && byId.has(selectedId)){
      const info = byId.get(selectedId);
      selStand.textContent = info.standId;
      selCompany.textContent = info.company || '';
      drawLabelSmart(selectedId, info.company || '');
    } else if(selectedId && !byId.has(selectedId)){
      clearSelection();
    }

    elUpdated.textContent = 'Updated: ' + new Date().toLocaleTimeString();
  }

  async function loadSettings(){
    try{
      const s = await fetchJson(API_BASE + '/settings?ts=' + Date.now());
      const name = (s && typeof s.eventName === 'string') ? s.eventName : 'New Event';
      elEvent.textContent = name;
    }catch{
      elEvent.textContent = 'New Event';
    }
  }

  btnClear.addEventListener('click', clearSelection);

  // Export PDF: use print-to-PDF (reliable)
  btnPdf.addEventListener('click', ()=>{
    window.print();
  });

  searchEl.addEventListener('input', renderList);

  // Reposition label on resize/orientation
  window.addEventListener('resize', ()=>{
    if(selectedId && byId.has(selectedId)){
      const info = byId.get(selectedId);
      drawLabelSmart(selectedId, info.company || '');
    }
  });

  (async ()=>{
    try{
      await loadSettings();
      await loadSvg();
      await syncData();
      bindStandClicks();
      setInterval(syncData, SYNC_MS);
    }catch(e){
      elEvent.textContent = 'Load error';
      console.error(e);
    }
  })();

})();
</script>
</body>
</html>
