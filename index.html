<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Exhibition Floorplan</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border: rgba(0,0,0,.10);
      --text:#111;
      --muted: rgba(0,0,0,.62);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --stand: rgba(213,109,50,0.75);
      --selected: #e53935;
      --line: rgba(0,0,0,.65);
      --dot: rgba(0,0,0,.75);
      --radius: 14px;
      --labelWDesktop: 260px;
      --labelWPhone: 200px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:var(--bg);
    }
    header{
      padding:16px 16px 8px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .titleWrap{min-width:260px}
    h1{margin:0; font-size:40px; line-height:1.05; letter-spacing:-.02em}
    .meta{margin-top:6px; color:var(--muted); font-size:14px}
    .status{margin-top:6px; font-weight:700; color:#1b5e20}
    .actions{display:flex; gap:10px; align-items:center}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .btn:active{transform: translateY(1px)}
    .layout{
      padding: 0 16px 16px;
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .planCard{
      padding:12px;
      position:relative;
      overflow:hidden;
      min-height: 520px;
    }
    .planHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 8px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      margin: -12px -12px 12px;
    }
    .planHeader .left{font-weight:800}
    .svgHost{
      position:relative;
      width:100%;
      height: 460px;
      border-radius: 12px;
      overflow:hidden;
    }
    .svgHost svg{width:100%; height:100%; display:block}
    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .side{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 520px;
    }
    .panel{
      border:1px solid rgba(0,0,0,.08);
      border-radius: 14px;
      padding:12px;
    }
    .panel h3{margin:0 0 8px; font-size:16px}
    .selectedBox .big{font-size:42px; font-weight:900; line-height:1}
    .selectedBox .name{font-size:22px; font-weight:800; margin-top:6px}
    .hint{color:var(--muted); font-size:14px; line-height:1.35; margin-top:10px}
    .search input{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.14);
      font-size:16px;
    }
    .list{
      border:1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      overflow:hidden;
      max-height: 540px;
      background:#fff;
    }
    .item{
      padding:12px 14px;
      border-top:1px solid rgba(0,0,0,.06);
      cursor:pointer;
    }
    .item:first-child{border-top:none}
    .item .company{font-size:18px; font-weight:800}
    .item .stand{color:var(--muted); font-size:15px; margin-top:2px}
    .item.active{background: rgba(229,57,53,.08)}
    .footerPad{height: 24px}
    /* Label styling (overlay) */
    .labelBox{
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));
    }
    /* Responsive */
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .planCard{min-height: unset}
      .side{min-height: unset}
      h1{font-size:44px}
    }
    @media (max-width: 640px){
      header{padding:14px 14px 8px}
      h1{font-size:44px}
      .layout{padding: 0 14px 14px}
      .svgHost{height: 280px;}
      /* sticky plan on phone */
      .planCard{
        position: sticky;
        top: env(safe-area-inset-top, 0px);
        z-index: 5;
      }
      .side{gap:12px}
      .list{max-height: calc(100vh - 530px);}
      /* ensure bottom padding so last item isn't behind browser bar */
      .list::after{
        content:"";
        display:block;
        height: 96px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="titleWrap">
      <h1 id="eventTitle">Loading…</h1>
      <div class="meta" id="updatedAt">Updated: —</div>
      <div class="status" id="ready">Loading…</div>
    </div>
    <div class="actions">
      <button class="btn" id="exportPdfBtn">Export PDF</button>
      <button class="btn" id="clearBtn">Clear selection</button>
    </div>
  </header>

  <div class="layout">
    <div class="card planCard">
      <div class="planHeader">
        <div class="left">Plan</div>
        <div class="meta" id="planMeta"></div>
      </div>
      <div class="svgHost" id="svgHost">
        <div class="overlay">
          <svg id="overlaySvg" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>

    <div class="card side">
      <div class="panel selectedBox">
        <h3>Selected exhibitor</h3>
        <div class="big" id="selStand">None</div>
        <div class="name" id="selCompany"></div>
        <div class="hint">Desktop: click a stand or choose from the list.<br/>Phone: use the list (stand tapping is disabled).</div>
      </div>

      <div class="panel">
        <h3>Sold exhibitors</h3>
        <div class="search" style="margin:10px 0 10px;">
          <input id="search" placeholder="Search company or stand…" />
        </div>
        <div class="list" id="list"></div>
      </div>

      <div class="panel">
        <h3>Help</h3>
        <div class="hint" style="margin-top:0">Selecting an exhibitor makes their stand red with a label + line.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const DEFAULT_API_BASE = "https://floorplansaberdeen-bot.workers.dev";
const API_BASE = (() => {
  const override = window.API_BASE;
  const saved = localStorage.getItem("floorplan_api_base");
  const base = (override && typeof override==="string") ? override : ((saved && saved.startsWith("http")) ? saved : DEFAULT_API_BASE);
  return base.replace(/\/+$/,"");
})(); // change if needed
  const STANDS_ENDPOINT = `${API_BASE}/stands`;
  const SETTINGS_ENDPOINT = `${API_BASE}/settings`;
  // ---- Backend selection & resilient fetch ----
  function setApiBase(newBase){
    if(!newBase) return;
    const clean = String(newBase).trim().replace(/\/+$/,"");
    localStorage.setItem("floorplan_api_base", clean);
    location.reload();
  }

  function backendUi(message){
    let el = document.getElementById("backendBanner");
    if(!el){
      el = document.createElement("div");
      el.id = "backendBanner";
      el.style.cssText = "position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:14px;";
      el.innerHTML = `<div style="flex:1;line-height:1.3"></div>
        <button id="backendSetBtn" style="background:#fff;color:#111;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer">Set backend URL</button>
        <button id="backendHideBtn" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer">Hide</button>`;
      document.body.appendChild(el);
      el.querySelector("#backendSetBtn").onclick = () => {
        const current = localStorage.getItem("floorplan_api_base") || DEFAULT_API_BASE;
        const v = prompt("Paste your backend URL (Cloudflare Worker or Google Apps Script Web App):", current);
        if(v) setApiBase(v);
      };
      el.querySelector("#backendHideBtn").onclick = () => el.remove();
    }
    el.firstElementChild.textContent = message || "Backend not reachable.";
  }

  async function safeFetch(url, options){
    try{
      const res = await fetch(url, options);
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt?": "+txt.slice(0,120):""}`);
      }
      return res;
    }catch(err){
      backendUi("Can't reach the backend right now (this is why the page won't load). If Cloudflare is down, paste your Google Apps Script Web App URL instead.");
      throw err;
    }
  }
  const SVG_URL = "event_plan.svg"; // same repo file

  const COLORS = {
    stand: getComputedStyle(document.documentElement).getPropertyValue('--stand').trim() || "rgba(213,109,50,0.75)",
    selected: getComputedStyle(document.documentElement).getPropertyValue('--selected').trim() || "#e53935",
    line: getComputedStyle(document.documentElement).getPropertyValue('--line').trim() || "rgba(0,0,0,.65)",
    dot: getComputedStyle(document.documentElement).getPropertyValue('--dot').trim() || "rgba(0,0,0,.75)",
  };

  const isPhone = () => window.matchMedia("(max-width: 640px)").matches;

  // ===== DOM =====
  const svgHost = document.getElementById("svgHost");
  const overlaySvg = document.getElementById("overlaySvg");
  const listEl = document.getElementById("list");
  const searchEl = document.getElementById("search");
  const selStandEl = document.getElementById("selStand");
  const selCompanyEl = document.getElementById("selCompany");
  const eventTitleEl = document.getElementById("eventTitle");
  const updatedAtEl = document.getElementById("updatedAt");
  const readyEl = document.getElementById("ready");
  const clearBtn = document.getElementById("clearBtn");
  const exportPdfBtn = document.getElementById("exportPdfBtn");

  // ===== STATE =====
  let svgRoot = null;
  let standsData = []; // {standId, status, company}
  let standsById = new Map();
  let standEls = new Map(); // standId -> element
  let standScreenBoxes = new Map(); // standId -> {x,y,w,h,cx,cy} relative to container
  let selectedStandId = null;

  // ===== HELPERS =====
  function normId(s){ return (s||"").toString().trim(); }
  function statusNorm(s){
    const v = (s||"").toString().toLowerCase().trim();
    if (v === "sold") return "sold";
    return "available";
  }

  async function fetchJson(url){
    const isBackend = (typeof url === "string") && (url.startsWith(API_BASE) || url.startsWith(DEFAULT_API_BASE));
    const r = isBackend ? await safeFetch(url, {cache:"no-store"}) : await fetch(url, {cache:"no-store"});
    return await r.json();
  }

  async function loadSvg(){
    const r = await fetch(SVG_URL, {cache:"no-store"});
    if(!r.ok) throw new Error(`SVG not found: ${SVG_URL}`);
    const txt = await r.text();
    const wrap = document.createElement("div");
    wrap.innerHTML = txt;
    const s = wrap.querySelector("svg");
    if(!s) throw new Error("Invalid SVG");
    // Clear host and insert
    svgHost.querySelectorAll("svg").forEach(x => x.remove());
    // Put SVG behind overlay
    svgHost.insertBefore(s, svgHost.firstChild);
    svgRoot = s;
    svgRoot.removeAttribute("width");
    svgRoot.removeAttribute("height");
    svgRoot.style.width = "100%";
    svgRoot.style.height = "100%";
    svgRoot.style.display = "block";
    // Clean any stray shapes that could show (fix top-left quarter circle from defs/markers)
    // Ensure overlay starts empty
    overlaySvg.innerHTML = "";
  }

  function findStandElements(){
    standEls.clear();
    // Strategy: any element with id matching stand ids, or data-stand attribute.
    const all = svgRoot.querySelectorAll("[id], [data-stand]");
    all.forEach(el => {
      const id = normId(el.getAttribute("data-stand") || el.id);
      if(!id) return;
      // Only accept if it matches a stand in sheet OR looks like a stand id pattern.
      if (standsById.has(id) || /^[A-Z]{1,3}\d{1,3}$/.test(id) || /^SB\d{1,3}$/.test(id)) {
        // Prefer filled shapes: path/rect/polygon etc.
        const tag = el.tagName.toLowerCase();
        if(["path","rect","polygon","polyline","circle","ellipse"].includes(tag) || el.getBBox){
          if(!standEls.has(id)) standEls.set(id, el);
        }
      }
    });
  }

  function setBaseColors(){
    // paint all known stand shapes to base color
    for(const [id, el] of standEls.entries()){
      const st = standsById.get(id);
      // always show base colour regardless of sold/available, public wants all stands same colour until selected
      el.style.fill = COLORS.stand;
      el.style.stroke = "rgba(0,0,0,.55)";
      el.style.strokeWidth = "1";
      el.style.cursor = isPhone() ? "default" : "pointer";
      el.style.transition = "fill 140ms ease";
      // disable pointer on phone to avoid freezing
      el.style.pointerEvents = isPhone() ? "none" : "auto";
    }
  }

  function setSelectedColor(){
    for(const [id, el] of standEls.entries()){
      el.style.fill = (id === selectedStandId) ? COLORS.selected : COLORS.stand;
    }
  }

  function computeStandBoxes(){
    standScreenBoxes.clear();
    const hostRect = svgHost.getBoundingClientRect();
    for(const [id, el] of standEls.entries()){
      try{
        const bb = el.getBBox();
        const m = el.getScreenCTM();
        if(!m) continue;
        const pts = [
          {x: bb.x, y: bb.y},
          {x: bb.x+bb.width, y: bb.y},
          {x: bb.x+bb.width, y: bb.y+bb.height},
          {x: bb.x, y: bb.y+bb.height},
        ].map(p => {
          const pt = svgRoot.createSVGPoint();
          pt.x = p.x; pt.y = p.y;
          const sp = pt.matrixTransform(m);
          return {x: sp.x - hostRect.left, y: sp.y - hostRect.top};
        });
        const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const box = {x:minX, y:minY, w:maxX-minX, h:maxY-minY};
        box.cx = box.x + box.w/2;
        box.cy = box.y + box.h/2;
        standScreenBoxes.set(id, box);
      }catch(e){ /* ignore */ }
    }
  }

  function rectsIntersect(a,b){
    return !(a.x+a.w < b.x || b.x+b.w < a.x || a.y+a.h < b.y || b.y+b.h < a.y);
  }

  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function buildLabelLayout(id, company){
    const w = isPhone() ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--labelWPhone')) : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--labelWDesktop'));
    const standText = id || "";
    const compText = company || "";
    const h = compText ? (isPhone()? 86 : 92) : (isPhone()? 68 : 72);
    return {w, h, standText, compText};
  }

  function chooseLabelPosition(targetBox, label){
    const hostRect = svgHost.getBoundingClientRect();
    const W = hostRect.width, H = hostRect.height;
    // Candidate anchor positions relative to target center
    const d = isPhone() ? 64 : 90;
    const candidates = [
      {name:"bottom", x: targetBox.cx - label.w/2, y: targetBox.cy + d},
      {name:"top", x: targetBox.cx - label.w/2, y: targetBox.cy - d - label.h},
      {name:"right", x: targetBox.cx + d, y: targetBox.cy - label.h/2},
      {name:"left", x: targetBox.cx - d - label.w, y: targetBox.cy - label.h/2},
      {name:"bottom-right", x: targetBox.cx + d*.8, y: targetBox.cy + d*.8},
      {name:"bottom-left", x: targetBox.cx - d*.8 - label.w, y: targetBox.cy + d*.8},
      {name:"top-right", x: targetBox.cx + d*.8, y: targetBox.cy - d*.8 - label.h},
      {name:"top-left", x: targetBox.cx - d*.8 - label.w, y: targetBox.cy - d*.8 - label.h},
    ];

    // Expand stand boxes for collision
    const standRects = Array.from(standScreenBoxes.values()).map(b => ({x:b.x-6,y:b.y-6,w:b.w+12,h:b.h+12}));

    function score(c){
      const r = {x: clamp(c.x, 8, W - label.w - 8), y: clamp(c.y, 8, H - label.h - 8), w: label.w, h: label.h};
      let collisions = 0;
      for(const s of standRects){
        if(rectsIntersect(r, s)) collisions++;
      }
      // prefer below and centered-ish
      const dy = Math.abs((r.y + r.h/2) - (targetBox.cy + d));
      const dx = Math.abs((r.x + r.w/2) - targetBox.cx);
      const edgePenalty = (r.x<12||r.y<12||r.x+r.w>W-12||r.y+r.h>H-12) ? 2 : 0;
      return {r, collisions, metric: collisions*10000 + edgePenalty*800 + dy*2 + dx};
    }

    let best = null;
    for(const c of candidates){
      const s = score(c);
      if(!best || s.metric < best.metric) best = s;
    }
    return best.r;
  }

  function drawOverlay(){
    overlaySvg.innerHTML = ""; // avoid stray shapes/quarter circles
    if(!selectedStandId) return;

    const data = standsById.get(selectedStandId) || {};
    const box = standScreenBoxes.get(selectedStandId);
    if(!box) return;

    const label = buildLabelLayout(selectedStandId, data.company);
    const pos = chooseLabelPosition(box, label);

    // Compute connector: from label rect edge to stand center
    const sx = box.cx, sy = box.cy;
    const lx = pos.x, ly = pos.y, lw = pos.w, lh = pos.h;
    const px = clamp(sx, lx, lx+lw);
    const py = clamp(sy, ly, ly+lh);

    // Pick the closest point on label rectangle perimeter
    let ex = px, ey = py;
    // Move point to edge (not inside)
    const leftDist = Math.abs(px - lx);
    const rightDist = Math.abs(px - (lx+lw));
    const topDist = Math.abs(py - ly);
    const bottomDist = Math.abs(py - (ly+lh));
    const m = Math.min(leftDist, rightDist, topDist, bottomDist);
    if(m === leftDist) ex = lx;
    else if(m === rightDist) ex = lx+lw;
    else if(m === topDist) ey = ly;
    else ey = ly+lh;

    const dotR = isPhone() ? 4.2 : 4.8;

    // SVG elements
    const NS = "http://www.w3.org/2000/svg";
    const line = document.createElementNS(NS,"line");
    line.setAttribute("x1", ex);
    line.setAttribute("y1", ey);
    line.setAttribute("x2", sx);
    line.setAttribute("y2", sy);
    line.setAttribute("stroke", COLORS.line);
    line.setAttribute("stroke-width", isPhone()? "3" : "3.2");
    line.setAttribute("stroke-linecap", "round");
    line.setAttribute("opacity","0.9");

    const dot = document.createElementNS(NS,"circle");
    dot.setAttribute("cx", sx);
    dot.setAttribute("cy", sy);
    dot.setAttribute("r", dotR);
    dot.setAttribute("fill", COLORS.dot);

    const g = document.createElementNS(NS,"g");
    g.setAttribute("class","labelBox");

    const rect = document.createElementNS(NS,"rect");
    rect.setAttribute("x", lx);
    rect.setAttribute("y", ly);
    rect.setAttribute("width", lw);
    rect.setAttribute("height", lh);
    rect.setAttribute("rx", isPhone()? "16" : "18");
    rect.setAttribute("fill", COLORS.selected);
    rect.setAttribute("opacity","0.96");

    const t1 = document.createElementNS(NS,"text");
    t1.setAttribute("x", lx + lw/2);
    t1.setAttribute("y", ly + (label.compText ? (isPhone()? 42 : 44) : (isPhone()? 44 : 46)));
    t1.setAttribute("text-anchor","middle");
    t1.setAttribute("font-weight","900");
    t1.setAttribute("font-size", isPhone()? "34" : "36");
    t1.setAttribute("fill","#fff");
    t1.textContent = label.standText;

    g.appendChild(rect);
    g.appendChild(t1);

    if(label.compText){
      const t2 = document.createElementNS(NS,"text");
      t2.setAttribute("x", lx + lw/2);
      t2.setAttribute("y", ly + (isPhone()? 70 : 74));
      t2.setAttribute("text-anchor","middle");
      t2.setAttribute("font-weight","800");
      t2.setAttribute("font-size", isPhone()? "20" : "18");
      t2.setAttribute("fill","#fff");
      t2.textContent = label.compText;
      g.appendChild(t2);
    }

    overlaySvg.appendChild(line);
    overlaySvg.appendChild(dot);
    overlaySvg.appendChild(g);
  }

  function renderList(){
    const q = (searchEl.value || "").toLowerCase().trim();
    const sold = standsData
      .filter(s => statusNorm(s.status) === "sold")
      .filter(s => {
        const comp = (s.company || "(No company)").toLowerCase();
        const sid = (s.standId || "").toLowerCase();
        return !q || comp.includes(q) || sid.includes(q);
      })
      .sort((a,b) => (a.company||"").localeCompare(b.company||"") || (a.standId||"").localeCompare(b.standId||""));
    listEl.innerHTML = "";
    for(const s of sold){
      const div = document.createElement("div");
      div.className = "item" + (s.standId === selectedStandId ? " active" : "");
      const comp = s.company ? s.company : "(No company)";
      div.innerHTML = `<div class="company">${escapeHtml(comp)}</div><div class="stand">Stand ${escapeHtml(s.standId)}</div>`;
      div.addEventListener("click", () => selectStand(s.standId));
      listEl.appendChild(div);
    }
  }

  function escapeHtml(str){
    return (str||"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function updateSelectedPanel(){
    if(!selectedStandId){
      selStandEl.textContent = "None";
      selCompanyEl.textContent = "";
      return;
    }
    const s = standsById.get(selectedStandId) || {};
    selStandEl.textContent = selectedStandId;
    selCompanyEl.textContent = s.company || "";
  }

  function selectStand(id){
    id = normId(id);
    if(!id) return;
    selectedStandId = id;
    setSelectedColor();
    updateSelectedPanel();
    drawOverlay();
    renderList();
  }

  function clearSelection(){
    selectedStandId = null;
    setSelectedColor();
    updateSelectedPanel();
    overlaySvg.innerHTML = "";
    renderList();
  }

  function bindStandClicks(){
    // Desktop only
    for(const [id, el] of standEls.entries()){
      el.onpointerdown = null;
      if(isPhone()) continue;
      el.style.pointerEvents = "auto";
      el.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        selectStand(id);
      });
    }
  }

  async function refreshData(){
    const [settings, stands] = await Promise.all([
      fetchJson(SETTINGS_ENDPOINT).catch(()=>({eventName:"Getaway Show 2026", updatedAt:null})),
      fetchJson(STANDS_ENDPOINT)
    ]);
    standsData = Array.isArray(stands) ? stands : (stands.stands || []);
    standsById = new Map(standsData.map(s => [normId(s.standId), s]));
    eventTitleEl.textContent = settings.eventName || "Exhibition Floorplan";
    const updated = settings.updatedAt || settings.lastUpdated || settings.updated || null;
    updatedAtEl.textContent = "Updated: " + (updated ? updated : new Date().toLocaleTimeString());
    readyEl.textContent = "Ready ✅";

    if(svgRoot){
      findStandElements();
      setBaseColors();
      computeStandBoxes();
      bindStandClicks();
      setSelectedColor();
      drawOverlay();
    }
    renderList();
  }

  function onResize(){
    if(!svgRoot) return;
    // Update phone/desktop pointer behavior
    setBaseColors();
    bindStandClicks();
    // Recompute geometry
    computeStandBoxes();
    drawOverlay();
  }

  // ===== PDF EXPORT (simple browser print) =====
  function exportPdf(){
    // Use a print-friendly window with current plan SVG (including selection)
    const w = window.open("", "_blank");
    if(!w) return;
    const title = eventTitleEl.textContent || "Floorplan";
    const svgHtml = svgRoot ? svgRoot.outerHTML : "";
    const overlayHtml = overlaySvg ? overlaySvg.outerHTML : "";
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"/><title>${escapeHtml(title)}</title>
      <style>
        body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
        .wrap{padding:20px;}
        .box{position:relative; border:1px solid rgba(0,0,0,.12); border-radius:14px; overflow:hidden;}
        .box svg{width:100%; height:auto; display:block;}
        .overlay{position:absolute; inset:0; pointer-events:none;}
      </style>
      </head><body><div class="wrap">
        <h2 style="margin:0 0 10px;">${escapeHtml(title)}</h2>
        <div class="box">
          ${svgHtml}
          <div class="overlay">${overlayHtml}</div>
        </div>
      </div>
      <script>setTimeout(()=>{window.print();}, 250);<\/script>
    </body></html>`);
    w.document.close();
  }

  // ===== INIT =====
  clearBtn.addEventListener("click", clearSelection);
  exportPdfBtn.addEventListener("click", exportPdf);
  searchEl.addEventListener("input", renderList);

  window.addEventListener("resize", () => {
    clearTimeout(window.__rz);
    window.__rz = setTimeout(onResize, 120);
  });

  (async () => {
    try{
      readyEl.textContent = "Loading…";
      await loadSvg();
      await refreshData();
      // periodic refresh
      setInterval(refreshData, 15000);
    }catch(e){
      console.error(e);
      readyEl.textContent = "Error loading ❌";
      eventTitleEl.textContent = "Floorplan";
      updatedAtEl.textContent = (e && e.message) ? e.message : "Failed to load";
    }
  })();
})();
</script>
</body>
</html>