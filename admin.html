<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Exhibition Floorplan – Admin</title>
  <style>
    :root {
      --sold: #e53935;
      --avail: #43a047;
      --ink: #111827;
      --muted: #6b7280;
      --bg: #ffffff;
      --panel: #f9fafb;
      --border: #e5e7eb;
      --focus: #2563eb;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
    }
    .topbar {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .links {
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }
    .links a {
      color: var(--muted);
      text-decoration: none;
      border-bottom: 1px dotted rgba(0,0,0,0.25);
    }
    .links a:hover { border-bottom-style: solid; }
    .logout {
      margin-left: 10px;
      color: var(--muted);
      background: none;
      border: none;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      font-size: 12px;
    }
    .legend {
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      flex-wrap: wrap;
      padding-top: 8px;
    }
    .swatch {
      width: 10px; height: 10px; border-radius: 2px; display:inline-block; margin-right: 6px;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .wrap {
      padding: 10px 10px 18px;
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
    }

    #svgHost {
      width: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      position: relative;
      min-height: 320px;
      box-shadow: var(--shadow);
    }
    #svgHost svg { width: 100%; height: auto; display:block; }

    #tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(17, 24, 39, 0.92);
      color: #fff;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      transform: translate(10px, 10px);
      display: none;
      max-width: 320px;
      line-height: 1.25;
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
      z-index: 9999;
      white-space: pre-wrap;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    .panel h2 {
      font-size: 12px;
      margin: 0 0 10px 0;
      color: var(--muted);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .row {
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      min-width: 90px;
    }
    select, textarea, input[type="text"] {
      font: inherit;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      min-width: 220px;
    }
    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
    }
    button {
      font: inherit;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
    }
    button.primary {
      border-color: var(--focus);
      color: #fff;
      background: var(--focus);
    }
    button.ghost {
      background: transparent;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .badge {
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted);
    }
    .dot.ok { background: var(--avail); }
    .dot.err { background: var(--sold); }

    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .error {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #991b1b;
      border-radius: 12px;
      display:none;
      font-size: 13px;
      box-shadow: var(--shadow);
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    thead th {
      font-size: 12px;
      text-align: left;
      color: var(--muted);
      padding: 10px;
      border-bottom: 1px solid var(--border);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: 13px;
      white-space: pre-wrap;
    }
    tbody tr.highlight {
      outline: 2px solid var(--focus);
      outline-offset: -2px;
      background: rgba(37, 99, 235, 0.06);
    }
    .toolbar {
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .toolbar .left, .toolbar .right {
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
    }

    /* Login overlay */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(17, 24, 39, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 10000;
    }
    #loginCard {
      width: min(460px, 100%);
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      border: 1px solid rgba(0,0,0,0.08);
    }
    #loginCard h2 {
      margin: 0 0 8px 0;
      font-size: 16px;
    }
    #loginCard p {
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 13px;
    }
    #loginRow {
      display:flex;
      gap: 10px;
      align-items:center;
    }
    #loginRow input {
      flex: 1;
      min-width: 0;
    }
  </style>
</head>
<body>
  <div id="loginOverlay" aria-modal="true" role="dialog">
    <div id="loginCard">
      <h2>Admin login</h2>
      <p>Enter the admin password to continue.</p>
      <div id="loginRow">
        <input id="pw" type="password" placeholder="Password" autocomplete="current-password" />
        <button id="loginBtn" class="primary">Continue</button>
      </div>
      <div class="small" style="margin-top:10px;">
        This is a simple client-side lock (sessionStorage). For real user accounts, use Google Workspace auth in Apps Script.
      </div>
    </div>
  </div>

  <header>
    <div class="topbar">
      <h1>Exhibition Floorplan – Admin</h1>
      <div class="links">
        <a id="publicLink" href="./index.html">Public view</a>
        <a id="sheetLink" href="#" target="_blank" rel="noreferrer">Open Google Sheet</a>
        <a id="testLink" href="#" target="_blank" rel="noreferrer">Test Sync Endpoint</a>
        <span class="badge" id="syncBadge">
          <span class="dot" id="syncDot"></span>
          <span id="syncLine">Sync: starting…</span>
        </span>
        <button id="refreshBtn" title="Refresh data from Google Sheet now">Refresh</button>
        <button id="undoBtn" title="Undo (this browser only)">Undo</button>
        <button class="logout" id="logoutBtn" title="Log out">Logout</button>
      </div>
    </div>
    <div class="legend">
      <span><i class="swatch" style="background: var(--sold)"></i>Sold</span>
      <span><i class="swatch" style="background: var(--avail)"></i>Available</span>
      <span class="small">Click a stand to edit it. The table can filter to show only the selected stand.</span>
    </div>
  </header>

  <div class="wrap">
    <div>
      <div id="svgHost" aria-label="Exhibition plan"></div>
      <div id="tooltip" role="tooltip"></div>
    </div>

    <div style="display:grid; gap:12px;">
      <div class="panel">
        <h2>Selected stand</h2>
        <div class="row" style="justify-content: space-between;">
          <div class="pill"><strong id="selectedId">None</strong></div>
          <div class="row">
            <button id="showOnlyBtn" class="ghost" disabled title="Show only this stand in the list">Show only this stand</button>
            <button id="showAllBtn" class="ghost" disabled title="Show all stands again">Show all</button>
          </div>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <label for="selectedStatus">Status</label>
          <select id="selectedStatus">
            <option value="available">available</option>
            <option value="sold">sold</option>
          </select>
        </div>

        <div style="height:10px;"></div>

        <div class="row" style="align-items:flex-start;">
          <label for="selectedCompany" style="padding-top:8px;">Company</label>
          <textarea id="selectedCompany" placeholder="Company name (multi-line supported)"></textarea>
        </div>

        <div style="height:10px;"></div>

        <div class="row">
          <button id="saveBtn" class="primary" disabled>Save</button>
          <button id="clearBtn" disabled>Clear</button>
          <button id="jumpBtn" disabled>Jump to row</button>
        </div>

        <div style="height:6px;"></div>
        <div class="small" id="saveLine"></div>
        <div class="error" id="errBox"></div>
      </div>

      <div class="panel" style="background:#fff;">
        <div class="toolbar">
          <div class="left">
            <h2 style="margin:0;">Stand list</h2>
            <span class="small" id="filterLine">Showing: all stands</span>
          </div>
          <div class="right">
            <span class="small">Edits are live. Multiple admins can edit simultaneously; last write wins on the same stand.</span>
          </div>
        </div>

        <div style="overflow:auto; border-radius:12px;">
          <table id="standsTable" aria-label="Stands table">
            <thead>
              <tr>
                <th style="width:120px;">Stand ID</th>
                <th style="width:120px;">Status</th>
                <th>Company</th>
              </tr>
            </thead>
            <tbody id="standsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== CONFIG =====
  const ADMIN_PASSWORD = "CHANGE_ME";
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxEq83BUYJ-oewP_2lPFL0tyol4veM2mhukSTTMCaKCZgEJS5m-f8Jqy1EO_bDc3q3a/exec";
  const SVG_URL = './event_plan.svg';
  const GOOGLE_SHEET_URL = ""; // Optional: paste your full Google Sheet URL here for the toolbar button.
  const POLL_MS = 30000;

  // Accept stand IDs like: A1, AA1, SB12, AD10, etc.
  const STAND_ID_RE = /^[A-Z]{1,3}\d{1,4}$/;

  // ===== DOM =====
  const svgHost = document.getElementById('svgHost');
  const tooltip = document.getElementById('tooltip');

  const syncLine = document.getElementById('syncLine');
  const syncDot = document.getElementById('syncDot');

  const errBox = document.getElementById('errBox');
  const saveLine = document.getElementById('saveLine');
  const filterLine = document.getElementById('filterLine');

  const selectedIdEl = document.getElementById('selectedId');
  const selectedStatusEl = document.getElementById('selectedStatus');
  const selectedCompanyEl = document.getElementById('selectedCompany');

  const saveBtn = document.getElementById('saveBtn');
  const clearBtn = document.getElementById('clearBtn');
  const jumpBtn = document.getElementById('jumpBtn');

  const showOnlyBtn = document.getElementById('showOnlyBtn');
  const showAllBtn = document.getElementById('showAllBtn');

  const refreshBtn = document.getElementById('refreshBtn');
  const undoBtn = document.getElementById('undoBtn');

  const standsTbody = document.getElementById('standsTbody');

  const loginOverlay = document.getElementById('loginOverlay');
  const pwInput = document.getElementById('pw');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const sheetLink = document.getElementById('sheetLink');
  const testLink = document.getElementById('testLink');

  // ===== STATE =====
  let svgRoot = null;
  let svgReady = false;
  let pendingSheetData = null;

  let standMap = new Map();   // standId -> {status, company}
  let standOrder = [];        // preserve ordering from sheet
  let lastSyncAt = null;

  let selectedStandId = null;
  let selectedSnapshot = null; // Used for lightweight conflict detection
  let filterStandId = null;    // When set, table shows only that stand

  const UNDO_KEY = 'fp_admin_undo_stack_v2';
  const UNDO_MAX = 30;

  function isValidStandId(s) {
    const id = String(s || '').trim().toUpperCase();
    return STAND_ID_RE.test(id);
  }

  function cssVar(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  // Robust stand resolver:
  // - Walks up the SVG DOM
  // - Prefers data-name if valid (avoids CAD id collisions)
  // - Falls back to id
  function resolveStandIdFromSvgTarget(targetEl) {
    let el = targetEl;
    while (el && el !== svgRoot) {
      if (el.getAttribute) {
        const dn = el.getAttribute('data-name');
        if (dn && isValidStandId(dn)) return dn.trim().toUpperCase();
      }
      if (el.id && isValidStandId(el.id)) return el.id.trim().toUpperCase();
      el = el.parentNode;
    }
    return null;
  }

  function setStandColor(standId, status) {
    if (!svgRoot) return;
    const sel = `[data-name="${standId}"], #${CSS.escape(standId)}`;
    const nodes = svgRoot.querySelectorAll(sel);
    const color = (status === 'sold') ? cssVar('--sold') : cssVar('--avail');

    nodes.forEach(node => {
      const shapes = node.querySelectorAll('path, rect, polygon, circle, ellipse, line, polyline');
      (shapes.length ? shapes : [node]).forEach(s => {
        if (!s || !s.style) return;
        const fill = s.getAttribute && s.getAttribute('fill');
        if (fill !== 'none') s.style.fill = color;
        const stroke = s.getAttribute && s.getAttribute('stroke');
        if (stroke && stroke !== 'none') s.style.stroke = color;
      });
    });
  }

  function showTooltip(text, x, y) {
    tooltip.textContent = text;
    tooltip.style.left = (x + 10) + 'px';
    tooltip.style.top = (y + 10) + 'px';
    tooltip.style.display = 'block';
  }
  function hideTooltip() {
    tooltip.style.display = 'none';
  }

  function setStatusOk(text) {
    syncDot.classList.remove('err');
    syncDot.classList.add('ok');
    syncLine.textContent = text;
  }
  function setStatusErr(text) {
    syncDot.classList.remove('ok');
    syncDot.classList.add('err');
    syncLine.textContent = text;
  }

  function showError(text) {
    errBox.style.display = 'block';
    errBox.textContent = text;
  }
  function clearError() {
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  // JSONP loader for GitHub Pages (avoids CORS)
  function jsonp(url, timeoutMs = 15000) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      const timer = setTimeout(() => {
        cleanup();
        reject(new Error('JSONP timeout'));
      }, timeoutMs);

      function cleanup() {
        clearTimeout(timer);
        script.remove();
        try { delete window[cb]; } catch (e) { window[cb] = undefined; }
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      const sep = url.includes('?') ? '&' : '?';
      script.src = url + sep + 'callback=' + encodeURIComponent(cb) + '&_=' + Date.now();
      script.onerror = () => {
        cleanup();
        reject(new Error('JSONP network error'));
      };
      document.head.appendChild(script);
    });
  }

  async function loadDataFromSheet() {
    const data = await jsonp(SHEET_API_URL);
    applyStandData(data);

    lastSyncAt = new Date();
    setStatusOk('Sync: ' + lastSyncAt.toLocaleString());
    return data;
  }
  globalThis.loadDataFromSheet = loadDataFromSheet;

  function applyStandData(dataArr) {
    standMap.clear();
    standOrder = [];

    (dataArr || []).forEach(r => {
      const standId = String(r.standId || '').trim().toUpperCase();
      if (!isValidStandId(standId)) return;
      const status = (String(r.status || '').toLowerCase().trim() === 'sold') ? 'sold' : 'available';
      const company = String(r.company || '').trim();

      standMap.set(standId, { status, company });
      standOrder.push(standId);
    });

    if (!svgReady) {
      pendingSheetData = dataArr;
      return;
    }

    // Color stands
    standMap.forEach((v, k) => setStandColor(k, v.status));

    // Render table with current filter
    renderTable();

    // If selected stand exists, refresh selection fields to match latest data
    if (selectedStandId && standMap.has(selectedStandId)) {
      const rec = standMap.get(selectedStandId);
      selectedStatusEl.value = rec.status;
      selectedCompanyEl.value = rec.company;

      // Keep snapshot updated to what we last saw from the sheet
      selectedSnapshot = { status: rec.status, company: rec.company };
    }
  }

  function renderTable() {
    const frag = document.createDocumentFragment();

    const ids = filterStandId ? [filterStandId] : standOrder;

    ids.forEach(id => {
      const rec = standMap.get(id);
      if (!rec) return;

      const tr = document.createElement('tr');
      tr.dataset.standId = id;

      const tdId = document.createElement('td');
      tdId.textContent = id;

      const tdStatus = document.createElement('td');
      tdStatus.textContent = rec.status;

      const tdCompany = document.createElement('td');
      tdCompany.textContent = rec.company;

      tr.appendChild(tdId);
      tr.appendChild(tdStatus);
      tr.appendChild(tdCompany);

      tr.addEventListener('click', () => {
        selectStand(id);
      });

      frag.appendChild(tr);
    });

    standsTbody.innerHTML = '';
    standsTbody.appendChild(frag);

    if (filterStandId) {
      filterLine.textContent = 'Showing: ' + filterStandId;
    } else {
      filterLine.textContent = 'Showing: all stands';
    }
  }

  function highlightRow(standId) {
    standsTbody.querySelectorAll('tr.highlight').forEach(tr => tr.classList.remove('highlight'));
    const tr = standsTbody.querySelector(`tr[data-stand-id="${standId}"]`);
    if (tr) {
      tr.classList.add('highlight');
      tr.scrollIntoView({ block: 'nearest' });
      setTimeout(() => tr.classList.remove('highlight'), 1600);
    }
  }

  function setControlsEnabled(enabled) {
    saveBtn.disabled = !enabled;
    clearBtn.disabled = !enabled;
    jumpBtn.disabled = !enabled;
    showOnlyBtn.disabled = !enabled;
    showAllBtn.disabled = !enabled;
  }

  function selectStand(standId) {
    selectedStandId = standId;
    selectedIdEl.textContent = standId;

    const rec = standMap.get(standId) || { status: 'available', company: '' };
    selectedStatusEl.value = rec.status;
    selectedCompanyEl.value = rec.company;

    selectedSnapshot = { status: rec.status, company: rec.company };

    setControlsEnabled(true);
    clearError();
    saveLine.textContent = '';
  }

  function clearSelection() {
    selectedStandId = null;
    selectedSnapshot = null;
    selectedIdEl.textContent = 'None';
    selectedStatusEl.value = 'available';
    selectedCompanyEl.value = '';
    setControlsEnabled(false);
    saveLine.textContent = '';
    clearError();
  }

  function snapshotForUndo() {
    // Snapshot the entire dataset (browser-local)
    return standOrder.map(id => {
      const rec = standMap.get(id);
      return { standId: id, status: rec.status, company: rec.company };
    });
  }

  function pushUndo(snapshot) {
    try {
      const stack = JSON.parse(localStorage.getItem(UNDO_KEY) || '[]');
      stack.push({ t: Date.now(), data: snapshot });
      while (stack.length > UNDO_MAX) stack.shift();
      localStorage.setItem(UNDO_KEY, JSON.stringify(stack));
    } catch (e) {
      // ignore
    }
  }

  function popUndo() {
    try {
      const stack = JSON.parse(localStorage.getItem(UNDO_KEY) || '[]');
      const last = stack.pop();
      localStorage.setItem(UNDO_KEY, JSON.stringify(stack));
      return last ? last.data : null;
    } catch (e) {
      return null;
    }
  }

  async function saveSelected() {
    if (!selectedStandId) return;

    clearError();
    saveLine.textContent = 'Saving…';
    saveBtn.disabled = true;

    // Multi-admin friendly behavior:
    // 1) Refresh from sheet before write (reduces stale overwrites)
    // 2) If the stand changed since selection, show a warning (non-blocking)
    try {
      await loadDataFromSheet();
    } catch (e) {
      // If refresh fails, still allow save attempt (but warn)
      showError('Warning: Could not refresh before saving. ' + e.message);
    }

    const latest = standMap.get(selectedStandId);
    if (latest && selectedSnapshot) {
      const changedSinceSelect = (latest.status !== selectedSnapshot.status) || (latest.company !== selectedSnapshot.company);
      if (changedSinceSelect) {
        // Non-blocking warning: last write wins if two admins edit same stand
        showError(
          'Heads up: This stand was updated by someone else since you selected it.\n' +
          'Latest in sheet: status=' + latest.status + ', company=' + (latest.company || '(blank)') + '\n' +
          'Your edit will overwrite it if you save again.'
        );
      }
    }

    // Save undo snapshot before write
    pushUndo(snapshotForUndo());

    const standId = selectedStandId;
    const status = selectedStatusEl.value;
    const company = selectedCompanyEl.value;

    try {
      const res = await fetch(SHEET_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ standId, status, company })
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok || !json.success) {
        throw new Error(json.error || 'Write failed');
      }

      saveLine.textContent = 'Saved ✔';
      // Immediate refresh after write so all admins see the update on next poll (and this admin sees it now)
      await loadDataFromSheet();

    } catch (e) {
      showError('Save error: ' + e.message);
      saveLine.textContent = 'Save failed';
    } finally {
      saveBtn.disabled = false;
    }
  }

  async function undoLast() {
    const snap = popUndo();
    if (!snap) {
      saveLine.textContent = 'Undo: nothing to undo';
      return;
    }
    clearError();
    saveLine.textContent = 'Undoing…';

    try {
      // Restore snapshot sequentially (simple & reliable)
      for (const row of snap) {
        await fetch(SHEET_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(row)
        });
      }
      await loadDataFromSheet();
      saveLine.textContent = 'Undo complete ✔';
    } catch (e) {
      showError('Undo error: ' + e.message);
      saveLine.textContent = 'Undo failed';
    }
  }

  function setFilterToSelected() {
    if (!selectedStandId) return;
    filterStandId = selectedStandId;
    renderTable();
    highlightRow(selectedStandId);
  }

  function clearFilter() {
    filterStandId = null;
    renderTable();
    if (selectedStandId) highlightRow(selectedStandId);
  }

  async function loadSvg() {
    setStatusOk('Sync: loading plan…');
    const res = await fetch(SVG_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to load SVG plan');
    svgHost.innerHTML = await res.text();

    svgRoot = svgHost.querySelector('svg');
    if (!svgRoot) throw new Error('SVG root not found');

    svgReady = true;

    // Hover tooltip
    svgRoot.addEventListener('mousemove', (e) => {
      if (tooltip.style.display === 'block') {
        tooltip.style.left = (e.clientX + 10) + 'px';
        tooltip.style.top = (e.clientY + 10) + 'px';
      }
    });

    svgRoot.addEventListener('mouseover', (e) => {
      const standId = resolveStandIdFromSvgTarget(e.target);
      if (!standId) return;
      const rec = standMap.get(standId);
      if (!rec) return;

      const text = (rec.status === 'sold')
        ? (rec.company ? rec.company : 'Sold')
        : 'Available';

      showTooltip(text, e.clientX, e.clientY);
    });

    svgRoot.addEventListener('mouseout', (e) => {
      const standId = resolveStandIdFromSvgTarget(e.target);
      if (standId) hideTooltip();
    });

    // Click delegation (Safari-safe): only selects stand; no scroll / heavy DOM operations here
    svgRoot.addEventListener('click', (e) => {
      const standId = resolveStandIdFromSvgTarget(e.target);
      if (!standId) return;
      selectStand(standId);

      // Per your requirement: clicking a stand should make the list show only that stand.
      setFilterToSelected();
    });

    if (pendingSheetData) {
      applyStandData(pendingSheetData);
      pendingSheetData = null;
    }
  }

  /* ======================
     AUTH (client-side)
     ====================== */
  function isAuthed() {
    return sessionStorage.getItem('fp_admin_authed') === '1';
  }
  function showLogin() {
    loginOverlay.style.display = 'flex';
    pwInput.value = '';
    pwInput.focus();
  }
  function hideLogin() {
    loginOverlay.style.display = 'none';
  }
  function login() {
    if (pwInput.value === ADMIN_PASSWORD) {
      sessionStorage.setItem('fp_admin_authed', '1');
      hideLogin();
      start();
    } else {
      pwInput.value = '';
      pwInput.placeholder = 'Wrong password';
      pwInput.focus();
    }
  }
  function logout() {
    sessionStorage.removeItem('fp_admin_authed');
    location.reload();
  }

  loginBtn.addEventListener('click', login);
  pwInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') login();
  });
  logoutBtn.addEventListener('click', logout);

  /* ======================
     UI actions
     ====================== */
  saveBtn.addEventListener('click', saveSelected);
  clearBtn.addEventListener('click', clearSelection);
  jumpBtn.addEventListener('click', () => {
    if (!selectedStandId) return;
    highlightRow(selectedStandId);
  });
  showOnlyBtn.addEventListener('click', setFilterToSelected);
  showAllBtn.addEventListener('click', clearFilter);

  refreshBtn.addEventListener('click', async () => {
    clearError();
    saveLine.textContent = 'Refreshing…';
    try {
      await loadDataFromSheet();
      saveLine.textContent = 'Refreshed ✔';
    } catch (e) {
      showError('Refresh error: ' + e.message);
      saveLine.textContent = 'Refresh failed';
    }
  });

  undoBtn.addEventListener('click', undoLast);

  // Toolbar links
  testLink.href = SHEET_API_URL + '?callback=test';
  sheetLink.href = GOOGLE_SHEET_URL || '#';
  sheetLink.addEventListener('click', (e) => {
    if (!GOOGLE_SHEET_URL) {
      e.preventDefault();
      alert('Set GOOGLE_SHEET_URL in admin.html if you want this link to open your sheet.');
    }
  });

  async function start() {
    try {
      await loadSvg();
    } catch (e) {
      setStatusErr('Plan error: ' + e.message);
      showError('Plan error: ' + e.message);
      return;
    }

    try {
      await (globalThis.loadDataFromSheet ? globalThis.loadDataFromSheet() : Promise.resolve(null));
    } catch (e) {
      setStatusErr('Sync error: ' + e.message);
      showError('Sync error: ' + e.message);
    }

    // Poll so multiple admins converge on the latest view
    setInterval(async () => {
      try {
        await (globalThis.loadDataFromSheet ? globalThis.loadDataFromSheet() : Promise.resolve(null));
      } catch (e) {
        setStatusErr('Sync error: ' + e.message);
      }
    }, POLL_MS);
  }

  // Boot
  if (isAuthed()) {
    hideLogin();
    start();
  } else {
    showLogin();
  }
})();
</script>
</body>
</html>
