<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Floorplan Admin</title>
<style>
  :root {
    --card-border: rgba(0,0,0,.12);
    --muted: rgba(0,0,0,.62);
    --available: rgba(213, 109, 50, 0.75);
    --sold: #e53935;
  }
  * { box-sizing: border-box; }
  body {
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    color:#111;
    background:#fff;
  }
  header {
    padding: 12px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(0,0,0,.1);
  }
  header h1 { margin:0; font-size:18px; }
  .topRight {
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .pill {
    border:1px solid var(--card-border);
    border-radius: 12px;
    padding: 10px 12px;
    font-weight:800;
    background:#fff;
  }
  button {
    border:1px solid var(--card-border);
    background:#fff;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight:800;
    cursor:pointer;
  }
  .danger { border-color: rgba(229,57,53,.5); background: rgba(229,57,53,.06); }
  main {
    display:grid;
    grid-template-columns: 1.5fr 520px;
    gap: 16px;
    padding: 16px;
  }
  @media (max-width: 1100px) {
    main { grid-template-columns: 1fr; }
  }
  .card {
    border:1px solid var(--card-border);
    border-radius: 16px;
    overflow:hidden;
    background:#fff;
  }
  .cardHead {
    padding: 12px 14px 0;
    font-weight:900;
  }
  .planViewport {
    position:relative;
    height: min(520px, 56vh);
    padding: 14px;
  }
  .svgHost {
    position:absolute;
    left:14px; top:14px; right:14px; bottom:14px;
    border-radius: 14px;
  }
  .svgHost svg { width:100%; height:100%; display:block; }
  #overlaySvg {
    position:absolute;
    left:14px; top:14px; right:14px; bottom:14px;
    pointer-events:none;
  }
  .callout {
    position:absolute;
    min-width: 160px;
    max-width: 280px;
    padding: 12px 14px;
    border-radius: 16px;
    background: var(--sold);
    color:#fff;
    box-shadow: 0 10px 22px rgba(0,0,0,.18);
    pointer-events:none;
    text-align:center;
  }
  .callout .stand { font-weight: 900; font-size: 26px; line-height:1; }
  .callout .company { margin-top:6px; font-weight:800; font-size: 15px; line-height:1.1; }
  .gridPad { padding: 14px; }
  label { font-size: 12px; color: var(--muted); font-weight: 800; display:block; margin-top: 10px; }
  input, select {
    width: 100%;
    border: 1px solid var(--card-border);
    border-radius: 10px;
    padding: 10px 10px;
    font-size: 14px;
  }
  .rowBtns {
    display:flex; gap:10px; margin-top: 10px;
  }
  .rowBtns button { flex:1; }
  table { width:100%; border-collapse:collapse; }
  th, td {
    padding: 10px 10px;
    border-top: 1px solid rgba(0,0,0,.08);
    font-size: 14px;
  }
  th { text-align:left; font-weight: 900; background: rgba(0,0,0,.03); }
  tr.active { outline: 2px solid rgba(90,120,255,.35); outline-offset:-2px; background: rgba(90,120,255,.08); }
  .badge {
    display:inline-block; padding: 3px 8px; border-radius: 999px; font-weight:900; font-size: 12px;
    border:1px solid rgba(0,0,0,.12);
  }
  .badge.sold { color: var(--sold); border-color: rgba(229,57,53,.35); background: rgba(229,57,53,.08); }
  .badge.available { color: #8a4f20; border-color: rgba(213,109,50,.35); background: rgba(213,109,50,.12); }
  /* zoom */
  .zoomViewport {
    position:relative;
    height: 260px;
    padding: 14px;
  }
  .zoomHost {
    position:absolute; left:14px; top:14px; right:14px; bottom:14px;
    border-radius: 14px;
    overflow:hidden;
    background:#fff;
  }
  .zoomHost svg { width:100%; height:100%; display:block; }
</style>
</head>
<body>
<header>
  <h1>Floorplan Admin</h1>
  <div class="topRight">
    <div class="pill">Synced: <span id="syncTime">—</span></div>
    <div class="pill">Event name&nbsp;&nbsp;<b id="eventName">—</b></div>
    <button id="btnPause">Pause sync</button>
    <button id="btnExport">Export CSV</button>
    <button id="btnImport">Import CSV</button>
    <button id="btnReset" class="danger">Reset all</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="cardHead">Plan</div>
    <div class="planViewport" id="planViewport">
      <div class="svgHost" id="svgHost"></div>

      <svg id="overlaySvg" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <line id="olLine" x1="0" y1="0" x2="0" y2="0" stroke="rgba(0,0,0,.65)" stroke-width="4" stroke-linecap="round"/>
        <circle id="olDot" cx="0" cy="0" r="7" fill="rgba(0,0,0,.78)"/>
      </svg>

      <div class="callout" id="callout" style="display:none">
        <div class="stand" id="coStand"></div>
        <div class="company" id="coCompany"></div>
      </div>
    </div>

    <div style="padding: 10px 14px; border-top:1px solid rgba(0,0,0,.1); display:flex; gap:18px; align-items:center;">
      <div><span class="badge sold">●</span> Sold</div>
      <div><span class="badge available">●</span> Available</div>
    </div>

    <div class="cardHead">Zoom</div>
    <div class="zoomViewport">
      <div class="zoomHost" id="zoomHost"></div>
      <div class="gridPad muted" style="position:absolute; left:14px; bottom:12px;">Select a stand to zoom in.</div>
    </div>
  </section>

  <aside class="card">
    <div class="gridPad">
      <div style="font-weight:900; margin-bottom: 8px;">Selected Stand</div>

      <label>Stand ID</label>
      <input id="standId" placeholder="Stand ID" disabled />

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
          <label>Status</label>
          <select id="status">
            <option value="available">Available</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div>
          <label>Company (sold only)</label>
          <input id="company" placeholder="Company name…"/>
        </div>
      </div>

      <div class="rowBtns">
        <button id="btnSave">Save</button>
        <button id="btnMarkAvailable" class="danger">Mark Available</button>
      </div>

      <div class="muted" style="margin-top:10px;">Click a stand on the plan or in the list to edit.</div>

      <div style="font-weight:900; margin-top: 16px;">Stands</div>
      <input id="search" class="search" placeholder="Search stand or company…" style="margin-top:10px; width:100%; border:1px solid var(--card-border); border-radius:12px; padding:12px;"/>
      <select id="filter" style="margin-top:10px;">
        <option value="all">All</option>
        <option value="sold">Sold</option>
        <option value="available">Available</option>
      </select>

      <div class="muted" id="count" style="margin-top:10px;">0 / 0</div>

      <div style="margin-top:10px; border:1px solid rgba(0,0,0,.08); border-radius:12px; overflow:hidden;">
        <table>
          <thead>
            <tr><th>Stand</th><th>Status</th><th>Company</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </aside>
</main>

<script>
(() => {
  const DEFAULT_BACKEND_BASE = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
const BACKEND_STORAGE_KEY = "floorplan_backend";

function backendBase() {
  let u = DEFAULT_BACKEND_BASE;
  try {
    const stored = localStorage.getItem(BACKEND_STORAGE_KEY);
    if (stored && stored.trim()) u = stored.trim();
  } catch (e) {}
  u = u.replace(/\/+$/, "");
  if (u.toLowerCase().endsWith("/stands")) u = u.slice(0, -"/stands".length);
  return u;
}

function standsEndpoint() {
  return backendBase() + "/stands";
}

  const SVG_URL = "event_plan.svg";
  const AVAILABLE = getComputedStyle(document.documentElement).getPropertyValue('--available').trim();
  const SOLD = getComputedStyle(document.documentElement).getPropertyValue('--sold').trim();

  const syncTime = document.getElementById('syncTime');
  const eventName = document.getElementById('eventName');

  const planViewport = document.getElementById('planViewport');
  const svgHost = document.getElementById('svgHost');
  const overlaySvg = document.getElementById('overlaySvg');
  const olLine = document.getElementById('olLine');
  const olDot = document.getElementById('olDot');
  const callout = document.getElementById('callout');
  const coStand = document.getElementById('coStand');
  const coCompany = document.getElementById('coCompany');

  const zoomHost = document.getElementById('zoomHost');

  const standIdEl = document.getElementById('standId');
  const statusEl = document.getElementById('status');
  const companyEl = document.getElementById('company');

  const btnSave = document.getElementById('btnSave');
  const btnMarkAvailable = document.getElementById('btnMarkAvailable');

  const searchEl = document.getElementById('search');
  const filterEl = document.getElementById('filter');
  const countEl = document.getElementById('count');
  const tbody = document.getElementById('tbody');

  const btnPause = document.getElementById('btnPause');

  let autoSync = true;
  let svgRoot = null;
  let zoomSvg = null;
  let zoomHighlight = null;

  let byId = new Map();
  let selectedId = '';
  let dirty = false;

  function normalizeStatus(s) {
    s = String(s||'').toLowerCase().trim();
    if (s === 'sold' || s === 'booked') return 'sold';
    return 'available';
  }

  async function fetchJson(url, opts) {
    const r = await fetch(url, Object.assign({cache:'no-store'}, opts||{}));
    if (!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  async function loadSvg() {
    const r = await fetch(SVG_URL + '?v=' + Date.now(), {cache:'no-store'});
    if (!r.ok) throw new Error('Failed to load SVG');
    const txt = await r.text();
    const doc = new DOMParser().parseFromString(txt, 'image/svg+xml');
    const svg = doc.documentElement;

    svg.removeAttribute('width'); svg.removeAttribute('height');
    svg.style.width='100%'; svg.style.height='100%';
    svg.setAttribute('preserveAspectRatio','xMidYMid meet');

    svgHost.innerHTML = '';
    svgHost.appendChild(svg);
    svgRoot = svg;

    svgRoot.addEventListener('click', (e) => {
      const t = e.target.closest('[id]');
      if (!t) return;
      const id = t.id;
      if (!byId.has(id)) return;
      selectStand(id);
    });

    syncOverlayViewBox();
    new ResizeObserver(syncOverlayViewBox).observe(planViewport);

    initZoom();
  }

  function syncOverlayViewBox() {
    const r = overlaySvg.getBoundingClientRect();
    overlaySvg.setAttribute('viewBox', `0 0 ${Math.max(1, Math.round(r.width))} ${Math.max(1, Math.round(r.height))}`);
  }

  function getNodeCenterInOverlayPx(node) {
    const vr = planViewport.getBoundingClientRect();
    const nr = node.getBoundingClientRect();
    const pad = parseFloat(getComputedStyle(planViewport).paddingLeft) || 0;
    const cx = (nr.left + nr.right)/2 - vr.left - pad;
    const cy = (nr.top + nr.bottom)/2 - vr.top - pad;
    return {x: cx, y: cy};
  }

  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

  function closestPointOnRect(px, py, rx, ry, rw, rh) {
    const cx = clamp(px, rx, rx+rw);
    const cy = clamp(py, ry, ry+rh);
    if (cx > rx && cx < rx+rw && cy > ry && cy < ry+rh) {
      const dl = Math.abs(cx-rx);
      const dr = Math.abs(rx+rw-cx);
      const dt = Math.abs(cy-ry);
      const db = Math.abs(ry+rh-cy);
      const m = Math.min(dl,dr,dt,db);
      if (m===dl) return {x: rx, y: cy};
      if (m===dr) return {x: rx+rw, y: cy};
      if (m===dt) return {x: cx, y: ry};
      return {x: cx, y: ry+rh};
    }
    return {x: cx, y: cy};
  }

  function clearOverlay() {
    callout.style.display='none';
    olLine.style.display='none';
    olDot.style.display='none';
  }

  function placeOverlay(node, standId, company) {
    if (!node) return clearOverlay();
    syncOverlayViewBox();

    coStand.textContent = standId;
    coCompany.textContent = (normalizeStatus(byId.get(standId)?.status)==='sold') ? (company||'') : '';
    callout.style.display='block';

    const cw = callout.offsetWidth;
    const ch = callout.offsetHeight;

    const vp = planViewport.getBoundingClientRect();
    const svgR = svgRoot.getBoundingClientRect();
    const anchor = getNodeCenterInOverlayPx(node);

    const overlayW = overlaySvg.getBoundingClientRect().width;
    const overlayH = overlaySvg.getBoundingClientRect().height;
    const inset = 12;

    const svgLeft = svgR.left - vp.left - 14;
    const svgTop = svgR.top - vp.top - 14;
    const svgRight = svgR.right - vp.left - 14;
    const svgBottom = svgR.bottom - vp.top - 14;

    const candidates = [];
    candidates.push({ x: clamp(anchor.x - cw/2, inset, overlayW - cw - inset), y: clamp(svgBottom + 12, inset, overlayH - ch - inset), score:0 });
    candidates.push({ x: clamp(anchor.x - cw/2, inset, overlayW - cw - inset), y: clamp(svgTop - ch - 12, inset, overlayH - ch - inset), score:0 });
    candidates.push({ x: clamp(svgLeft - cw - 12, inset, overlayW - cw - inset), y: clamp(anchor.y - ch/2, inset, overlayH - ch - inset), score:0 });
    candidates.push({ x: clamp(svgRight + 12, inset, overlayW - cw - inset), y: clamp(anchor.y - ch/2, inset, overlayH - ch - inset), score:0 });

    for (const c of candidates) {
      const insideX = (c.x + cw/2) >= svgLeft && (c.x + cw/2) <= svgRight;
      const insideY = (c.y + ch/2) >= svgTop && (c.y + ch/2) <= svgBottom;
      c.score = (insideX && insideY) ? 10 : 0;
      const ax = c.x + cw/2, ay = c.y + ch/2;
      const dx = ax - anchor.x, dy = ay - anchor.y;
      c.score += Math.sqrt(dx*dx + dy*dy) / 80;
    }
    candidates.sort((a,b)=>a.score-b.score);
    const best = candidates[0];

    callout.style.left = `${Math.round(best.x)}px`;
    callout.style.top = `${Math.round(best.y)}px`;

    const p = closestPointOnRect(anchor.x, anchor.y, best.x, best.y, cw, ch);

    olLine.style.display='';
    olDot.style.display='';
    olLine.setAttribute('x1', p.x);
    olLine.setAttribute('y1', p.y);
    olLine.setAttribute('x2', anchor.x);
    olLine.setAttribute('y2', anchor.y);

    olDot.setAttribute('cx', anchor.x);
    olDot.setAttribute('cy', anchor.y);
    olDot.setAttribute('r', '7');
  }

  function colorPlan() {
    if (!svgRoot) return;
    svgRoot.querySelectorAll('[id]').forEach(el => {
      const id = el.id;
      if (!byId.has(id)) return;
      const r = byId.get(id);
      el.style.fill = (normalizeStatus(r.status)==='sold') ? SOLD : AVAILABLE;
    });
  }

  function initZoom() {
    zoomHost.innerHTML='';
    zoomSvg = svgRoot.cloneNode(true);
    zoomSvg.removeAttribute('width'); zoomSvg.removeAttribute('height');
    zoomSvg.style.width='100%'; zoomSvg.style.height='100%';
    zoomSvg.setAttribute('preserveAspectRatio','xMidYMid meet');
    zoomSvg.querySelectorAll('*').forEach(el=>el.style.pointerEvents='none');
    // Force zoom view to black & white (no status fills)
    try {
      standIds.forEach(id => {
        const el = zoomSvg.querySelector('#' + CSS.escape(id));
        if (el) {
          el.style.fill = 'none';
          // keep outlines visible
          if (!el.style.stroke) el.style.stroke = '#000';
        }
      });
    } catch (e) {}

    zoomHost.appendChild(zoomSvg);

    // highlight overlay rect
    zoomHighlight = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    zoomHighlight.setAttribute('fill', 'none');
    zoomHighlight.setAttribute('stroke', 'rgba(0,0,0,.75)');
    zoomHighlight.setAttribute('stroke-width', '8');
    zoomHighlight.setAttribute('rx', '18');
    zoomHighlight.setAttribute('ry', '18');
    zoomHighlight.setAttribute('vector-effect', 'non-scaling-stroke');
    zoomHighlight.style.filter = 'drop-shadow(0 10px 14px rgba(0,0,0,.18))';
    zoomHighlight.style.display = 'none';
    zoomSvg.appendChild(zoomHighlight);
  }

  function updateZoom(standId) {
    if (!zoomSvg || !standId) return;
    const node = zoomSvg.querySelector('#' + CSS.escape(standId));
    if (!node) return;
    let bb;
    try { bb = node.getBBox(); } catch { return; }

    const pad = Math.max(30, Math.max(bb.width, bb.height) * 0.85);
    const x = bb.x - pad, y = bb.y - pad, w = bb.width + pad*2, h = bb.height + pad*2;
    zoomSvg.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);

    // circle/rounded-rect highlight around stand
    zoomHighlight.setAttribute('x', bb.x - 8);
    zoomHighlight.setAttribute('y', bb.y - 8);
    zoomHighlight.setAttribute('width', bb.width + 16);
    zoomHighlight.setAttribute('height', bb.height + 16);
    zoomHighlight.style.display = '';
  }

  function renderList() {
    const q = (searchEl.value||'').trim().toLowerCase();
    const f = filterEl.value;

    const rows = Array.from(byId.values()).filter(r => {
      if (f !== 'all' && normalizeStatus(r.status) !== f) return false;
      if (!q) return true;
      return (r.standId||'').toLowerCase().includes(q) || (r.company||'').toLowerCase().includes(q);
    }).sort((a,b)=>a.standId.localeCompare(b.standId));

    tbody.innerHTML = '';
    countEl.textContent = `${rows.length} / ${byId.size}`;

    for (const r of rows) {
      const tr = document.createElement('tr');
      if (r.standId === selectedId) tr.classList.add('active');
      tr.innerHTML = `
        <td>${escapeHtml(r.standId)}</td>
        <td><span class="badge ${normalizeStatus(r.status)}">${normalizeStatus(r.status)==='sold'?'Sold':'Available'}</span></td>
        <td>${escapeHtml(r.company||'')}</td>
      `;
      tr.addEventListener('click', () => selectStand(r.standId, true));
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  }

  function setForm(r) {
    standIdEl.value = r ? r.standId : '';
    statusEl.value = r ? normalizeStatus(r.status) : 'available';
    companyEl.value = r ? (r.company||'') : '';
  }

  function selectStand(id, scrollToRow) {
    selectedId = id || '';
    dirty = false;
    setForm(byId.get(selectedId) || null);

    colorPlan();
    renderList();

    if (!selectedId) {
      clearOverlay();
      if (zoomHighlight) zoomHighlight.style.display='none';
      return;
    }
    const node = svgRoot.querySelector('#' + CSS.escape(selectedId));
    const r = byId.get(selectedId);
    if (node && r) {
      placeOverlay(node, r.standId, r.company||'');
      updateZoom(selectedId);
    }
    if (scrollToRow) {
      const trs = Array.from(tbody.querySelectorAll('tr'));
      const tr = trs.find(t=>t.firstElementChild && t.firstElementChild.textContent===selectedId);
      if (tr) tr.scrollIntoView({block:'center'});
    }
  }

  async function syncOnce(forceMeta=false) {
    if (!autoSync) return;

    const data = await fetchJson(API_BASE + '/stands?ts=' + Date.now());
    byId = new Map((Array.isArray(data)?data:[]).map(x => {
      const standId = String(x.standId||'').trim();
      return [standId, {
        standId,
        status: normalizeStatus(x.status),
        company: String(x.company||'').trim()
      }];
    }));

    if (forceMeta) {
      try {
        const meta = await fetchJson(API_BASE + '/meta?ts=' + Date.now());
        if (meta && meta.eventName) eventName.textContent = meta.eventName;
      } catch {
        eventName.textContent = '—';
      }
    }

    syncTime.textContent = new Date().toLocaleTimeString();
    colorPlan();
    renderList();

    if (selectedId && !dirty) {
      const r = byId.get(selectedId);
      if (r) {
        setForm(r);
        const node = svgRoot.querySelector('#' + CSS.escape(selectedId));
        if (node) placeOverlay(node, r.standId, r.company||'');
        updateZoom(selectedId);
      }
    }
  }

  function formDirty() {
    if (!selectedId) return;
    dirty = true;
  }
  statusEl.addEventListener('change', formDirty);
  companyEl.addEventListener('input', formDirty);

  searchEl.addEventListener('input', renderList);
  filterEl.addEventListener('change', renderList);

  btnPause.addEventListener('click', () => {
    autoSync = !autoSync;
    btnPause.textContent = autoSync ? 'Pause sync' : 'Resume sync';
    if (autoSync) syncOnce(false).catch(()=>{});
  });

  async function saveStand(newStatus) {
    if (!selectedId) return;
    const status = newStatus || statusEl.value;
    const company = (status === 'sold') ? (companyEl.value || '').trim() : '';
    await fetchJson(API_BASE + '/stand', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ standId: selectedId, status, company })
    });
    dirty = false;
    await syncOnce(false);
  }

  btnSave.addEventListener('click', () => saveStand().catch(console.error));
  btnMarkAvailable.addEventListener('click', () => {
    statusEl.value='available';
    companyEl.value='';
    saveStand('available').catch(console.error);
  });

  // keep overlay in sync on resize/scroll
  window.addEventListener('resize', () => {
    syncOverlayViewBox();
    if (selectedId) {
      const node = svgRoot.querySelector('#' + CSS.escape(selectedId));
      const r = byId.get(selectedId);
      if (node && r) placeOverlay(node, r.standId, r.company||'');
    }
  });
  window.addEventListener('scroll', () => {
    if (!selectedId) return;
    const node = svgRoot.querySelector('#' + CSS.escape(selectedId));
    const r = byId.get(selectedId);
    if (node && r) placeOverlay(node, r.standId, r.company||'');
  }, {passive:true});

  (async () => {
    try {
      await loadSvg();
      await syncOnce(true);
      setInterval(() => syncOnce(false).catch(()=>{}), 8000);
    } catch (e) {
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
