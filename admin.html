<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Floorplan Admin</title>

<style>
  :root{
    --green:#2ecc71;
    --red:#e53935;
    --border:#d9d9d9;
    --muted:#666;
  }

  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;}
  header{
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
  }
  h1{margin:0;font-size:18px;font-weight:900;}
  #status{font-size:12px;color:var(--muted);}

  .btn{
    padding:8px 10px;
    border:1px solid var(--border);
    background:#f7f7f7;
    border-radius:8px;
    cursor:pointer;
    font-weight:800;
    font-size:13px;
  }
  .btn.green{background:#ecfff3;border-color:#bfe9cf;}
  .btn.red{background:#fff0f0;border-color:#f1bcbc;}
  .btn:disabled{opacity:.5;cursor:not-allowed;}

  .wrap{padding:12px;display:grid;grid-template-columns:2fr 1fr;gap:12px;}
  @media(max-width:1000px){.wrap{grid-template-columns:1fr;}}

  .card{border:1px solid var(--border);border-radius:14px;background:#fff;overflow:hidden;}
  .card h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:14px;}

  #planHost{padding:10px;overflow:auto;}
  #planHost svg{width:100%;height:auto;display:block;}

  /* Zoom panel */
  #zoomWrap{
    border-top:1px solid var(--border);
    padding:10px 12px;
  }
  #zoomHost{
    border:1px solid var(--border);
    border-radius:12px;
    height:240px;
    overflow:hidden;
    background:#fff;
  }

  .side{padding:12px;display:grid;gap:10px;}
  label{font-size:12px;font-weight:700;color:#444;}
  input,select{
    width:100%;padding:9px 10px;
    border:1px solid var(--border);
    border-radius:8px;
    font-size:14px;
  }
</style>
</head>

<body>

<header>
  <h1>Floorplan Admin</h1>
  <div>
    <span id="status">Loading…</span>
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <div class="card">
    <h2>Plan</h2>
    <div id="planHost"></div>

    <!-- ZOOM VIEW (RESTORED) -->
    <div id="zoomWrap">
      <strong style="font-size:13px;">Zoom view</strong>
      <div id="zoomHost"></div>
      <div style="font-size:12px;color:#666;margin-top:6px;">
        Select a stand to zoom in
      </div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h2>Selected stand</h2>
    <div class="side">
      <div>
        <label>Stand ID</label>
        <input id="standId" readonly>
      </div>

      <div>
        <label>Status</label>
        <select id="statusSel">
          <option value="available">Available</option>
          <option value="sold">Sold</option>
        </select>
      </div>

      <div>
        <label>Company (sold only)</label>
        <input id="company">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <button class="btn green" id="btnSave" disabled>Save</button>
        <button class="btn red" id="btnClear" disabled>Mark available</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {

  const API = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const SVG_URL = "./event_plan.svg";

  const planHost = document.getElementById("planHost");
  const zoomHost = document.getElementById("zoomHost");
  const statusEl = document.getElementById("status");

  const standIdEl = document.getElementById("standId");
  const statusSel = document.getElementById("statusSel");
  const companyEl = document.getElementById("company");
  const btnSave = document.getElementById("btnSave");
  const btnClear = document.getElementById("btnClear");

  let svgRoot = null;
  let zoomSvg = null;
  let stands = new Map();
  let selectedId = "";

  function setStatus(t,err){
    statusEl.textContent=t;
    statusEl.style.color=err?"#b00020":"#555";
  }

  function norm(v){return String(v||"").toLowerCase()==="sold"?"sold":"available";}

  async function fetchJson(url){
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    return r.json();
  }

  async function loadSvg(){
    const txt = await fetch(SVG_URL+"?v="+Date.now()).then(r=>r.text());
    planHost.innerHTML = txt;
    svgRoot = planHost.querySelector("svg");
    if(!svgRoot) throw new Error("SVG not found");
  }

  function paintAll(){
    if(!svgRoot) return;
    stands.forEach(s=>{
      const nodes = svgRoot.querySelectorAll("#"+CSS.escape(s.standId));
      nodes.forEach(n=>{
        n.style.fill = norm(s.status)==="sold" ? "#e53935" : "#2ecc71";
        n.style.fillOpacity = "0.75";
        n.style.stroke = "rgba(0,0,0,.5)";
      });
    });
  }

  /* ===== ZOOM LOGIC ===== */
  function initZoom(){
    zoomHost.innerHTML="";
    zoomSvg = svgRoot.cloneNode(true);
    zoomSvg.removeAttribute("width");
    zoomSvg.removeAttribute("height");
    zoomSvg.style.width="100%";
    zoomSvg.style.height="100%";
    zoomSvg.setAttribute("preserveAspectRatio","xMidYMid meet");

    zoomSvg.querySelectorAll("*").forEach(el=>{
      el.style.pointerEvents="none";
    });

    if(!zoomSvg.getAttribute("viewBox")){
      try{
        const b = svgRoot.getBBox();
        zoomSvg.setAttribute("viewBox",`${b.x} ${b.y} ${b.width} ${b.height}`);
      }catch{
        zoomSvg.setAttribute("viewBox","0 0 1000 1000");
      }
    }
    zoomHost.appendChild(zoomSvg);
  }

  function updateZoom(id){
    if(!zoomSvg || !svgRoot) return;
    const node = svgRoot.querySelector("#"+CSS.escape(id));
    if(!node) return;
    const bb = node.getBBox();
    const pad = Math.max(20, Math.max(bb.width,bb.height)*0.6);
    zoomSvg.setAttribute(
      "viewBox",
      `${bb.x-pad} ${bb.y-pad} ${bb.width+pad*2} ${bb.height+pad*2}`
    );
  }

  function selectStand(id){
    selectedId=id;
    const s = stands.get(id);
    if(!s) return;

    standIdEl.value=id;
    statusSel.value=norm(s.status);
    companyEl.value=s.company||"";
    btnSave.disabled=false;
    btnClear.disabled=false;

    paintAll();
    updateZoom(id);
  }

  async function sync(){
    setStatus("Syncing…");
    const data = await fetchJson(API+"/stands?ts="+Date.now());
    stands = new Map(data.map(s=>[
      String(s.standId),
      {standId:s.standId,status:s.status,company:s.company}
    ]));
    paintAll();
    setStatus("Ready");
  }

  async function save(){
    btnSave.disabled=true;
    await fetch(API+"/stand",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        standId:standIdEl.value,
        status:statusSel.value,
        company:companyEl.value
      })
    });
    await sync();
    btnSave.disabled=false;
  }

  async function clear(){
    statusSel.value="available";
    companyEl.value="";
    await save();
  }

  (async()=>{
    try{
      await loadSvg();
      initZoom();
      await sync();

      svgRoot.querySelectorAll("[id]").forEach(el=>{
        el.addEventListener("click",e=>{
          const id = el.id;
          if(stands.has(id)){
            e.preventDefault();
            selectStand(id);
          }
        });
      });

    }catch(e){
      setStatus("Error: "+e.message,true);
      console.error(e);
    }
  })();

  btnSave.onclick=save;
  btnClear.onclick=clear;

})();
</script>
</body>
</html>
