<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Floorplan Admin</title>
<style>
  :root{
    --bg:#f6f7f9;
    --card:#fff;
    --border:#e3e5ea;
    --text:#111;
    --muted:#666;
    --sold:#e74c3c;
    --avail:#2ecc71;
    --btn:#f2f3f5;
    --btnText:#111;
    --btnBorder:#d7d9df;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px 16px;background:#fff;border-bottom:1px solid var(--border);
  }
  header .title{font-weight:900;font-size:18px}
  header .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .statusLine{font-size:13px;color:var(--muted)}
  .btn{
    border:1px solid var(--btnBorder);
    background:var(--btn);
    color:var(--btnText);
    padding:6px 10px;border-radius:6px;
    font-weight:800;font-size:13px;
    cursor:pointer;
  }
  .btn:hover{filter:brightness(.98)}
  .btn.danger{background:#ffecec;border-color:#f2b9b9}
  .btn.ghost{background:#fff}
  main{padding:12px;max-width:1400px;margin:0 auto}
  .grid{
    display:grid;
    grid-template-columns: 1.7fr 1fr;
    gap:12px;
    align-items:start;
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
  }
  .card h3{
    margin:0 0 10px 0;
    font-size:13px;
    color:#333;
    font-weight:900;
  }
  .planBox{
    width:100%;
    height:min(58vh, 560px);
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    overflow:hidden;
  }
  .zoomBox{
    width:100%;
    height:220px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    overflow:hidden;
  }
  .planBox svg, .zoomBox svg{width:100%;height:100%}
  .legend{
    display:flex;gap:14px;align-items:center;flex-wrap:wrap;
    margin-top:10px;padding-top:10px;border-top:1px solid var(--border);
    font-size:13px;color:#444;
  }
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
  .dot.sold{background:rgba(231,76,60,.9)}
  .dot.avail{background:rgba(46,204,113,.9)}

  .panelTitle{font-weight:900;font-size:14px;margin:0 0 8px}
  label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin:10px 0 6px}
  input[type="text"], input[type="password"], select{
    width:100%;
    border:1px solid var(--border);
    border-radius:8px;
    padding:8px 10px;
    font-size:14px;
    background:#fff;
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .actions{display:flex;gap:10px;margin-top:10px}
  .actions .btn{flex:1}
  .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.3}
  .divider{height:1px;background:var(--border);margin:12px 0}

  /* Stands list */
  .standsTop{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
  }
  .standsTop input{flex:1;min-width:220px}
  .standsMeta{font-size:12px;color:var(--muted);margin-top:8px}
  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
  th,td{padding:8px 8px;border-bottom:1px solid var(--border);text-align:left}
  th{font-size:12px;color:var(--muted)}
  tr{cursor:pointer}
  tr:hover{background:#f6f7fb}
  tr.selected{background:#eef3ff}
  .badge{
    display:inline-block;
    padding:3px 8px;border-radius:999px;
    font-weight:900;font-size:12px;
    border:1px solid var(--border);
    background:#fff;
  }
  .badge.sold{color:var(--sold);border-color:#f2b9b9;background:#ffecec}
  .badge.avail{color:var(--avail);border-color:#bfe9cc;background:#ecfff3}

  /* prevent SVG text selection/edit weirdness */
  svg text{user-select:none;-webkit-user-select:none;pointer-events:none;}
</style>
</head>
<body>

<header>
  <div class="title">Floorplan Admin</div>
  <div class="right">
    <span class="statusLine" id="syncLabel">Loading…</span>
    <button class="btn ghost" id="pauseBtn">Pause sync</button>
    <button class="btn ghost" id="exportBtn">Export CSV</button>
    <button class="btn ghost" id="importBtn">Import CSV</button>
    <button class="btn danger" id="resetBtn">Reset all</button>
  </div>
</header>

<main>
  <div class="grid">

    <!-- LEFT COLUMN -->
    <div>
      <div class="card">
        <h3>Plan</h3>
        <div class="planBox" id="svgHost"></div>

        <div class="legend">
          <span><span class="dot sold"></span> Sold</span>
          <span><span class="dot avail"></span> Available</span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Zoom</h3>
        <div class="zoomBox" id="zoomHost"></div>
        <div class="hint">Select a stand to zoom in.</div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="card">
        <div class="panelTitle">Selected Stand</div>

        <label>Stand ID</label>
        <input id="standId" type="text" readonly />

        <div class="row">
          <div>
            <label>Status</label>
            <select id="standStatus">
              <option value="available">Available</option>
              <option value="sold">Sold</option>
            </select>
          </div>
          <div>
            <label>Company (sold only)</label>
            <input id="standCompany" type="text" placeholder="Company name…" />
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn" id="markAvailBtn">Mark Available</button>
        </div>

        <div class="hint">
          Click a stand on the plan or in the list to edit.
          Auto-sync won't overwrite your form while you're typing.
        </div>

        <div class="divider"></div>

        <div class="panelTitle">Stands</div>
        <div class="standsTop">
          <input id="search" type="text" placeholder="Search stand or company…" />
          <select id="filter">
            <option value="all">All</option>
            <option value="available">Available</option>
            <option value="sold">Sold</option>
          </select>
        </div>

        <div class="standsMeta" id="countLabel"></div>

        <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th style="width:70px;">Stand</th>
                <th style="width:95px;">Status</th>
                <th>Company</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</main>

<script>
(() => {
  // ---- CONFIG ----
  const SHEET_API_URL = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev'; // Cloudflare Worker
  const ADMIN_PASSWORD = 'FLOORPASS1'; // set this
  const SYNC_INTERVAL_MS = 20000;

  // ---- Safari: CSS.escape polyfill ----
  if (!window.CSS) window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (value) {
      return String(value).replace(/[^a-zA-Z0-9_\\-]/g, function (ch) {
        const hex = ch.codePointAt(0).toString(16).toUpperCase();
        return '\\\\' + hex + ' ';
      });
    };
  }

  // ---- Elements ----
  const svgHost = document.getElementById('svgHost');
  const zoomHost = document.getElementById('zoomHost');

  const syncLabel = document.getElementById('syncLabel');
  const pauseBtn = document.getElementById('pauseBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');

  const standIdEl = document.getElementById('standId');
  const standStatusEl = document.getElementById('standStatus');
  const standCompanyEl = document.getElementById('standCompany');
  const saveBtn = document.getElementById('saveBtn');
  const markAvailBtn = document.getElementById('markAvailBtn');

  const searchEl = document.getElementById('search');
  const filterEl = document.getElementById('filter');
  const rowsEl = document.getElementById('rows');
  const countLabel = document.getElementById('countLabel');

  // ---- State ----
  let svgRoot = null;
  let zoomSvgRoot = null;
  let byId = new Map();
  let selected = null;
  let paused = false;
  let unlocked = false;

  // prevent sync overwriting form while user typing
  let isEditing = false;
  let editTimer = 0;

  const bboxCache = new Map();

  function normalizeStatus(v){
    v = String(v||'').toLowerCase().trim();
    return v === 'sold' ? 'sold' : 'available';
  }

  function isStandId(id){
    return /^[A-Z]{1,3}\\d{1,3}$/i.test(id || '');
  }

  function setSyncLabel(text, isErr=false){
    syncLabel.textContent = text;
    syncLabel.style.color = isErr ? '#b00020' : '#444';
  }

  function markEditing(){
    isEditing = true;
    clearTimeout(editTimer);
    editTimer = setTimeout(()=>{ isEditing = false; }, 1200);
  }

  function getStandNodes(root){
    if(!root) return [];
    const groups = Array.from(root.querySelectorAll('g[id]')).filter(el=>isStandId(el.id));
    const shapes = Array.from(root.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id]')).filter(el=>isStandId(el.id));
    return groups.length ? groups : shapes;
  }

  function paintNode(root, standId, status){
    const node = root.querySelector('#' + CSS.escape(standId));
    if(!node) return;
    const fill = (status === 'sold')
      ? 'rgba(231,76,60,0.75)'
      : 'rgba(46,204,113,0.75)';

    try{
      if(node.tagName.toLowerCase() === 'g'){
        node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch => ch.style.fill = fill);
      }else{
        node.style.fill = fill;
      }
    }catch{}
  }

  function clearStrokeHighlights(){
    getStandNodes(svgRoot).forEach(n=>{
      try{
        if(n.tagName.toLowerCase()==='g'){
          n.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch=>{
            ch.style.stroke=''; ch.style.strokeWidth='';
          });
        }else{
          n.style.stroke=''; n.style.strokeWidth='';
        }
      }catch{}
    });
  }

  function highlightSelected(id){
    clearStrokeHighlights();
    if(!id) return;
    const n = svgRoot.querySelector('#' + CSS.escape(id));
    if(!n) return;
    try{
      if(n.tagName.toLowerCase()==='g'){
        n.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch=>{
          ch.style.stroke='#111'; ch.style.strokeWidth='3px';
        });
      }else{
        n.style.stroke='#111'; n.style.strokeWidth='3px';
      }
    }catch{}
  }

  function getBBoxFor(standId){
    if(bboxCache.has(standId)) return bboxCache.get(standId);
    const node = svgRoot.querySelector('#' + CSS.escape(standId));
    if(!node) return null;
    try{
      const bb = node.getBBox();
      bboxCache.set(standId, bb);
      return bb;
    }catch{
      return null;
    }
  }

  function updateZoom(standId){
    if(!zoomSvgRoot) return;
    const bb = getBBoxFor(standId);
    if(!bb) return;

    const pad = Math.max(20, Math.min(bb.width, bb.height) * 0.45);
    const x = bb.x - pad;
    const y = bb.y - pad;
    const w = bb.width + pad*2;
    const h = bb.height + pad*2;
    zoomSvgRoot.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
  }

  function selectStand(standId){
    selected = standId;
    const info = byId.get(standId);
    if(!info) return;

    standIdEl.value = info.standId;
    standStatusEl.value = info.status === 'sold' ? 'sold' : 'available';
    standCompanyEl.value = info.company || '';

    highlightSelected(standId);
    updateZoom(standId);
    renderList();
  }

  function bindPlanClicks(){
    // Click handling (fast and simple)
    getStandNodes(svgRoot).forEach(node=>{
      const id = node.id;
      if(!isStandId(id)) return;
      try{ node.style.cursor='pointer'; }catch{}
      node.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        selectStand(id);
      });
    });
  }

  async function loadSvgInto(host){
    const res = await fetch('event_plan.svg', { cache:'no-store' });
    if(!res.ok) throw new Error('Failed to load event_plan.svg');
    const txt = await res.text();
    host.innerHTML = txt;
    const root = host.querySelector('svg');
    if(!root) throw new Error('SVG root not found');
    // ensure viewBox exists for zooming
    if(!root.getAttribute('viewBox')){
      const w = root.getAttribute('width') || 1000;
      const h = root.getAttribute('height') || 600;
      root.setAttribute('viewBox', `0 0 ${w} ${h}`);
    }
    return root;
  }

  async function fetchAll(){
    const res = await fetch(SHEET_API_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('Failed to fetch data');
    const arr = await res.json();
    byId = new Map();
    arr.forEach(r=>{
      const standId = String(r.standId||'').trim();
      if(!standId) return;
      byId.set(standId, {
        standId,
        status: normalizeStatus(r.status),
        company: String(r.company||'').trim()
      });
    });
  }

  function paintAll(){
    byId.forEach((info, id)=>{
      if(svgRoot) paintNode(svgRoot, id, info.status);
      if(zoomSvgRoot) paintNode(zoomSvgRoot, id, info.status);
    });
    if(selected) highlightSelected(selected);
  }

  function renderList(){
    const q = (searchEl.value||'').trim().toLowerCase();
    const f = filterEl.value;

    const rows = Array.from(byId.values()).filter(r=>{
      if(f !== 'all' && r.status !== f) return false;
      if(!q) return true;
      return r.standId.toLowerCase().includes(q) || (r.company||'').toLowerCase().includes(q);
    }).sort((a,b)=>a.standId.localeCompare(b.standId));

    countLabel.textContent = `${rows.length} / ${byId.size}`;

    rowsEl.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      if(r.standId === selected) tr.classList.add('selected');

      const badge = r.status === 'sold'
        ? `<span class="badge sold">Sold</span>`
        : `<span class="badge avail">Available</span>`;

      tr.innerHTML = `
        <td><strong>${r.standId}</strong></td>
        <td>${badge}</td>
        <td>${(r.company||'')}</td>
      `;
      tr.addEventListener('click', ()=>selectStand(r.standId));
      rowsEl.appendChild(tr);
    });
  }

  async function saveCurrent(){
    if(!unlocked){ alert('Admin locked. Reload and enter password.'); return; }
    if(!selected){ alert('Select a stand first.'); return; }

    const status = standStatusEl.value;
    const company = (status === 'sold') ? (standCompanyEl.value||'') : '';

    const payload = { standId:selected, status, company };

    const res = await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('Save failed');
    await syncOnce(true);
  }

  async function markAvailable(){
    if(!unlocked){ alert('Admin locked. Reload and enter password.'); return; }
    if(!selected){ alert('Select a stand first.'); return; }
    standStatusEl.value = 'available';
    standCompanyEl.value = '';
    await saveCurrent();
  }

  function toCsv(rows){
    return rows.map(r => r.map(v => {
      const s = String(v ?? '');
      return (s.includes(',') || s.includes('"') || s.includes('\\n')) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\\n');
  }

  function exportCsv(){
    const rows = [['Stand','Status','Company']];
    Array.from(byId.values()).sort((a,b)=>a.standId.localeCompare(b.standId)).forEach(r=>{
      rows.push([r.standId, r.status, r.company||'']);
    });
    const blob = new Blob([toCsv(rows)], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'stands_snapshot.csv';
    a.click();
  }

  function importCsv(){
    if(!unlocked){ alert('Admin locked. Reload and enter password.'); return; }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,text/csv';
    input.onchange = async () => {
      if(!input.files || !input.files[0]) return;
      const text = await input.files[0].text();
      const lines = text.split(/\\r?\\n/).filter(Boolean);
      const rows = lines.slice(1).map(l=>{
        // basic CSV parsing for our export format
        const parts = l.split(',');
        const standId = (parts[0]||'').replace(/^"|"$/g,'').trim();
        const status = (parts[1]||'').replace(/^"|"$/g,'').trim();
        const company = parts.slice(2).join(',').replace(/^"|"$/g,'').trim();
        return {standId, status, company};
      }).filter(r=>r.standId);

      for(const r of rows){
        await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify({
          standId: r.standId,
          status: r.status,
          company: r.company
        })});
      }
      await syncOnce(true);
    };
    input.click();
  }

  async function resetAll(){
    if(!unlocked){ alert('Admin locked. Reload and enter password.'); return; }
    const pw = prompt('Type admin password to confirm reset:');
    if(pw !== ADMIN_PASSWORD){ alert('Wrong password'); return; }

    const stands = Array.from(byId.values());
    for(const s of stands){
      await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify({
        standId: s.standId,
        status: 'available',
        company: ''
      })});
    }
    await syncOnce(true);
  }

  async function syncOnce(force=false){
    if(paused && !force) return;
    try{
      setSyncLabel('Syncing…');
      await fetchAll();
      paintAll();
      // don't overwrite form while user is typing
      if(!isEditing){
        if(selected && byId.has(selected)){
          const info = byId.get(selected);
          standStatusEl.value = info.status;
          standCompanyEl.value = info.company || '';
        }
      }
      renderList();
      setSyncLabel('Synced: ' + new Date().toLocaleTimeString());
    }catch(e){
      console.error(e);
      setSyncLabel('Sync error: ' + e.message, true);
    }
  }

  // ---- wire events ----
  pauseBtn.addEventListener('click', ()=>{
    paused = !paused;
    pauseBtn.textContent = paused ? 'Resume sync' : 'Pause sync';
    if(!paused) syncOnce(true);
  });

  exportBtn.addEventListener('click', exportCsv);
  importBtn.addEventListener('click', importCsv);
  resetBtn.addEventListener('click', ()=>resetAll().catch(err=>alert(err.message)));

  saveBtn.addEventListener('click', ()=>saveCurrent().catch(err=>alert(err.message)));
  markAvailBtn.addEventListener('click', ()=>markAvailable().catch(err=>alert(err.message)));

  [standStatusEl, standCompanyEl].forEach(el=>{
    el.addEventListener('input', markEditing);
    el.addEventListener('change', markEditing);
  });

  searchEl.addEventListener('input', renderList);
  filterEl.addEventListener('change', renderList);

  // ---- boot ----
  (async ()=>{
    const pw = prompt('Admin password:');
    if(pw !== ADMIN_PASSWORD){
      alert('Wrong password');
      return;
    }
    unlocked = true;

    try{
      svgRoot = await loadSvgInto(svgHost);
      zoomSvgRoot = await loadSvgInto(zoomHost);

      // keep zoom non-interactive
      try{ zoomHost.style.pointerEvents='none'; }catch{}

      bindPlanClicks();
      await syncOnce(true);
      setInterval(()=>syncOnce(false), SYNC_INTERVAL_MS);
    }catch(e){
      console.error(e);
      setSyncLabel('Load error: ' + e.message, true);
    }
  })();
})();
</script>
</body>
</html>
