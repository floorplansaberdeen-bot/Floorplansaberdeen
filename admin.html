<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Floorplan Admin</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e9e9e9;
      --text:#111;
      --muted:#666;
      --avail: rgba(213,109,50,0.75);
      --sold:#e63b3b;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --dot: 10px; /* dot DIAMETER (match public) */
      --line: rgba(0,0,0,.70);
      --safe: env(safe-area-inset-bottom, 0px);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--text);
    }
    header{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
      background:#fff;
    }
    header .title{ font-weight:900; font-size:18px; }
    header .tools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    header input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      min-width: 260px;
      font-weight:700;
    }
    button{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    button.primary{
      background:#16a34a;
      border-color:#16a34a;
      color:#fff;
    }
    button.primary:hover{ filter: brightness(0.95); }
    button.primary:active{ filter: brightness(0.9); }
    button.danger{ border-color:#ffd0d0; background:#fff5f5; }
    button.danger.solid{
      background:#e63b3b;
      border-color:#e63b3b;
      color:#fff;
    }
    button.danger.solid:hover{ filter: brightness(0.95); }
    button.danger.solid:active{ filter: brightness(0.9); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    main{
      padding:16px;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .cardHead{
      padding:10px 12px;
      font-weight:900;
      border-bottom:1px solid var(--border);
    }
    .planCard{ overflow:hidden; }
    .planBody{ padding:12px; }

    /* ===== Plan + Label bay + Callout overlay ===== */
    .planStack{ position:relative; border-radius:14px; overflow:hidden; background:#fff; }
    .planWrap{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      min-height:420px;
    }
    .svgHost{ width:100%; height:auto; display:block; pointer-events:auto; }

    /* Overlay spans BOTH plan + label bay */
    .calloutSvg{
      position:absolute; left:0; top:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    .labelBay{
      background:#fff;
      border-top:1px solid var(--border);
      padding:12px;
      min-height:72px;
    }
    .lozenge{
      display:inline-block;
      background:#fff;
      border-radius:999px;
      padding:12px 16px;
      box-shadow: var(--shadow);
      border:1px solid rgba(0,0,0,.08);
      max-width: 340px;
    }
    .lozStand{ font-size:28px; font-weight:900; line-height:1.1; }
    .lozCompany{ margin-top:4px; font-size:16px; font-weight:800; opacity:.9; }

    .legend{ padding:10px 12px; display:flex; gap:10px; align-items:center; border-top:1px solid var(--border); }
    .pill{ display:flex; align-items:center; gap:8px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; }
    .sw{ width:10px; height:10px; border-radius:999px; display:inline-block; }

    .zoomCard .cardHead{ display:flex; justify-content:space-between; }
    .zoomBody{ padding:12px; }
    .zoomWrap{
      position:relative;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      min-height:260px;
      background:#fff;
    }
    .zoomSvgHost{ width:100%; height:auto; display:block; }
    .zoomRing{
      position:absolute;
      border:4px solid rgba(0,0,0,.75);
      border-radius:999px;
      pointer-events:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
      display:none;
    }
    .hint{ color:var(--muted); font-size:13px; padding:10px 12px 12px; }

    .side{ padding:12px; display:flex; flex-direction:column; gap:12px; }
    .formRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .side label{ display:block; font-weight:800; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .side input, .side select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      font-weight:700;
    }
    .btnRow{ display:flex; gap:10px; }
    .btnRow button{ flex:1; }

    .tableWrap{ border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    .tableTools{ padding:10px; display:flex; gap:10px; align-items:center; }
    .tableTools input{
      flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      font-weight:800;
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ padding:10px 10px; border-top:1px solid #f0f0f0; text-align:left; }
    th{ background:#fafafa; border-top:none; font-size:12px; color:var(--muted); }
    tr.active{ background:#f5f8ff; outline:2px solid #c9d5ff; outline-offset:-2px; }
    .badge{ display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid var(--border); }
    .bSold{ color:#b40000; border-color:#ffd0d0; background:#fff5f5; }
    .bAvail{ color:#6b3a0f; border-color:#f2dfcf; background:#fff7f0; }

    .toast{
      position:fixed;
      left:16px; right:16px; bottom:16px;
      background:#111; color:#fff;
      padding:12px 14px;
      border-radius:14px;
      display:none;
      z-index:9999;
      box-shadow: var(--shadow);
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .toast .msg{ font-weight:800; font-size:13px; line-height:1.3; }
    .toast .actions{ display:flex; gap:10px; }
    .toast button{ background:#fff; }

    
    
    @media (min-width: 981px){
      /* Keep the whole right panel visible; only the stands list area scrolls */
      .side{
        position: sticky;
        top: 12px;
        max-height: calc(100vh - 24px);
        overflow: hidden;          /* IMPORTANT: prevent whole panel scrolling */
      }
      .standsCard{
        display:flex;
        flex-direction:column;
        min-height: 0;             /* allow inner scrolling */
        flex: 1;
      }
      .standsCard .tableWrap{
        flex: 1;
        overflow: auto;            /* ONLY the list scrolls */
      }
    }

    }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }
    @media (max-width: 640px){
      main{ grid-template-columns: 1fr; padding:12px; gap:12px; }
      header input{ min-width: 180px; width: 100%; }
      .planWrap{ min-height: 260px; }

      /* Reduce empty white space under the plan on phone */
      .planBody{ padding:8px; }
      .planWrap{ min-height: 0 !important; }
      .planStack{ padding-bottom: 0; }
      .labelBay{ min-height: 0; padding:8px; }

      /* When nothing is selected, collapse the label bay entirely (Safari-safe, no :has) */
      .planStack.noSel .labelBay{
        padding:0;
        min-height:0;
        border-top:0;
      }

      /* Hide zoom on phone */
      .zoomCard{ display:none; }

      /* Pin plan + selected stand at top */
      .planCard{
        position: sticky;
        top: 0;
        z-index: 30;
        background: var(--bg);
      }
      #selectedCard{
        position: sticky;
        top: 330px; /* will be corrected in JS on load/resize */
        z-index: 29;
        background: var(--bg);
      }

      /* Make the stands list area scroll under pinned panels */
      #standsCard{ max-height: none; }
      #tableWrap{
        max-height: 55vh; /* will be corrected in JS on load/resize */
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: calc(18px + var(--safe));
      }

      /* Extra safe-area padding so browser bar doesn’t block last row */
      .tableWrap{ padding-bottom: calc(18px + var(--safe)); }
    }

  .progressOverlay{
  position:fixed; inset:0;
  background: rgba(255,255,255,.75);
  backdrop-filter: blur(2px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
}
.progressCard{
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow: var(--shadow);
  padding:14px 16px;
  width:min(420px, 100%);
}
.progressTitle{ font-weight:950; font-size:14px; }
.progressMsg{ margin-top:6px; color:var(--muted); font-weight:800; font-size:13px; line-height:1.35; }
.progressBar{
  margin-top:12px;
  height:10px;
  border-radius:999px;
  background:#f2f2f2;
  overflow:hidden;
  border:1px solid rgba(0,0,0,.06);
}
.progressBar > div{
  height:100%;
  width:0%;
  background:#111;
  border-radius:999px;
  transition: width .15s ease;
}
  #undoBtn:disabled{opacity:.5;cursor:not-allowed;}
</style>
</head>
<body>
  <header>
    <div class="title">Floorplan Admin</div>
    <div class="tools">
      <div style="color:var(--muted); font-weight:800;">Synced: <span id="syncedAt">—</span></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-weight:900;">Event name</div>
        <input id="eventName" placeholder="New Event" />
        <button id="setEventBtn" class="primary" title="Save event name">Set</button>
      </div>
      <button id="pauseBtn">Pause sync</button>
      <button id="exportBtn">Export CSV</button>
      <button id="importBtn">Import CSV</button>
      <button class="danger" id="resetBtn">Reset all</button>
    </div>
  </header>

  <main>
    <section class="card planCard">
      <div class="cardHead">Plan</div>
      <div class="planBody">
        <div class="planStack noSel" id="planStack">
          <div class="planWrap" id="planWrap">
            <div id="svgHost" class="svgHost"></div>
          </div>

          <div class="labelBay" id="labelBay">
            <div class="lozenge" id="lozenge" style="display:none;">
              <div class="lozStand" id="lozStand">—</div>
              <div class="lozCompany" id="lozCompany" style="display:none;"></div>
            </div>
          </div>

          <!-- ONE overlay only, spanning plan + label bay -->
          <svg class="calloutSvg" id="calloutSvg" aria-hidden="true"></svg>
        </div>
      </div>

      <div class="legend">
        <div class="pill"><span class="sw" style="background:var(--sold)"></span>Sold</div>
        <div class="pill"><span class="sw" style="background:var(--avail)"></span>Available</div>
      </div>

      <section class="card zoomCard" style="margin:12px;">
        <div class="cardHead">Zoom</div>
        <div class="zoomBody">
          <div class="zoomWrap" id="zoomWrap">
            <div id="zoomSvgHost" class="zoomSvgHost"></div>
            <div class="zoomRing" id="zoomRing"></div>
          </div>
          <div class="hint">Select a stand to zoom in.</div>
        </div>
      </section>
    </section>

    <aside class="card side">
      <div class="card" id="selectedCard" style="border:1px solid var(--border); border-radius:14px; padding:12px;">
        <div style="font-weight:900; margin-bottom:10px;">Selected Stand</div>

        <div style="margin-bottom:10px;">
          <label>Stand ID</label>
          <input id="standId" disabled />
        </div>

        <div class="formRow" style="margin-bottom:10px;">
          <div>
            <label>Status</label>
            <select id="status">
              <option value="available">Available</option>
              <option value="sold">Sold</option>
            </select>
          </div>
          <div>
            <label>Company (sold only)</label>
            <input id="company" placeholder="Company name…" />
          </div>
        </div>

        <div class="btnRow">
          <button id="saveBtn" class="primary">Save</button>
          <button id="markAvailBtn" class="danger solid">Mark Available</button>
        </div>
        <div class="btnRow" style="margin-top:10px;">
          <button id="undoBtn" class="solid" style="background:#f3f4f6;color:#111;border:1px solid #e5e7eb;" disabled>Undo (0)</button>
        </div>

        <div class="hint" style="padding:10px 0 0;">Click a stand on the plan or in the list to edit.</div>
      </div>

      <div class="card standsCard" style="border:1px solid var(--border); border-radius:14px;">
        <div class="cardHead">Stands</div>
        <div class="tableTools">
          <input id="search" placeholder="Search stand or company…" />
          <select id="filter" style="width:120px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); font-weight:800;">
            <option value="all">All</option>
            <option value="sold">Sold</option>
            <option value="available">Available</option>
          </select>
        </div>
        <div style="padding:0 12px 10px; color:var(--muted); font-weight:800;"><span id="count">0</span> / <span id="total">0</span></div>
        <div class="tableWrap" id="tableWrap">
          <table>
            <thead>
              <tr><th style="width:90px;">Stand</th><th style="width:120px;">Status</th><th>Company</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

<div class="progressOverlay" id="progressOverlay" aria-hidden="true">
  <div class="progressCard">
    <div class="progressTitle" id="progressTitle">Updating…</div>
    <div class="progressMsg" id="progressMsg">Please keep this tab open.</div>
    <div class="progressBar"><div id="progressBarFill"></div></div>
  </div>
</div>

  <div class="toast" id="toast">
    <div class="msg" id="toastMsg">Can't reach the backend right now. If Cloudflare is down, you can paste your Google Apps Script Web App URL instead.</div>
    <div class="actions">
      <button id="setBackendBtn">Set backend URL</button>
      <button id="hideToastBtn">Hide</button>
    </div>
  </div>


   <script src="./shared.js?v=2" defer></script>
<script src="./admin.js?v=2" defer></script>
</body>
</html>
