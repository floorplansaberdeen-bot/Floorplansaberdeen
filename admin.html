<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Floorplan Admin</title>
<style>
  :root{
    --border:#d9d9d9;
    --bg:#f6f7f9;
    --card:#fff;
    --text:#111;
    --muted:#666;
    --sold:#e74c3c;
    --avail:#2ecc71;
    --warn:#ffb020;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:18px 18px 10px;font-weight:900;font-size:18px}
  .wrap{max-width:1300px;margin:0 auto;padding:0 12px 24px}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1.6fr 1fr;align-items:start}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer}
  .btn:hover{background:#f3f3f3}
  .btnPrimary{background:#111;color:#fff;border-color:#111}
  .btnPrimary:hover{background:#000}
  .btnDanger{background:#ffecec;border-color:#f2b9b9}
  .btnDanger:hover{background:#ffdede}
  input[type="text"], input[type="password"], select{
    width:100%;
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 10px;
    font-weight:700;
  }
  label{font-size:13px;color:var(--muted);font-weight:800}
  small{color:var(--muted)}
  #svgHost{width:100%;height:min(72vh,720px);overflow:hidden;border-radius:12px;border:1px solid var(--border);background:#fff}
  #svgHost svg{width:100%;height:100%}
  #tooltip{position:fixed;z-index:50;display:none;pointer-events:none;background:#111;color:#fff;padding:8px 10px;border-radius:10px;font-size:13px;max-width:260px;box-shadow:0 8px 22px rgba(0,0,0,.18)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:7px 8px;border-bottom:1px solid var(--border);text-align:left}
  thead th{font-size:12px;color:var(--muted)}
  tr:hover{background:#f6f6f8}
  tr.selected{background:#eef3ff}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-weight:900;font-size:12px}
  .pill.active{background:#111;color:#fff;border-color:#111}
  .status{font-size:13px;color:var(--muted)}
  .tagSold{color:var(--sold);font-weight:900}
  .tagAvail{color:var(--avail);font-weight:900}
  .tagNone{color:#999;font-weight:900}
  .hint{font-size:12.5px;color:var(--muted);line-height:1.35}
  .twoCol{display:grid;gap:10px}
  @media(min-width:980px){.twoCol{grid-template-columns:1fr 1fr}}
  .divider{height:1px;background:var(--border);margin:10px 0}
  .stickyRight{position:sticky;top:12px}
  .scrollBox{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px}
</style>
</head>
<body>
<header>Floorplan Admin</header>

<div class="wrap">
  <div class="grid">

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="status" id="status">Loading…</span>
        </div>
        <div class="row">
          <button class="btn" id="exportBtn">Export CSV</button>
          <button class="btn" id="importBtn">Import CSV</button>
          <button class="btn btnDanger" id="resetBtn">Reset All</button>
        </div>
      </div>

      <div id="svgHost" style="margin-top:10px;"></div>

      <div class="divider"></div>

      <div class="twoCol">
        <div>
          <label>Selected stand</label>
          <input id="standId" type="text" disabled />
          <small class="hint">Click a stand on the plan or click a row in the list.</small>
        </div>

        <div>
          <label>Status</label>
          <select id="standStatus">
            <option value="available">available</option>
            <option value="sold">sold</option>
          </select>
        </div>

        <div style="grid-column:1/-1;">
          <label>Company (only used when sold)</label>
          <input id="standCompany" type="text" placeholder="Company name" />
        </div>

        <div class="row" style="grid-column:1/-1;justify-content:flex-end;">
          <button class="btn btnPrimary" id="saveBtn">Save</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <button class="pill active" id="listAll">All</button>
          <button class="pill" id="listAvail">Available</button>
          <button class="pill" id="listSold">Sold</button>
        </div>
        <div class="row">
          <input id="search" type="text" placeholder="Search stand or company…" style="min-width:220px;" />
        </div>
      </div>

      <div class="scrollBox" style="margin-top:10px;">
        <table id="standTable">
          <thead>
            <tr>
              <th style="width:80px;">Stand</th>
              <th style="width:110px;">Status</th>
              <th>Company</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>

    <div class="card stickyRight">
      <div style="font-weight:900;margin-bottom:6px;">Zoom preview</div>
      <div class="hint" style="margin-bottom:10px;">Shows a zoomed view of the currently selected stand.</div>
      <div id="zoomHost" style="width:100%;height:420px;overflow:hidden;border-radius:12px;border:1px solid var(--border);background:#fff;"></div>

      <div class="divider"></div>

      <div style="font-weight:900;margin-bottom:6px;">Admin login</div>
      <div class="twoCol">
        <div>
          <label>Password</label>
          <input id="adminPw" type="password" placeholder="••••••••" />
        </div>
        <div class="row" style="align-items:end;justify-content:flex-end;">
          <button class="btn btnPrimary" id="unlockBtn">Unlock</button>
        </div>
      </div>
      <small class="hint">Required on page load and for Reset All.</small>
    </div>

  </div>
</div>

<div id="tooltip"></div>

<script>
(() => {
  // Safari compatibility: CSS.escape polyfill
  if (!window.CSS) window.CSS = {};
  if (typeof window.CSS.escape !== 'function') {
    window.CSS.escape = function (value) {
      return String(value).replace(/[^a-zA-Z0-9_\\-]/g, function (ch) {
        const hex = ch.codePointAt(0).toString(16).toUpperCase();
        return '\\\\' + hex + ' ';
      });
    };
  }

  // ====== CONFIG ======
  const SHEET_API_URL = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';

  // Set this to whatever you were using in v15
  const ADMIN_PASSWORD = 'changeme';

  const SYNC_INTERVAL_MS = 25000;

  // ====== UI ======
  const svgHost = document.getElementById('svgHost');
  const zoomHost = document.getElementById('zoomHost');
  const tooltip = document.getElementById('tooltip');

  const statusEl = document.getElementById('status');
  const standIdEl = document.getElementById('standId');
  const standStatusEl = document.getElementById('standStatus');
  const standCompanyEl = document.getElementById('standCompany');

  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const resetBtn = document.getElementById('resetBtn');

  const listAll = document.getElementById('listAll');
  const listAvail = document.getElementById('listAvail');
  const listSold = document.getElementById('listSold');
  const searchEl = document.getElementById('search');

  const tableBody = document.querySelector('#standTable tbody');

  const adminPw = document.getElementById('adminPw');
  const unlockBtn = document.getElementById('unlockBtn');

  // ====== STATE ======
  let svgRoot = null;
  let zoomSvgRoot = null;
  let byId = new Map();
  let selected = null;
  let unlocked = false;

  let bboxCache = new Map();
  let zoomRaf = 0;

  function setStatus(msg, isError=false){
    statusEl.textContent = msg;
    statusEl.style.color = isError ? '#b00020' : 'var(--muted)';
  }

  function normalizeStatus(value) {
    const v = String(value || '').toLowerCase().trim();
    return v === 'sold' ? 'sold' : 'available';
  }

  function tooltipText(info){
    const stand = info.standId || '';
    const status = (info.status === 'sold') ? 'sold' : 'available';
    const company = info.company ? info.company.trim() : '';
    let lines = [stand, status];
    if (status === 'sold' && company) lines.push(company);
    return lines.join(' • ');
  }

  function isStandId(id){
    if(!id) return false;
    return /^[A-Z]{1,3}\\d{1,3}$/i.test(id);
  }

  function getStandNodes(){
    if(!svgRoot) return [];
    const groups = Array.from(svgRoot.querySelectorAll('g[id]')).filter(el=>isStandId(el.id));
    const shapes = Array.from(svgRoot.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id],polyline[id],line[id]')).filter(el=>isStandId(el.id));
    return groups.length ? groups : shapes;
  }

  function paintNode(standId, status){
    const node = svgRoot.querySelector('#' + CSS.escape(standId));
    if(!node) return;
    const fill = (status === 'sold')
      ? 'rgba(231,76,60,0.75)'
      : (status === 'available')
        ? 'rgba(46,204,113,0.75)'
        : 'rgba(255,255,255,0.0)';
    try{
      if(node.tagName.toLowerCase() === 'g'){
        node.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch => ch.style.fill = fill);
      }else{
        node.style.fill = fill;
      }
    }catch{}
  }

  async function loadSvg(){
    const resp = await fetch('event_plan.svg', { cache:'no-store' });
    if(!resp.ok) throw new Error('Failed to load SVG');
    const txt = await resp.text();
    svgHost.innerHTML = txt;
    svgRoot = svgHost.querySelector('svg');
    if(!svgRoot) throw new Error('SVG root not found');
  }

  async function loadZoomSvg(){
    const resp = await fetch('event_plan.svg', { cache:'no-store' });
    if(!resp.ok) throw new Error('Failed to load SVG');
    const txt = await resp.text();
    zoomHost.innerHTML = txt;
    zoomSvgRoot = zoomHost.querySelector('svg');
    if(!zoomSvgRoot) throw new Error('Zoom SVG root not found');
    // Ensure viewBox exists
    if(!zoomSvgRoot.getAttribute('viewBox')){
      const w = zoomSvgRoot.getAttribute('width') || 1000;
      const h = zoomSvgRoot.getAttribute('height') || 600;
      zoomSvgRoot.setAttribute('viewBox', `0 0 ${w} ${h}`);
    }
  }

  function getStandBox(standId){
    if (bboxCache.has(standId)) return bboxCache.get(standId);
    const node = svgRoot?.querySelector('#' + CSS.escape(standId));
    if (!node) return null;
    try{
      const bb = node.getBBox();
      const info = { bb };
      bboxCache.set(standId, info);
      return info;
    }catch{
      return null;
    }
  }

  function updateZoom(standId){
    if(!zoomSvgRoot || !svgRoot) return;
    const box = getStandBox(standId);
    if(!box) return;
    const bb = box.bb;

    const pad = Math.max(20, Math.min(bb.width, bb.height) * 0.35);
    const x = bb.x - pad;
    const y = bb.y - pad;
    const w = bb.width + pad*2;
    const h = bb.height + pad*2;

    zoomSvgRoot.setAttribute('viewBox', `${x} ${y} ${w} ${h}`);
  }

  function scheduleUpdateZoom(standId){
    if (!standId) return;
    if (zoomRaf) cancelAnimationFrame(zoomRaf);
    zoomRaf = requestAnimationFrame(() => {
      zoomRaf = 0;
      updateZoom(standId);
    });
  }

  async function fetchAll(){
    const resp = await fetch(SHEET_API_URL, { cache:'no-store' });
    if(!resp.ok) throw new Error('Failed to fetch');
    const arr = await resp.json();
    byId = new Map();
    arr.forEach(r=>{
      const standId = String(r.standId||'').trim();
      if(!standId) return;
      byId.set(standId, {
        standId,
        status: normalizeStatus(r.status),
        company: String(r.company||'').trim()
      });
    });
  }

  function renderPlan(){
    byId.forEach((info, id)=> paintNode(id, info.status));
    // highlight selection
    getStandNodes().forEach(n=>{
      try{ n.style.stroke = ''; n.style.strokeWidth = ''; }catch{}
    });
    if(selected){
      const n = svgRoot.querySelector('#'+CSS.escape(selected));
      if(n){
        try{
          if(n.tagName.toLowerCase()==='g'){
            n.querySelectorAll('path,rect,polygon,circle,ellipse,polyline,line').forEach(ch=>{
              ch.style.stroke='#111';
              ch.style.strokeWidth='3px';
            });
          }else{
            n.style.stroke='#111';
            n.style.strokeWidth='3px';
          }
        }catch{}
      }
    }
  }

  function currentListFilter(){
    if(listAvail.classList.contains('active')) return 'available';
    if(listSold.classList.contains('active')) return 'sold';
    return 'all';
  }

  function renderTable(){
    const f = currentListFilter();
    const q = (searchEl.value||'').trim().toLowerCase();

    const rows = Array.from(byId.values())
      .filter(r=>{
        if(f!=='all' && r.status!==f) return false;
        if(!q) return true;
        return r.standId.toLowerCase().includes(q) || (r.company||'').toLowerCase().includes(q);
      })
      .sort((a,b)=>a.standId.localeCompare(b.standId));

    tableBody.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      if(r.standId===selected) tr.classList.add('selected');

      const statusClass = (r.status==='sold') ? 'tagSold' : 'tagAvail';
      tr.innerHTML = `
        <td><strong>${r.standId}</strong></td>
        <td class="${statusClass}">${r.status}</td>
        <td>${(r.company||'')}</td>
      `;
      tr.addEventListener('click', ()=> selectStand(r.standId, true));
      tableBody.appendChild(tr);
    });
  }

  function selectStand(standId, scrollToRow){
    selected = standId;
    const info = byId.get(standId) || { standId, status:'available', company:'' };

    standIdEl.value = info.standId;
    standStatusEl.value = info.status;
    standCompanyEl.value = info.company || '';

    renderPlan();
    renderTable();
    scheduleUpdateZoom(standId);

    // no forced scroll on desktop (keeps plan stable)
    if(scrollToRow){
      const isNarrow = window.matchMedia && window.matchMedia('(max-width: 1000px)').matches;
      if (isNarrow){
        const row = Array.from(tableBody.querySelectorAll('tr')).find(tr => tr.firstChild && tr.firstChild.textContent.trim() === standId);
        if(row) row.scrollIntoView({block:'center'});
      }
    }
  }

  function bindNodeEvents(node){
    const standId = node.id;
    if(!isStandId(standId)) return;

    try{ node.style.cursor = 'pointer'; }catch{}

    node.addEventListener('mouseenter', () => {
      const info = byId.get(standId) || { standId, status:'available', company:'' };
      tooltip.textContent = tooltipText(info);
      tooltip.style.display = 'block';
    });

    node.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });

    node.addEventListener('mousemove', e => {
      tooltip.style.left = (e.clientX + 12) + 'px';
      tooltip.style.top  = (e.clientY + 12) + 'px';
      tooltip.style.display = 'block';
    });

    node.addEventListener('click', e => {
      e.preventDefault(); e.stopPropagation();
      tooltip.style.display='none';
      selectStand(standId, false);
    });
  }

  async function saveStand(){
    if(!unlocked){
      alert('Unlock first (admin password).');
      return;
    }
    if(!selected){
      alert('Select a stand first.');
      return;
    }
    const payload = {
      standId: selected,
      status: standStatusEl.value,
      company: standCompanyEl.value
    };

    const resp = await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify(payload) });
    if(!resp.ok) throw new Error('Save failed');
    await syncOnce();
  }

  function setListFilter(which){
    [listAll, listAvail, listSold].forEach(b=>b.classList.remove('active'));
    if(which==='all') listAll.classList.add('active');
    if(which==='available') listAvail.classList.add('active');
    if(which==='sold') listSold.classList.add('active');
    renderTable();
  }

  function toCsv(rows){
    return rows.map(r => r.map(v => {
      const s = String(v ?? '');
      return (s.includes(',') || s.includes('"') || s.includes('\\n')) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\\n');
  }

  function exportCsv(){
    const rows = [['Stand ID','Status','Company']];
    Array.from(byId.values()).sort((a,b)=>a.standId.localeCompare(b.standId)).forEach(r=>{
      rows.push([r.standId, r.status, r.company || '']);
    });
    const blob = new Blob([toCsv(rows)], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'stands_snapshot.csv';
    a.click();
  }

  function importCsv(){
    if(!unlocked){
      alert('Unlock first (admin password).');
      return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,text/csv';
    input.onchange = async () => {
      if(!input.files || !input.files[0]) return;
      const text = await input.files[0].text();
      const lines = text.split(/\\r?\\n/).filter(Boolean);
      // skip header
      const rows = lines.slice(1).map(l=>{
        // naive CSV split (works for simple exports)
        const parts = l.split(',');
        const standId = (parts[0]||'').replace(/^"|"$/g,'').trim();
        const status = (parts[1]||'').replace(/^"|"$/g,'').trim();
        const company = parts.slice(2).join(',').replace(/^"|"$/g,'').trim();
        return {standId, status, company};
      }).filter(r=>r.standId);

      for(const r of rows){
        await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify({
          standId: r.standId,
          status: r.status,
          company: r.company
        })});
      }
      await syncOnce();
    };
    input.click();
  }

  async function resetAll(){
    if(!unlocked){
      alert('Unlock first (admin password).');
      return;
    }
    const pw = prompt('Type admin password to confirm reset:');
    if(pw !== ADMIN_PASSWORD){
      alert('Wrong password.');
      return;
    }
    const stands = Array.from(byId.values());
    for(const s of stands){
      await fetch(SHEET_API_URL, { method:'POST', body: JSON.stringify({ standId: s.standId, status:'available', company:'' }) });
    }
    await syncOnce();
  }

  function unlock(){
    const pw = adminPw.value || '';
    if(pw === ADMIN_PASSWORD){
      unlocked = true;
      adminPw.value = '';
      alert('Unlocked.');
    }else{
      unlocked = false;
      alert('Wrong password.');
    }
  }

  async function syncOnce(){
    try{
      setStatus('Syncing…');
      await fetchAll();
      renderPlan();
      renderTable();
      if(selected) scheduleUpdateZoom(selected);
      setStatus('Last sync: ' + new Date().toLocaleTimeString());
    }catch(e){
      console.error(e);
      setStatus('Sync error: ' + e.message, true);
    }
  }

  // ====== Wire UI ======
  saveBtn.addEventListener('click', () => saveStand().catch(e=>{ alert(e.message); }));
  exportBtn.addEventListener('click', exportCsv);
  importBtn.addEventListener('click', importCsv);
  resetBtn.addEventListener('click', () => resetAll().catch(e=>alert(e.message)));

  listAll.addEventListener('click', ()=>setListFilter('all'));
  listAvail.addEventListener('click', ()=>setListFilter('available'));
  listSold.addEventListener('click', ()=>setListFilter('sold'));
  searchEl.addEventListener('input', renderTable);

  unlockBtn.addEventListener('click', unlock);

  // ====== Boot ======
  (async () => {
    try{
      // require password on page load (v15 behavior)
      const pw = prompt('Admin password:');
      if(pw !== ADMIN_PASSWORD){
        alert('Wrong password.');
        return;
      }
      unlocked = true;

      await loadSvg();
      await loadZoomSvg();
      bboxCache = new Map();

      // bind interactions once
      getStandNodes().forEach(bindNodeEvents);

      await syncOnce();
      setInterval(syncOnce, SYNC_INTERVAL_MS);
    }catch(e){
      console.error(e);
      setStatus('Load error: ' + e.message, true);
    }
  })();
})();
</script>
</body>
</html>
