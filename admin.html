<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Floorplan Admin</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border:#e9e9e9;
      --text:#111;
      --muted:#666;
      --avail: rgba(213,109,50,0.75);
      --sold:#e63b3b;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
      --dot: 10px; /* dot size for pointer (match public) */
      --line: rgba(0,0,0,.70);
      --safe: env(safe-area-inset-bottom, 0px);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--text);
    }
    header{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    header .title{ font-weight:900; font-size:18px; }
    header .tools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    header input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      min-width: 260px;
      font-weight:700;
    }
    button{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    button.danger{ border-color:#ffd0d0; background:#fff5f5; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    main{
      padding:16px;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .cardHead{
      padding:10px 12px;
      font-weight:900;
      border-bottom:1px solid var(--border);
    }
    .planCard{ overflow:hidden; }
    .planBody{ padding:12px; }
    .planWrap{--labelGutter:110px;

      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      min-height:420px;
    
  padding-bottom: var(--labelGutter);
}
    .svgHost{position:absolute; left:0; right:0; top:0; bottom:var(--labelGutter);}

    .overlay{ position:absolute; inset:0; pointer-events:none; }
    .label{
      position:absolute;
      background:var(--sold);
      color:#fff;
      border-radius:16px;
      padding:12px 16px;
      box-shadow: var(--shadow);
      min-width: 200px;
      max-width: 300px;
      text-align:center;
      pointer-events:none;
      transform: translate(-50%, -50%);
    }
    .label .stand{ font-size:28px; font-weight:900; }
    .line{display:none;

      position:absolute; background:var(--line);
      transform-origin:0 0; height:3px; border-radius:3px;
    }
    .dot{display:none;

      position:absolute; width:var(--dot); height:var(--dot);
      border-radius:999px; background:rgba(0,0,0,.72);
      transform: translate(-50%, -50%);
    }
    .legend{ padding:10px 12px; display:flex; gap:10px; align-items:center; border-top:1px solid var(--border); }
    .pill{ display:flex; align-items:center; gap:8px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; }
    .sw{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .zoomCard .cardHead{ display:flex; justify-content:space-between; }
    .zoomBody{ padding:12px; }
    .zoomWrap{
      position:relative;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      min-height:260px;
      background:#fff;
    }
    .zoomSvgHost{ width:100%; height:auto; display:block; }
    .zoomRing{
      position:absolute;
      border:4px solid rgba(0,0,0,.75);
      border-radius:999px;
      pointer-events:none;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
      display:none;
    }
    .hint{ color:var(--muted); font-size:13px; padding:10px 12px 12px; }
    .side{ padding:12px; display:flex; flex-direction:column; gap:12px; }
    .formRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .side label{ display:block; font-weight:800; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .side input, .side select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      font-weight:700;
    }
    .btnRow{ display:flex; gap:10px; }
    .btnRow button{ flex:1; }
    .tableWrap{ border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    .tableTools{ padding:10px; display:flex; gap:10px; align-items:center; }
    .tableTools input{
      flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ padding:10px 10px; border-top:1px solid #f0f0f0; text-align:center; }
    th{ background:#fafafa; border-top:none; font-size:12px; color:var(--muted); }
    tr.active{ background:#f5f8ff; outline:2px solid #c9d5ff; outline-offset:-2px; }
    .badge{ display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid var(--border); }
    .bSold{ color:#b40000; border-color:#ffd0d0; background:#fff5f5; }
    .bAvail{ color:#6b3a0f; border-color:#f2dfcf; background:#fff7f0; }
    .toast{
      position:fixed;
      left:16px; right:16px; bottom:16px;
      background:#111; color:#fff;
      padding:12px 14px;
      border-radius:14px;
      display:none;
      z-index:999;
      box-shadow: var(--shadow);
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .toast .msg{ font-weight:800; font-size:13px; line-height:1.3; }
    .toast .actions{ display:flex; gap:10px; }
    .toast button{ background:#fff; }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }
    @media (max-width: 640px){
      main{ padding:12px; gap:12px; }
      header input{ min-width: 200px; width: 100%; }
      .planWrap{ min-height: 300px; }
      /* Sticky plan + zoom on phone, scroll stands list */
      .planCard{ position: sticky; top: 0; z-index: 20; background: var(--bg); }
      .zoomCard{ position: sticky; top: 320px; z-index: 19; background: var(--bg); }
      .tableWrap{ padding-bottom: calc(14px + var(--safe)); }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Floorplan Admin</div>
    <div class="tools">
      <div style="color:var(--muted); font-weight:800;">Synced: <span id="syncedAt">—</span></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-weight:900;">Event name</div>
        <input id="eventName" placeholder="New Event" />
      </div>
      <button id="pauseBtn">Pause sync</button>
      <button id="exportBtn">Export CSV</button>
      <button id="importBtn">Import CSV</button>
      <button class="danger" id="resetBtn">Reset all</button>
    </div>
  </header>

  <main>
    <section class="card planCard">
      <div class="cardHead">Plan</div>
      <div class="planBody">
        <div class="planWrap" id="planWrap">
          <div id="svgHost" class="svgHost"></div>
          <div class="overlay" id="overlay" aria-hidden="true">
            <div class="line" id="line" style="display:none;"></div>
            <div class="dot" id="dot" style="display:none;"></div>
            <div class="label" id="label" style="display:none;">
              <div class="stand" id="labelStand">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="legend">
        <div class="pill"><span class="sw" style="background:var(--sold)"></span>Sold</div>
        <div class="pill"><span class="sw" style="background:var(--avail)"></span>Available</div>
      </div>

      <section class="card zoomCard" style="margin:12px;">
        <div class="cardHead">Zoom</div>
        <div class="zoomBody">
          <div class="zoomWrap" id="zoomWrap">
            <div id="zoomSvgHost" class="zoomSvgHost"></div>
            <div class="zoomRing" id="zoomRing"></div>
          </div>
          <div class="hint">Select a stand to zoom in.</div>
        </div>
      </section>
    </section>

    <aside class="card side">
      <div class="card" style="border:1px solid var(--border); border-radius:14px; padding:12px;">
        <div style="font-weight:900; margin-bottom:10px;">Selected Stand</div>

        <div style="margin-bottom:10px;">
          <label>Stand ID</label>
          <input id="standId" disabled />
        </div>

        <div class="formRow" style="margin-bottom:10px;">
          <div>
            <label>Status</label>
            <select id="status">
              <option value="available">Available</option>
              <option value="sold">Sold</option>
            </select>
          </div>
          <div>
            <label>Company (sold only)</label>
            <input id="company" placeholder="Company name…" />
          </div>
        </div>

        <div class="btnRow">
          <button id="saveBtn">Save</button>
          <button id="markAvailBtn" class="danger">Mark Available</button>
        </div>

        <div class="hint" style="padding:10px 0 0;">Click a stand on the plan or in the list to edit.</div>
      </div>

      <div class="card" style="border:1px solid var(--border); border-radius:14px;">
        <div class="cardHead">Stands</div>
        <div class="tableTools">
          <input id="search" placeholder="Search stand or company…" />
          <select id="filter" style="width:120px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); font-weight:800;">
            <option value="all">All</option>
            <option value="sold">Sold</option>
            <option value="available">Available</option>
          </select>
        </div>
        <div style="padding:0 12px 10px; color:var(--muted); font-weight:800;"><span id="count">0</span> / <span id="total">0</span></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th style="width:90px;">Stand</th><th style="width:120px;">Status</th><th>Company</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <div class="toast" id="toast">
    <div class="msg" id="toastMsg">Can't reach the backend right now (this is why the page won't load). If Cloudflare is down, paste your Google Apps Script Web App URL instead.</div>
    <div class="actions">
      <button id="setBackendBtn">Set backend URL</button>
      <button id="hideToastBtn">Hide</button>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_BACKEND = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const BACKEND_KEY = "floorplan_backend_url";
  const SVG_URL = "./event_plan.svg";

  const el = (id) => document.getElementById(id);

  const planWrap = el("planWrap");
  const svgHost = el("svgHost");
  const zoomWrap = el("zoomWrap");
  const zoomSvgHost = el("zoomSvgHost");
  const zoomRing = el("zoomRing");

  const overlay = el("overlay");
  const lineEl = el("line");
  const dotEl = el("dot");
  const labelEl = el("label");
  const labelStandEl = el("labelStand");

  const tbody = el("tbody");
  const searchEl = el("search");
  const filterEl = el("filter");
  const countEl = el("count");
  const totalEl = el("total");

  const standIdEl = el("standId");
  const statusEl = el("status");
  const companyEl = el("company");
  const saveBtn = el("saveBtn");
  const markAvailBtn = el("markAvailBtn");

  const toast = el("toast");
  const setBackendBtn = el("setBackendBtn");
  const hideToastBtn = el("hideToastBtn");
  const syncedAt = el("syncedAt");

  let svgRoot = null;
  let rawSvgText = "";
  let zoomSvgRoot = null;
  let standMap = new Map();

  let rows = [];
  let selectedStandId = null;
  let autoSync = true;
  let syncTimer = null;

  function normalizeBackendUrl(input) {
  if (!input) return "";
  let s = String(input).trim();
  // If someone pastes a full endpoint (e.g. .../stands), strip it back to the base.
  try {
    const u = new URL(s);
    let p = u.pathname.replace(/\/+$/,"");
    p = p.replace(/\/(api\/stands|stands)$/i, "");
    p = p.replace(/\/+$/,"");
    u.pathname = p ? p : "/";
    u.search = "";
    u.hash = "";
    const base = u.origin + (u.pathname === "/" ? "" : u.pathname);
    return base.replace(/\/+$/,"");
  } catch (e) {
    s = s.replace(/\/+$/,"");
    s = s.replace(/\/(api\/stands|stands)$/i, "");
    return s.replace(/\/+$/,"");
  }
}

function getBackendUrl() {
    const saved = localStorage.getItem(BACKEND_KEY);
    const base = (saved && saved.startsWith("http")) ? saved : DEFAULT_BACKEND;
    return normalizeBackendUrl(base);
  }

  function showToast(show) {
    toast.style.display = show ? "flex" : "none";
  }

  setBackendBtn.addEventListener("click", () => {
    const current = getBackendUrl();
    const v = prompt("Paste your backend URL (Cloudflare Worker or Google Apps Script Web App):", current);
    if (v && v.trim().startsWith("http")) {
      localStorage.setItem(BACKEND_KEY, v.trim().replace(/\/+$/,""));
      location.reload();
    }
  });
  hideToastBtn.addEventListener("click", () => showToast(false));

  async function fetchJson(url, opts = {}) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 12000);
    try {
      const res = await fetch(url, { ...opts, signal: controller.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } finally {
      clearTimeout(t);
    }
  }

  function normStandId(s){ return String(s||"").trim().toUpperCase(); }
  function normRow(row) {
    return {
      standId: normStandId(row.standId ?? row.stand ?? row.id),
      status: String(row.status || "available").toLowerCase(),
      company: String(row.company || "").trim()
    };
  }

  function normalizeDomId(id) {
    return String(id || "")
      .trim()
      .toUpperCase()
      .replace(/^STAND[_-]?/,"")
      .replace(/^ZONE[_-]?/,"")
      .replace(/^ID[_-]?/,"")
      .replace(/[^A-Z0-9]/g,"");
  }

  function hideLargeArtifacts(svg) {
    if (!svg) return;
    // Hide any huge filled shapes that sit at the top-left (common export artifact: quarter circle)
    const nodes = svg.querySelectorAll("path,circle,ellipse,rect,polygon,polyline");
    nodes.forEach(n => {
      try {
        const fill = (n.getAttribute("fill") || "").toLowerCase();
        const stroke = (n.getAttribute("stroke") || "").toLowerCase();
        if (!fill || fill === "none") return;
        if (stroke && stroke !== "none") return;
        const b = n.getBBox();
        if (b.x <= 1 && b.y <= 1 && (b.width > 60 || b.height > 60)) {
          n.style.display = "none";
        }
      } catch {}
    });
  }

  function svgFromText(txt) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(txt, "image/svg+xml");
    const svg = doc.querySelector("svg");
    if (!svg) throw new Error("SVG parse failed");
    return document.importNode(svg, true);
  }


  function buildStandMap() {
    standMap.clear();
    if (!svgRoot) return;

    const consider = (node, rawKey) => {
      const key = normalizeDomId(rawKey);
      if (!key) return;
      let area = 0;
      try {
        const b = node.getBBox();
        area = Math.max(0, b.width) * Math.max(0, b.height);
      } catch {}
      const existing = standMap.get(key);
      if (!existing) {
        standMap.set(key, node);
        return;
      }
      // Prefer the element with the larger bounding box (usually the real stand shape/group)
      try {
        const eb = existing.getBBox();
        const eArea = Math.max(0, eb.width) * Math.max(0, eb.height);
        if (area > eArea) standMap.set(key, node);
      } catch {
        // If existing has no bbox, replace it
        standMap.set(key, node);
      }
    };

    svgRoot.querySelectorAll("[id]").forEach(node => consider(node, node.id));
    svgRoot.querySelectorAll("[data-stand]").forEach(node => consider(node, node.getAttribute("data-stand")));
  }

  function elementForStand(standId){
    return standMap.get(normalizeDomId(standId)) || null;
  }

  function setFillForElement(elem, rgba) {
    if (!elem) return;
    const shapes = elem.matches("path,rect,polygon,polyline,ellipse,circle")
      ? [elem]
      : Array.from(elem.querySelectorAll("path,rect,polygon,polyline,ellipse,circle"));

    shapes.forEach(s => {
      const bbox = s.getBBox ? s.getBBox() : null;
      if (bbox && (bbox.width < 8 || bbox.height < 8)) return;
      s.style.fill = rgba;
      s.style.fillOpacity = "1";
    });
  }

  function getElementCenterInPage(elem){
    const r = elem.getBoundingClientRect();
    return { x: r.left + r.width/2, y: r.top + r.height/2, w:r.width, h:r.height };
  }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function placeLabelUnder(standCenter, labelW, labelH) {
    const wrapRect = planWrap.getBoundingClientRect();
    const margin = 18;

    const lx = clamp(standCenter.x, wrapRect.left + margin + labelW/2, wrapRect.right - margin - labelW/2);
    const ly = wrapRect.bottom - margin - labelH/2; // under the plan

    return { x: lx, y: ly };
  }

  function updatePointer() {
    if (!selectedStandId) {
        lineEl.style.display = "none";
        dotEl.style.display = "none";
        labelEl.style.display = "none";
        return;
    }

    const key = normalizeDomId(selectedStandId);
    const standEl = standMap.get(key);
    if (!standEl) {
        lineEl.style.display = "none";
        dotEl.style.display = "none";
        labelEl.style.display = "none";
        return;
    }

    const wrapRect = planWrap.getBoundingClientRect();
    const standRect = standEl.getBoundingClientRect();

    const standCenter = {
        x: (standRect.left - wrapRect.left) + (standRect.width / 2),
        y: (standRect.top - wrapRect.top) + (standRect.height / 2),
    };

    // Label text
    labelStand.textContent = selectedStandId;
    const st = standsById.get(selectedStandId);
    const company = (st?.company || "").trim();
    labelCompany.textContent = company || "";

    // Measure label
    labelEl.style.display = "block";
    const labelW = 220;
    labelEl.style.width = labelW + "px";
    const labelRect = labelEl.getBoundingClientRect();
    const labelH = labelRect.height;

    // Place label in reserved bottom gutter (off the plan)
    const gutterCss = getComputedStyle(planWrap).getPropertyValue("--labelGutter").trim();
    const gutter = gutterCss ? parseFloat(gutterCss) : 110;
    const margin = 12;

    let lx = standCenter.x;
    lx = Math.max(margin + labelW / 2, Math.min(planWrap.clientWidth - margin - labelW / 2, lx));
    const ly = planWrap.clientHeight - gutter / 2;

    labelEl.style.left = lx + "px";
    labelEl.style.top  = ly + "px";

    // Line from top-middle of label to stand center
    const startX = lx;
    const startY = ly - (labelH / 2);
    const endX = standCenter.x;
    const endY = standCenter.y;

    const dx = endX - startX;
    const dy = endY - startY;
    const len = Math.max(1, Math.hypot(dx, dy));
    const ang = Math.atan2(dy, dx);

    lineEl.style.display = "block";
    lineEl.style.left = startX + "px";
    lineEl.style.top  = startY + "px";
    lineEl.style.width = len + "px";
    lineEl.style.transform = "rotate(" + ang + "rad)";

    dotEl.style.display = "block";
    const dotSize = dotEl.offsetWidth || 10;
    dotEl.style.left = (endX - dotSize / 2) + "px";
    dotEl.style.top  = (endY - dotSize / 2) + "px";
})();
</script>
</body>
</html>
