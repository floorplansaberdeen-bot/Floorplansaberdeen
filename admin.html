<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Floorplan Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111}
  header{padding:12px 16px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
  #status{font-size:13px;color:#555}
  #layout{display:grid;grid-template-columns:2fr 1fr;gap:12px;padding:12px}
  #svgHost{border:1px solid #ddd;min-height:240px}
  svg text, svg tspan{pointer-events:none;user-select:none}
  label{font-size:12px;color:#444}
  input,select,button{width:100%;padding:8px;margin-top:4px;box-sizing:border-box}
  button{cursor:pointer}
  #tooltip{position:fixed;display:none;background:rgba(0,0,0,.85);color:#fff;padding:8px 10px;border-radius:6px;font-size:13px;white-space:pre-line;pointer-events:none;z-index:10000}
  .row{margin-bottom:10px}
</style>
</head>
<body>
<header>
  <strong>Floorplan Admin</strong>
  <div id="status">Loading…</div>
</header>

<div id="layout">
  <div id="svgHost"></div>

  <div>
    <div class="row">
      <label>Stand ID</label>
      <input id="standId" readonly>
    </div>

    <div class="row">
      <label>Status</label>
      <select id="statusSel">
        <option value="available">Available</option>
        <option value="sold">Sold</option>
      </select>
    </div>

    <div class="row">
      <label>Company</label>
      <input id="company" placeholder="Company name…">
    </div>

    <button id="save" disabled>Save</button>
  </div>
</div>

<div id="tooltip"></div>

<script>
const API_BASE = 'https://floorplansaberdeen.floorplansaberdeen.workers.dev';
const SVG_URL  = './event_plan.svg';
const FILL_OPACITY = 0.75;

const statusEl = document.getElementById('status');
const svgHost  = document.getElementById('svgHost');
const tooltip  = document.getElementById('tooltip');

const standIdEl = document.getElementById('standId');
const statusSel = document.getElementById('statusSel');
const companyEl = document.getElementById('company');
const saveBtn   = document.getElementById('save');

function setStatus(msg, isError=false){
  statusEl.textContent = msg;
  statusEl.style.color = isError ? '#b91c1c' : '#555';
}

function normalizeStatus(v){
  return String(v||'').toLowerCase().trim()==='sold' ? 'sold' : 'available';
}

function tooltipText(d){
  const status = normalizeStatus(d.status);
  const lines = [String(d.standId||'').trim(), status==='sold'?'Sold':'Available'];
  if(status==='sold' && d.company) lines.push(String(d.company).trim());
  return lines.join('\n');
}

function isStandId(id){ return /^[A-Za-z]{1,3}\d{1,3}$/.test(id); }

function standTargets(svg){
  const groups = Array.from(svg.querySelectorAll('g[id]')).filter(g => isStandId(g.id));
  if(groups.length) return groups;
  const shapes = Array.from(svg.querySelectorAll('path[id],rect[id],polygon[id],circle[id],ellipse[id]')).filter(el => isStandId(el.id));
  return shapes;
}

function paintElementOrGroup(node, status){
  const fill = status==='sold' ? '#e53935' : '#2ecc71';
  const targets = (node.matches && node.matches('path,rect,polygon,circle,ellipse'))
    ? [node]
    : Array.from(node.querySelectorAll('path,rect,polygon,circle,ellipse'));
  targets.forEach(el=>{
    el.style.fill = fill;
    el.style.fillOpacity = String(FILL_OPACITY);
    el.style.stroke = '#000';
    el.style.strokeOpacity = '0.35';
  });
}

function attachTooltip(node, dataProvider){
  node.addEventListener('mousemove', e=>{
    const d = dataProvider();
    tooltip.textContent = tooltipText(d);
    tooltip.style.left = (e.clientX+12)+'px';
    tooltip.style.top  = (e.clientY+12)+'px';
    tooltip.style.display='block';
  });
  node.addEventListener('mouseleave', ()=> tooltip.style.display='none');
}

async function loadSvg(){
  setStatus('Loading plan…');
  const res = await fetch(SVG_URL, {cache:'no-store'});
  if(!res.ok){
    throw new Error('SVG not found at '+SVG_URL+' (HTTP '+res.status+'). Make sure event_plan.svg is in the same folder as admin.html');
  }
  const text = await res.text();
  svgHost.innerHTML = text;
  const svg = svgHost.querySelector('svg');
  if(!svg) throw new Error('SVG loaded but <svg> root not found.');
  return svg;
}

async function fetchStands(){
  const res = await fetch(API_BASE + '/stands', {cache:'no-store'});
  if(!res.ok) throw new Error('API /stands failed (HTTP '+res.status+').');
  return await res.json();
}

async function saveStand(payload){
  const res = await fetch(API_BASE + '/stand', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let json = null; try{ json = JSON.parse(text);}catch(e){}
  if(!res.ok || (json && json.success===false)){
    throw new Error((json && json.error) ? json.error : ('Save failed (HTTP '+res.status+')'));
  }
  return json || {success:true};
}

let svg = null;
let dataMap = new Map();
let selectedId = null;

function applyData(){
  if(!svg) return;
  standTargets(svg).forEach(node=>{
    const id = node.id;
    const d = dataMap.get(id) || {standId:id,status:'available',company:''};
    paintElementOrGroup(node, normalizeStatus(d.status));
  });
}

async function syncOnce(){
  const list = await fetchStands();
  dataMap = new Map((Array.isArray(list)?list:[]).map(d=>[String(d.standId).trim(), {
    standId:String(d.standId).trim(),
    status:normalizeStatus(d.status),
    company:String(d.company||'').trim()
  }]));
  applyData();
  setStatus('Synced: ' + new Date().toLocaleTimeString());

  if(selectedId && dataMap.has(selectedId)){
    const d = dataMap.get(selectedId);
    standIdEl.value = d.standId;
    statusSel.value = d.status;
    companyEl.value = d.company || '';
  }
}

function wireInteractions(){
  if(!svg) return;
  standTargets(svg).forEach(node=>{
    const id = node.id;

    attachTooltip(node, ()=> dataMap.get(id) || {standId:id,status:'available',company:''});

    node.style.cursor='pointer';
    node.addEventListener('click', ()=>{
      selectedId = id;
      const d = dataMap.get(id) || {standId:id,status:'available',company:''};
      standIdEl.value = d.standId;
      statusSel.value = d.status;
      companyEl.value = d.company || '';
      saveBtn.disabled = false;
    });
  });
}

saveBtn.addEventListener('click', async ()=>{
  if(!selectedId) return;

  const payload = {
    standId: standIdEl.value.trim(),
    status: normalizeStatus(statusSel.value),
    company: normalizeStatus(statusSel.value)==='sold' ? companyEl.value.trim() : ''
  };

  setStatus('Saving…');
  saveBtn.disabled = true;
  try{
    await saveStand(payload);
    await syncOnce();
    setStatus('Saved: ' + new Date().toLocaleTimeString());
  }catch(err){
    console.error(err);
    setStatus('Save error: ' + err.message, true);
  }finally{
    saveBtn.disabled = false;
  }
});

(async ()=>{
  try{
    svg = await loadSvg();
    wireInteractions();
    await syncOnce();
    setInterval(()=> syncOnce().catch(err=>{ console.error(err); setStatus('Sync error: '+err.message, true); }), 5000);
  }catch(err){
    console.error(err);
    setStatus('Load error: '+err.message, true);
  }
})();
</script>
</body>
</html>
