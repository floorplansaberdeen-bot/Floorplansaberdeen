<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Floorplan Admin</title>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --border: #e7e7e7;
      --text: #111;
      --muted: #666;
      --mainFill: rgba(213, 109, 50, 0.75); /* requested */
      --soldFill: #e53935;
      --selFill: #e53935;
      --shadow: 0 14px 28px rgba(0,0,0,.12), 0 6px 12px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid #f1f1f1}
    .bar h1{margin:0;font-size:18px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{border:1px solid var(--border);background:#fafafa;border-radius:12px;padding:8px 10px;font-weight:700}
    .btn{border:1px solid var(--border);background:#f9f9f9;border-radius:12px;padding:8px 12px;font-weight:800;cursor:pointer}
    .btn.danger{border-color:#f4b7b7;background:#fff3f3}
    .wrap{display:grid;grid-template-columns:minmax(520px,1fr) 520px;gap:14px;padding:14px 16px 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card .hd{padding:12px 14px;border-bottom:1px solid #f1f1f1;font-weight:900}
    .card .bd{padding:14px}
    /* Plan */
    .planShell{padding:14px}
    .planFrame{border:1px solid #ededed;border-radius:14px;background:#fff;overflow:hidden}
    .planStage{position:relative;}
    .planObject{display:block;width:100%;height:420px;border:0;}
    .labelArea{height:140px;position:relative;}
    .labelBox{position:absolute;left:40px;top:18px;min-width:220px;max-width:min(520px,80vw);
      background:var(--selFill);color:#fff;border-radius:14px;padding:16px 18px;text-align:left;
      box-shadow:var(--shadow);}
    .labelBox.hidden{display:none}
    .labelBox .stand{font-size:38px;font-weight:950;line-height:1}
    .labelBox .company{margin-top:6px;font-size:16px;font-weight:800;opacity:.95}
    .overlaySvg{position:absolute;inset:0;pointer-events:none}
    .legend{display:flex;gap:10px;align-items:center;padding:10px 14px;border-top:1px solid #f1f1f1}
    .chip{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-weight:800;background:#fff}
    .dot{width:10px;height:10px;border-radius:999px}
    .dot.sold{background:var(--soldFill)}
    .dot.av{background:var(--mainFill)}

    /* Zoom */
    .zoomWrap{padding:12px 14px 14px}
    .zoomFrame{border:1px solid #ededed;border-radius:14px;background:#fff;overflow:hidden}
    .zoomStage{position:relative}
    .zoomObject{display:block;width:100%;height:250px;border:0}
    .zoomOverlay{position:absolute;inset:0;pointer-events:none}

    /* Right panel form/list */
    label{display:block;font-size:12px;font-weight:900;color:#444;margin-bottom:6px}
    input, select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;outline:none}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .rowBtns{display:flex;gap:10px;margin-top:10px}
    .rowBtns .btn{flex:1}
    .hint{color:var(--muted);font-size:13px;margin-top:8px}
    .tableWrap{margin-top:12px;border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:520px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 10px;border-top:1px solid #f1f1f1}
    th{text-align:left;background:#fafafa;position:sticky;top:0;z-index:1}
    tr.sel{background:#f2f6ff;outline:2px solid #b9c9ff;outline-offset:-2px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-weight:900;font-size:12px}
    .badge.sold{background:#fff2f2;border-color:#f3b6b6;color:#b00020}
    .badge.av{background:#fff7f0;border-color:#f0d0b6;color:#7a3f0a}
    @media (max-width: 1100px){
      .wrap{grid-template-columns:1fr}
      .planObject{height:360px}
    }
  </style>
</head>
<body>
  <div class="bar">
    <h1>Floorplan Admin</h1>
    <div class="controls">
      <div class="pill">Synced: <span id="synced">—</span></div>
      <div class="pill">Event name&nbsp; <input id="eventName" style="width:240px;padding:6px 10px;border-radius:10px;border:1px solid var(--border)" placeholder="Event name" /></div>
      <button class="btn" id="pauseBtn">Pause sync</button>
      <button class="btn" id="exportBtn">Export CSV</button>
      <button class="btn" id="importBtn">Import CSV</button>
      <button class="btn danger" id="resetBtn">Reset all</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="hd">Plan</div>
      <div class="planShell">
        <div class="planFrame">
          <div class="planStage" id="planStage">
            <object id="planObj" class="planObject" type="image/svg+xml" data="event_plan.svg"></object>
            <svg id="overlay" class="overlaySvg"></svg>
          </div>
          <div class="labelArea" id="labelArea">
            <div class="labelBox hidden" id="labelBox">
              <div class="stand" id="labelStand">—</div>
              <div class="company" id="labelCompany"></div>
            </div>
          </div>
          <div class="legend">
            <div class="chip"><span class="dot sold"></span>Sold</div>
            <div class="chip"><span class="dot av"></span>Available</div>
          </div>
        </div>
      </div>

      <div class="hd">Zoom</div>
      <div class="zoomWrap">
        <div class="zoomFrame">
          <div class="zoomStage" id="zoomStage">
            <object id="zoomObj" class="zoomObject" type="image/svg+xml" data="event_plan.svg"></object>
            <svg id="zoomOverlay" class="zoomOverlay"></svg>
          </div>
        </div>
        <div class="hint">Select a stand to zoom in.</div>
      </div>
    </div>

    <div class="card">
      <div class="hd">Selected Stand</div>
      <div class="bd">
        <div class="grid2">
          <div>
            <label>Stand ID</label>
            <input id="standId" placeholder="Stand ID" />
          </div>
          <div></div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Status</label>
            <select id="status">
              <option value="available">Available</option>
              <option value="sold">Sold</option>
            </select>
          </div>
          <div>
            <label>Company (sold only)</label>
            <input id="company" placeholder="Company name…" />
          </div>
        </div>
        <div class="rowBtns">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn danger" id="markAvailBtn">Mark Available</button>
        </div>
        <div class="hint">Click a stand on the plan or in the list to edit.</div>
      </div>

      <div class="hd">Stands</div>
      <div class="bd">
        <div class="grid2">
          <input id="search" placeholder="Search stand or company…" />
          <select id="filter">
            <option value="all">All</option>
            <option value="sold">Sold</option>
            <option value="available">Available</option>
          </select>
        </div>
        <div class="hint"><span id="count">0</span> / <span id="total">0</span></div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr><th>Stand</th><th>Status</th><th>Company</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const DEFAULT_BACKEND = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const state = {
    backend: localStorage.getItem("floorplan_backend") || DEFAULT_BACKEND,
    stands: [],
    selectedId: null,
    paused: false,
    svgDoc: null, svgRoot: null,
    zoomDoc: null, zoomRoot: null,
  };
  const el = (id) => document.getElementById(id);

  async function fetchJson(path, opts={}) {
    const url = state.backend.replace(/\/$/, "") + path;
    const res = await fetch(url, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        ...(opts.headers||{})
      },
      cache: "no-store",
    });
    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error(`${res.status} ${res.statusText} ${txt ? "- " + txt.slice(0,120) : ""}`);
    }
    return res.json();
  }

  function waitForSvgObject(obj) {
    return new Promise((resolve, reject) => {
      const done = () => {
        const doc = obj.contentDocument;
        if (!doc) return reject(new Error("SVG not available"));
        const svg = doc.querySelector("svg");
        if (!svg) return reject(new Error("SVG root missing"));
        resolve({doc, svg});
      };
      if (obj.contentDocument && obj.contentDocument.querySelector("svg")) return done();
      obj.addEventListener("load", done, {once:true});
      obj.addEventListener("error", () => reject(new Error("Failed to load event_plan.svg")), {once:true});
    });
  }

  function getStandElements(doc) {
    if (!doc) return [];
    return Array.from(doc.querySelectorAll("[id]")).filter(n => /^([A-Z]{1,2}\d{1,2}|A\d+|B\d+|C\d+|SB\d+|AA\d+|AB\d+|AC\d+|AD\d+)$/i.test(n.id));
  }

  function normalizeStands(list) {
    return (list||[]).map(s => ({
      standId: String(s.standId||"").toUpperCase(),
      status: String(s.status||"").toLowerCase(),
      company: String(s.company||""),
    }));
  }

  function getStandById(id) {
    const key = String(id||"").toUpperCase();
    return state.stands.find(s => s.standId === key) || null;
  }

  function applyPlanColors() {
    if (!state.svgDoc) return;
    const all = getStandElements(state.svgDoc);
    all.forEach(node => {
      const st = getStandById(node.id);
      const sold = st && st.status === "sold";
      node.style.fill = sold ? "var(--soldFill)" : "var(--mainFill)";
      node.style.cursor = "pointer";
    });
    if (state.selectedId) {
      const sel = state.svgDoc.getElementById(state.selectedId);
      if (sel) sel.style.filter = "brightness(1.02)";
    }
  }

  function clearOverlay(which) {
    el(which).innerHTML = "";
  }

  function updateLabelAndPointer() {
    const box = el("labelBox");
    if (!state.selectedId || !state.svgRoot) {
      box.classList.add("hidden");
      clearOverlay("overlay");
      return;
    }
    const st = getStandById(state.selectedId) || {standId: state.selectedId, company:""};
    el("labelStand").textContent = st.standId;
    el("labelCompany").textContent = st.company || (st.status === "sold" ? "" : "");
    box.classList.remove("hidden");

    const standEl = state.svgDoc.getElementById(state.selectedId);
    if (!standEl || !standEl.getBBox) {
      clearOverlay("overlay");
      return;
    }
    const bbox = standEl.getBBox();
    const cxSvg = bbox.x + bbox.width/2;
    const cySvg = bbox.y + bbox.height/2;

    const pt = state.svgRoot.createSVGPoint();
    pt.x = cxSvg; pt.y = cySvg;
    const screenPt = pt.matrixTransform(standEl.getScreenCTM());

    const stageRect = el("planStage").getBoundingClientRect();
    const labelRect = box.getBoundingClientRect();
    const x1 = screenPt.x - stageRect.left;
    const y1 = screenPt.y - stageRect.top;

    const x2 = (labelRect.left + labelRect.width/2) - stageRect.left;
    const y2 = (labelRect.top) - stageRect.top;

    const ov = el("overlay");
    const totalH = stageRect.height + el("labelArea").getBoundingClientRect().height;
    ov.setAttribute("width", stageRect.width);
    ov.setAttribute("height", totalH);
    ov.setAttribute("viewBox", `0 0 ${stageRect.width} ${totalH}`);
    ov.innerHTML = "";
    const ns = "http://www.w3.org/2000/svg";
    const line = document.createElementNS(ns, "line");
    line.setAttribute("x1", x1); line.setAttribute("y1", y1);
    line.setAttribute("x2", x2); line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#111");
    line.setAttribute("stroke-width", "3");
    line.setAttribute("stroke-linecap", "round");
    ov.appendChild(line);
    const dot = document.createElementNS(ns, "circle");
    dot.setAttribute("cx", x1);
    dot.setAttribute("cy", y1);
    dot.setAttribute("r", "6");
    dot.setAttribute("fill", "#111");
    dot.setAttribute("opacity", "0.85");
    ov.appendChild(dot);
  }

  function buildZoomRaw() {
    if (!state.zoomDoc) return;
    // remove fills so it's raw/outline
    getStandElements(state.zoomDoc).forEach(node => {
      node.style.fill = "#fff";
      node.style.stroke = "#111";
      node.style.strokeWidth = "1";
    });
  }

  function updateZoomHighlight() {
    const ov = el("zoomOverlay");
    ov.innerHTML = "";
    if (!state.selectedId || !state.zoomRoot || !state.zoomDoc) return;

    const standEl = state.zoomDoc.getElementById(state.selectedId);
    if (!standEl || !standEl.getBBox) return;

    const bbox = standEl.getBBox();
    const pad = 8;
    const x = bbox.x - pad, y = bbox.y - pad, w = bbox.width + pad*2, h = bbox.height + pad*2;

    // Use SVG coords, set overlay viewBox to match zoom root
    const vb = state.zoomRoot.viewBox && state.zoomRoot.viewBox.baseVal;
    let viewBox = null;
    if (vb && vb.width) {
      viewBox = {x: vb.x, y: vb.y, width: vb.width, height: vb.height};
    } else {
      const bb = state.zoomRoot.getBBox();
      viewBox = {x: bb.x, y: bb.y, width: bb.width, height: bb.height};
    }
    ov.setAttribute("viewBox", `${viewBox.x} ${viewBox.y} ${viewBox.width} ${viewBox.height}`);
    ov.setAttribute("preserveAspectRatio", "xMidYMid meet");

    const ns = "http://www.w3.org/2000/svg";
    const rect = document.createElementNS(ns, "rect");
    rect.setAttribute("x", x);
    rect.setAttribute("y", y);
    rect.setAttribute("width", w);
    rect.setAttribute("height", h);
    rect.setAttribute("rx", "10");
    rect.setAttribute("fill", "none");
    rect.setAttribute("stroke", "#111");
    rect.setAttribute("stroke-width", "6");
    rect.setAttribute("opacity", "0.9");
    ov.appendChild(rect);
  }

  function selectStand(id) {
    state.selectedId = String(id).toUpperCase();
    const st = getStandById(state.selectedId) || {standId: state.selectedId, status:"available", company:""};
    el("standId").value = st.standId;
    el("status").value = st.status === "sold" ? "sold" : "available";
    el("company").value = st.company || "";
    // ensure company disabled unless sold
    el("company").disabled = el("status").value !== "sold";

    renderTable();
    applyPlanColors();
    requestAnimationFrame(() => updateLabelAndPointer());
    updateZoomHighlight();
  }

  function renderTable() {
    const q = el("search").value.trim().toLowerCase();
    const f = el("filter").value;
    let rows = state.stands.slice();
    if (f !== "all") rows = rows.filter(s => s.status === f);
    if (q) rows = rows.filter(s => s.standId.toLowerCase().includes(q) || (s.company||"").toLowerCase().includes(q));
    rows.sort((a,b)=>a.standId.localeCompare(b.standId));
    el("count").textContent = String(rows.length);
    el("total").textContent = String(state.stands.length);

    const tb = el("tbody");
    tb.innerHTML = "";
    rows.forEach(s => {
      const tr = document.createElement("tr");
      if (state.selectedId === s.standId) tr.classList.add("sel");
      const badgeClass = s.status === "sold" ? "sold" : "av";
      const badgeText = s.status === "sold" ? "Sold" : "Available";
      tr.innerHTML = `
        <td><b>${s.standId}</b></td>
        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
        <td>${s.company || ""}</td>
      `;
      tr.addEventListener("click", ()=>selectStand(s.standId));
      tb.appendChild(tr);
    });
  }

  function wirePlanClicks() {
    if (!state.svgDoc) return;
    getStandElements(state.svgDoc).forEach(node => {
      node.onclick = null;
      node.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        selectStand(node.id);
      });
    });
  }

  async function loadAll() {
    // SVGs
    const p = await waitForSvgObject(el("planObj"));
    state.svgDoc = p.doc; state.svgRoot = p.svg;
    const z = await waitForSvgObject(el("zoomObj"));
    state.zoomDoc = z.doc; state.zoomRoot = z.svg;
    buildZoomRaw();

    // Data
    const [stands, settings] = await Promise.all([
      fetchJson("/stands"),
      fetchJson("/settings").catch(()=>null),
    ]);
    state.stands = normalizeStands(stands);
    if (settings && settings.eventName) el("eventName").value = settings.eventName;
    if (settings && settings.updatedAt) el("synced").textContent = settings.updatedAt;
    else el("synced").textContent = new Date().toLocaleTimeString();

    applyPlanColors();
    wirePlanClicks();
    renderTable();
  }

  async function saveStand() {
    const standId = el("standId").value.trim().toUpperCase();
    if (!standId) return alert("Stand ID required");
    const status = el("status").value;
    const company = (status === "sold") ? el("company").value.trim() : "";
    await fetchJson("/stand", {
      method: "POST",
      body: JSON.stringify({ standId, status, company })
    });
    await refresh();
    selectStand(standId);
  }

  async function markAvailable() {
    const standId = el("standId").value.trim().toUpperCase();
    if (!standId) return;
    await fetchJson("/stand", {
      method: "POST",
      body: JSON.stringify({ standId, status: "available", company: "" })
    });
    await refresh();
    selectStand(standId);
  }

  async function saveSettings() {
    const eventName = el("eventName").value.trim();
    await fetchJson("/settings", {
      method: "POST",
      body: JSON.stringify({ eventName })
    });
  }

  async function refresh() {
    const stands = await fetchJson("/stands");
    state.stands = normalizeStands(stands);
    el("synced").textContent = new Date().toLocaleTimeString();
    applyPlanColors();
    renderTable();
  }

  // CSV helpers
  function standsToCsv(list) {
    const lines = [["standId","status","company"]];
    list.forEach(s => lines.push([s.standId, s.status, (s.company||"").replaceAll('"','""')]));
    return lines.map(r => r.map(v => `"${String(v)}"`).join(",")).join("\n");
  }
  function download(name, content, mime) {
    const blob = new Blob([content], {type:mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();}, 500);
  }
  function parseCsv(text) {
    const rows = text.trim().split(/\r?\n/).map(l => l.split(",").map(x => x.replace(/^"|"$/g,"").replaceAll('""','"')));
    const header = rows.shift().map(h=>h.trim());
    const idx = {
      standId: header.indexOf("standId"),
      status: header.indexOf("status"),
      company: header.indexOf("company"),
    };
    return rows.filter(r=>r.length>=2).map(r=>({
      standId: (r[idx.standId]||"").toUpperCase(),
      status: (r[idx.status]||"available").toLowerCase(),
      company: (r[idx.company]||""),
    })).filter(x=>x.standId);
  }

  // UI wiring
  el("status").addEventListener("change", () => {
    el("company").disabled = el("status").value !== "sold";
    if (el("status").value !== "sold") el("company").value = "";
  });
  el("saveBtn").addEventListener("click", saveStand);
  el("markAvailBtn").addEventListener("click", markAvailable);
  el("search").addEventListener("input", renderTable);
  el("filter").addEventListener("change", renderTable);
  el("eventName").addEventListener("change", saveSettings);

  el("exportBtn").addEventListener("click", () => {
    download("stands.csv", standsToCsv(state.stands), "text/csv");
  });
  el("importBtn").addEventListener("click", async () => {
    const inp = document.createElement("input");
    inp.type = "file"; inp.accept = ".csv,text/csv";
    inp.onchange = async () => {
      const file = inp.files[0];
      if (!file) return;
      const txt = await file.text();
      const rows = parseCsv(txt);
      if (!confirm(`Import ${rows.length} rows? This will overwrite those stand IDs.`)) return;
      for (const r of rows) {
        await fetchJson("/stand", {
          method: "POST",
          body: JSON.stringify({ standId: r.standId, status: r.status, company: r.company })
        });
      }
      await refresh();
      alert("Import complete");
    };
    inp.click();
  });
  el("resetBtn").addEventListener("click", async () => {
    if (!confirm("Reset all stands to Available with no company?")) return;
    for (const s of state.stands) {
      await fetchJson("/stand", {
        method: "POST",
        body: JSON.stringify({ standId: s.standId, status: "available", company: "" })
      });
    }
    await refresh();
  });
  el("pauseBtn").addEventListener("click", () => {
    state.paused = !state.paused;
    el("pauseBtn").textContent = state.paused ? "Resume sync" : "Pause sync";
  });

  // Recalc label line on resize/scroll
  let resizeTimer = null;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => updateLabelAndPointer(), 50);
  });
  window.addEventListener("scroll", () => requestAnimationFrame(()=>updateLabelAndPointer()), {passive:true});

  // Auto sync
  setInterval(async () => {
    if (state.paused) return;
    try {
      await refresh();
    } catch(e) {}
  }, 15000);

  // Start
  loadAll().catch(err => {
    console.error(err);
    alert("Failed to load from backend: " + state.backend + "\n" + (err.message||err));
  });
})();
</script>
</body>
</html>
