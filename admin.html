<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Floorplan Admin</title>
  <style>
    :root{
      --bg:#fafafa;
      --card:#ffffff;
      --border:#e6e6e6;
      --text:#111;
      --muted:#666;
      --available:rgba(213,109,50,0.75);
      --sold:#e53935;
      --shadow:0 10px 24px rgba(0,0,0,.12);
      --radius:16px;
      --labelW:240px;
      --labelH:70px;
      --dotR:5;
      --lineW:3;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px}
    header h1{margin:0;font-size:20px}
    .topRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer}
    input[type="text"]{border:1px solid var(--border);border-radius:12px;padding:9px 10px}
    main{display:grid;grid-template-columns: minmax(520px, 1fr) 460px;gap:16px;padding:0 16px 16px}
    @media (max-width: 1060px){ main{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .cardHead{padding:12px 14px;border-bottom:1px solid #f0f0f0;font-weight:800}
    .planWrap{position:relative;display:flex;flex-direction:column;min-height:520px}
    .svgArea{position:relative;flex:1;min-height:320px}
    .svgHost{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:12px}
    .svgHost svg{width:100%;height:100%;max-height:100%;max-width:100%}
    .labelArea{position:relative;height:140px;border-top:1px solid #f0f0f0;background:#fff}
    .labelBox{
      position:absolute;left:50%;top:50%;
      width:var(--labelW);height:var(--labelH);
      transform:translate(-50%,-50%);
      background:var(--sold);
      border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;font-size:26px;letter-spacing:.02em;
      box-shadow:var(--shadow);
      pointer-events:none;
    }
    .labelHidden{display:none !important;}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .overlay line{stroke:#222;stroke-width:var(--lineW);stroke-linecap:round}
    .overlay circle{fill:#222}

    /* right panel */
    .panel{padding:14px}
    .box{border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:14px;background:#fff}
    .box h3{margin:0 0 10px;font-size:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);font-weight:700}
    select,input{width:100%}
    .btnRow{display:flex;gap:10px;margin-top:10px}
    .btnPrimary{background:#f1fff7;border-color:#cdeedd}
    .btnDanger{background:#fff4f4;border-color:#f2c6c6}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}

    .list{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:14px;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid #f2f2f2;text-align:left}
    tr:hover{background:#fafafa;cursor:pointer}
    tr.active{background:#eef3ff}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
    .pill.sold{background:#fff0f0;color:#b00020;border:1px solid #ffd1d1}
    .pill.avail{background:#fff7f0;color:#8a3b00;border:1px solid #ffd8b8}

    /* Zoom */
    .zoomWrap{padding:12px}
    .zoomBox{border:1px solid var(--border);border-radius:14px;background:#fff;min-height:240px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .zoomBox svg{width:100%;height:100%}
    .zoomHint{color:var(--muted);font-size:12px;margin-top:8px}

    .error{color:#b00020;font-weight:800;margin-left:10px}
  </style>
</head>
<body>
  <header>
    <h1>Floorplan Admin</h1>
    <div class="topRight">
      <span style="color:#666;font-size:13px;font-weight:700">Synced: <span id="syncedAt">—</span></span>
      <span style="color:#666;font-size:13px;font-weight:700">Event name</span>
      <input id="eventName" type="text" placeholder="New Event" style="width:200px"/>
      <button id="pauseBtn">Pause sync</button>
      <button id="exportCsvBtn">Export CSV</button>
      <button id="importCsvBtn">Import CSV</button>
      <button id="resetBtn" class="btnDanger">Reset all</button>
      <span id="err" class="error" style="display:none"></span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="cardHead">Plan</div>
      <div class="planWrap" id="planWrap">
        <div class="svgArea">
          <div class="svgHost" id="svgHost"></div>
          <svg class="overlay" id="overlaySvg"></svg>
        </div>
        <div class="labelArea">
          <div class="labelBox labelHidden" id="labelBox"><span id="labelId"></span></div>
        </div>
      </div>

      <div class="zoomWrap">
        <div class="cardHead" style="border-top:1px solid #f0f0f0">Zoom</div>
        <div class="zoomBox" id="zoomBox"></div>
        <div class="zoomHint">Select a stand to zoom in. (Zoom shows the raw SVG with a circle highlight.)</div>
      </div>
    </section>

    <aside class="panel">
      <div class="box">
        <h3>Selected Stand</h3>
        <label>Stand ID</label>
        <input id="standId" type="text" placeholder=""/>
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>Status</label>
            <select id="statusSel">
              <option value="available">Available</option>
              <option value="sold">Sold</option>
            </select>
          </div>
          <div>
            <label>Company (sold only)</label>
            <input id="companyInp" type="text" placeholder="Company name…"/>
          </div>
        </div>
        <div class="btnRow">
          <button id="saveBtn" class="btnPrimary" style="flex:1">Save</button>
          <button id="markAvailBtn" class="btnDanger" style="flex:1">Mark Available</button>
        </div>
        <div class="hint">Click a stand on the plan or in the list to edit.</div>
      </div>

      <div class="box">
        <h3>Stands</h3>
        <div style="display:flex;gap:10px">
          <input id="searchInput" type="text" placeholder="Search stand or company…" style="flex:1"/>
          <select id="filterSel" style="width:120px">
            <option value="all">All</option>
            <option value="sold">Sold</option>
            <option value="available">Available</option>
          </select>
        </div>
        <div style="margin:10px 0;color:#666;font-weight:800;font-size:13px"><span id="countTxt">0 / 0</span></div>
        <div class="list">
          <table>
            <thead>
              <tr><th>Stand</th><th>Status</th><th>Company</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

<script>
(() => {
  const DEFAULT_BACKEND = "https://floorplansaberdeen.floorplansaberdeen.workers.dev";
  const STANDS_ENDPOINT = "/stands";
  const UPDATE_ENDPOINT = (id) => `/stands/${encodeURIComponent(id)}`; // PUT
  const SVG_URL = "event_plan.svg";

  const COLORS = {
    available: getComputedStyle(document.documentElement).getPropertyValue('--available').trim() || "rgba(213,109,50,0.75)",
    sold: getComputedStyle(document.documentElement).getPropertyValue('--sold').trim() || "#e53935",
    selected: getComputedStyle(document.documentElement).getPropertyValue('--sold').trim() || "#e53935",
  };

  const el = (id) => document.getElementById(id);

  const state = {
    backend: getBackendBase(),
    svgEl: null,
    originalSvgText: null,
    standElById: new Map(),
    stands: [],
    selectedId: null,
    syncTimer: null,
    paused: false
  };

  function getBackendBase(){
    const saved = localStorage.getItem("floorplan_backend_base");
    if (saved && /^https?:\/\//i.test(saved)) return saved.replace(/\/+$/,'');
    return DEFAULT_BACKEND;
  }

  function setErr(msg){
    const e = el("err");
    if(!msg){ e.style.display="none"; e.textContent=""; return; }
    e.style.display="inline";
    e.textContent = msg;
  }

  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.text();
  }

  async function loadSvg(){
    const host = el("svgHost");
    host.innerHTML = "";
    const svgText = await fetchText(SVG_URL);
    state.originalSvgText = svgText;
    const doc = new DOMParser().parseFromString(svgText, "image/svg+xml");
    const svg = doc.documentElement;
    svg.removeAttribute("width"); svg.removeAttribute("height");
    svg.setAttribute("preserveAspectRatio","xMidYMid meet");
    svg.style.width="100%"; svg.style.height="100%";
    host.appendChild(svg);
    state.svgEl = svg;
    state.standElById.clear();
  }

  function findStandEl(standId){
    if(state.standElById.has(standId)) return state.standElById.get(standId);
    if(!state.svgEl) return null;
    let node = state.svgEl.querySelector(`#${CSS.escape(standId)}`);
    if(!node) node = state.svgEl.querySelector(`[data-stand="${standId}"]`);
    state.standElById.set(standId, node || null);
    return node || null;
  }

  async function fetchStands(){
    const res = await fetch(state.backend + STANDS_ENDPOINT, {cache:"no-store"});
    if(!res.ok) throw new Error(`Backend error ${res.status}`);
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("Unexpected backend response");
    state.stands = data.map(x => ({
      standId: String(x.standId||"").trim(),
      status: String(x.status||"").toLowerCase(),
      company: String(x.company||"").trim()
    })).filter(x => x.standId);
    el("syncedAt").textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  }

  function applyStandColors(){
    for(const s of state.stands){
      const node = findStandEl(s.standId);
      if(!node) continue;
      node.style.fill = (s.status === "sold") ? COLORS.sold : COLORS.available;
      node.style.cursor="pointer";
      node.style.transition="fill 120ms ease";
    }
    if(state.selectedId){
      const node = findStandEl(state.selectedId);
      if(node) node.style.filter = "brightness(0.95)";
    }
  }

  function standCenterInPlan(standId){
    const node = findStandEl(standId);
    if(!node) return null;
    const planRect = el("planWrap").getBoundingClientRect();
    const r = node.getBoundingClientRect();
    return { x:(r.left+r.right)/2 - planRect.left, y:(r.top+r.bottom)/2 - planRect.top };
  }

  function updatePointer(){
    const overlay = el("overlaySvg");
    overlay.innerHTML = "";
    overlay.setAttribute("width","100%");
    overlay.setAttribute("height","100%");
    overlay.setAttribute("viewBox", `0 0 ${el("planWrap").clientWidth} ${el("planWrap").clientHeight}`);

    const labelBox = el("labelBox");
    if(!state.selectedId){
      labelBox.classList.add("labelHidden");
      return;
    }
    labelBox.classList.remove("labelHidden");
    el("labelId").textContent = state.selectedId;

    const planRect = el("planWrap").getBoundingClientRect();
    const labelRect = labelBox.getBoundingClientRect();
    const p = standCenterInPlan(state.selectedId);
    if(!p) return;

    const lx = (labelRect.left + labelRect.right)/2 - planRect.left;
    const ly = labelRect.top - planRect.top;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", lx);
    line.setAttribute("y1", ly);
    line.setAttribute("x2", p.x);
    line.setAttribute("y2", p.y);
    overlay.appendChild(line);

    const dot = document.createElementNS("http://www.w3.org/2000/svg","circle");
    const r = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dotR')) || 5;
    dot.setAttribute("cx", p.x);
    dot.setAttribute("cy", p.y);
    dot.setAttribute("r", r);
    overlay.appendChild(dot);
  }

  function renderTable(){
    const q = (el("searchInput").value||"").trim().toLowerCase();
    const filter = el("filterSel").value;
    let items = state.stands.slice();
    if(filter !== "all") items = items.filter(s => s.status === filter);
    if(q){
      items = items.filter(s => s.standId.toLowerCase().includes(q) || (s.company||"").toLowerCase().includes(q));
    }
    items.sort((a,b) => a.standId.localeCompare(b.standId, undefined, {numeric:true}));

    el("countTxt").textContent = `${items.length} / ${state.stands.length}`;

    const tbody = el("tbody");
    tbody.innerHTML = "";
    for(const s of items){
      const tr = document.createElement("tr");
      if(state.selectedId === s.standId) tr.classList.add("active");
      tr.innerHTML = `
        <td><strong>${escapeHtml(s.standId)}</strong></td>
        <td><span class="pill ${s.status==='sold'?'sold':'avail'}">${s.status==='sold'?'Sold':'Available'}</span></td>
        <td>${escapeHtml(s.company||"")}</td>
      `;
      tr.addEventListener("click", () => setSelected(s.standId));
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function fillFormFromSelected(){
    const s = state.stands.find(x => x.standId === state.selectedId);
    el("standId").value = state.selectedId || "";
    el("statusSel").value = s ? (s.status || "available") : "available";
    el("companyInp").value = s ? (s.company || "") : "";
  }

  function setSelected(standId){
    state.selectedId = standId;
    fillFormFromSelected();
    renderTable();
    applyStandColors();
    updatePointer();
    renderZoom();
  }

  function renderZoom(){
    const box = el("zoomBox");
    box.innerHTML = "";
    if(!state.originalSvgText){
      return;
    }
    const doc = new DOMParser().parseFromString(state.originalSvgText, "image/svg+xml");
    const svg = doc.documentElement;
    svg.removeAttribute("width"); svg.removeAttribute("height");
    svg.setAttribute("preserveAspectRatio","xMidYMid meet");

    // Remove any inline fills (raw SVG)
    svg.querySelectorAll("[style]").forEach(n => { n.removeAttribute("style"); });

    // If selected, zoom to its bbox
    if(state.selectedId){
      const target = svg.querySelector(`#${CSS.escape(state.selectedId)}`) || svg.querySelector(`[data-stand="${state.selectedId}"]`);
      if(target && target.getBBox){
        const b = target.getBBox();
        const pad = Math.max(30, Math.max(b.width, b.height) * 0.6);
        const vb = {
          x: b.x - pad,
          y: b.y - pad,
          w: b.width + pad*2,
          h: b.height + pad*2
        };
        svg.setAttribute("viewBox", `${vb.x} ${vb.y} ${vb.w} ${vb.h}`);

        // Circle highlight around stand center
        const cx = b.x + b.width/2;
        const cy = b.y + b.height/2;
        const rr = Math.max(b.width, b.height) * 0.75;
        const circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circ.setAttribute("cx", cx);
        circ.setAttribute("cy", cy);
        circ.setAttribute("r", rr);
        circ.setAttribute("fill","none");
        circ.setAttribute("stroke","#111");
        circ.setAttribute("stroke-width","6");
        circ.setAttribute("opacity","0.75");
        svg.appendChild(circ);
      }
    }
    box.appendChild(svg);
  }

  async function saveSelected(){
    const id = (el("standId").value||"").trim();
    if(!id){ setErr("Pick a stand first."); return; }
    const status = el("statusSel").value;
    const company = (el("companyInp").value||"").trim();
    const payload = { standId: id, status, company: status==="sold" ? company : "" };

    const res = await fetch(state.backend + UPDATE_ENDPOINT(id), {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`Save failed (${res.status}). ${txt}`.trim());
    }
    // refresh
    await refreshNow();
  }

  async function markAvailable(){
    el("statusSel").value = "available";
    el("companyInp").value = "";
    await saveSelected();
  }

  async function refreshNow(){
    try{
      setErr("");
      if(!state.svgEl) await loadSvg();
      await fetchStands();
      applyStandColors();
      wireStandClicks();
      renderTable();
      fillFormFromSelected();
      updatePointer();
      renderZoom();
    }catch(err){
      console.error(err);
      setErr(err.message || String(err));
    }
  }

  function wireStandClicks(){
    if(!state.svgEl) return;
    for(const s of state.stands){
      const node = findStandEl(s.standId);
      if(!node) continue;
      node.onclick = () => setSelected(s.standId);
    }
  }

  function scheduleSync(){
    if(state.syncTimer) clearInterval(state.syncTimer);
    state.syncTimer = setInterval(async () => {
      if(state.paused) return;
      await refreshNow();
    }, 15000);
  }

  // Buttons
  el("saveBtn").addEventListener("click", async () => {
    try{ await saveSelected(); } catch(e){ setErr(e.message||String(e)); }
  });
  el("markAvailBtn").addEventListener("click", async () => {
    try{ await markAvailable(); } catch(e){ setErr(e.message||String(e)); }
  });
  el("searchInput").addEventListener("input", renderTable);
  el("filterSel").addEventListener("change", renderTable);
  el("pauseBtn").addEventListener("click", () => {
    state.paused = !state.paused;
    el("pauseBtn").textContent = state.paused ? "Resume sync" : "Pause sync";
  });
  el("exportCsvBtn").addEventListener("click", () => exportCsv());
  el("importCsvBtn").addEventListener("click", () => importCsv());
  el("resetBtn").addEventListener("click", async () => {
    if(!confirm("Reset all stands to available?")) return;
    try{
      for(const s of state.stands){
        await fetch(state.backend + UPDATE_ENDPOINT(s.standId), {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ standId:s.standId, status:"available", company:"" })
        });
      }
      await refreshNow();
    }catch(e){ setErr(e.message||String(e)); }
  });

  function exportCsv(){
    const rows = [["standId","status","company"], ...state.stands.map(s => [s.standId, s.status, s.company||""])];
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "stands.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function importCsv(){
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = ".csv,text/csv";
    inp.onchange = async () => {
      const file = inp.files && inp.files[0];
      if(!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      const header = lines.shift().split(",").map(s => s.replace(/^"|"$/g,"").trim().toLowerCase());
      const idxId = header.indexOf("standid");
      const idxStatus = header.indexOf("status");
      const idxCompany = header.indexOf("company");
      for(const line of lines){
        const cols = parseCsvLine(line);
        const id = (cols[idxId]||"").trim();
        if(!id) continue;
        const status = (cols[idxStatus]||"available").trim().toLowerCase();
        const company = (cols[idxCompany]||"").trim();
        await fetch(state.backend + UPDATE_ENDPOINT(id), {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ standId:id, status, company: status==="sold" ? company : "" })
        });
      }
      await refreshNow();
    };
    inp.click();
  }

  function parseCsvLine(line){
    const out=[]; let cur=""; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){
        if(inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ = !inQ;
      }else if(ch === ',' && !inQ){
        out.push(cur); cur="";
      }else cur+=ch;
    }
    out.push(cur);
    return out.map(s => s.trim().replace(/^"|"$/g,""));
  }

  // Keep pointer aligned
  window.addEventListener("resize", updatePointer);
  window.addEventListener("scroll", updatePointer, {passive:true});

  // init
  (async () => {
    await refreshNow();
    scheduleSync();
  })();
})();
</script>
</body>
</html>
