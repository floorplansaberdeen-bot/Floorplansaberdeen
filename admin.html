<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Floorplan Admin</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --border: rgba(0,0,0,.10);
      --text:#111;
      --muted: rgba(0,0,0,.62);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --available: rgba(213,109,50,0.75);
      --sold: #e53935;
      --line: rgba(0,0,0,.65);
      --dot: rgba(0,0,0,.75);
      --radius: 14px;
      --labelWDesktop: 220px;
      --labelWPhone: 190px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text);}
    header{
      padding:14px 16px;
      border-bottom:1px solid rgba(0,0,0,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    header .left{font-weight:900; font-size:18px}
    header .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .meta{color:var(--muted); font-size:13px}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.danger{border-color: rgba(229,57,53,.35); background: rgba(229,57,53,.06)}
    .btn:active{transform: translateY(1px)}
    .layout{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .cardHeader{
      padding:10px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-weight:900;
    }
    .planWrap{padding:12px; position:relative; overflow:hidden;}
    .svgHost{
      position:relative;
      width:100%;
      height: 460px;
      border-radius: 12px;
      overflow:hidden;
    }
    .svgHost svg{width:100%; height:100%; display:block}
    .overlay{position:absolute; inset:0; pointer-events:none;}
    .legend{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px 0;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid rgba(0,0,0,.10);
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      font-size:13px;
      background:#fff;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .zoomWrap{padding:0 12px 12px}
    .zoomHost{
      width:100%;
      height: 250px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.10);
      overflow:hidden;
      background:#fff;
      position:relative;
    }
    .zoomHost svg{width:100%; height:100%; display:block}
    .zoomHint{padding:8px 2px 0; color:var(--muted); font-size:13px}
    .side{padding:12px; display:flex; flex-direction:column; gap:12px;}
    .panel{border:1px solid rgba(0,0,0,.08); border-radius:14px; padding:12px;}
    .panel h3{margin:0 0 10px; font-size:16px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:800}
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.14);
      font-size:15px;
      background:#fff;
    }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .actionsRow{display:flex; gap:10px; margin-top:10px}
    .actionsRow .btn{flex:1}
    .tableWrap{
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{background: rgba(0,0,0,.04); padding:10px; text-align:left}
    tbody td{border-top:1px solid rgba(0,0,0,.06); padding:9px 10px; vertical-align:middle}
    tbody tr:hover{background: rgba(0,0,0,.03)}
    tbody tr.active{outline:2px solid rgba(74,144,226,.35); background: rgba(74,144,226,.06)}
    .badge{
      display:inline-flex; align-items:center; padding:3px 8px; border-radius:999px; font-weight:900;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
    }
    .badge.sold{border-color: rgba(229,57,53,.35); background: rgba(229,57,53,.06); color:#b71c1c}
    .badge.avail{border-color: rgba(213,109,50,.35); background: rgba(213,109,50,.10); color:#6d3b1f}
    /* Overlay label */
    .labelBox{filter: drop-shadow(0 8px 18px rgba(0,0,0,.18));}
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .svgHost{height: 380px}
    }
  </style>
</head>
<body>
<header>
  <div class="left">Floorplan Admin</div>
  <div class="right">
    <div class="meta" id="syncMeta">Synced: —</div>
    <div class="panel" style="padding:8px 10px; border-radius:12px;">
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-weight:900;">Event name</div>
        <input id="eventName" style="width:220px; padding:8px 10px; border-radius:10px;" />
      </div>
    </div>
    <button class="btn" id="pauseBtn">Pause sync</button>
    <button class="btn" id="exportCsvBtn">Export CSV</button>
    <button class="btn" id="importCsvBtn">Import CSV</button>
    <button class="btn danger" id="resetBtn">Reset all</button>
  </div>
</header>

<div class="layout">
  <div class="card">
    <div class="cardHeader">Plan</div>
    <div class="planWrap">
      <div class="svgHost" id="svgHost">
        <div class="overlay">
          <svg id="overlaySvg" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
      <div class="legend">
        <span class="pill"><span class="dot" style="background: var(--sold)"></span>Sold</span>
        <span class="pill"><span class="dot" style="background: var(--available)"></span>Available</span>
      </div>
    </div>
    <div class="cardHeader">Zoom</div>
    <div class="zoomWrap">
      <div class="zoomHost" id="zoomHost"></div>
      <div class="zoomHint">Select a stand to zoom in.</div>
    </div>
  </div>

  <div class="card side">
    <div class="panel">
      <h3>Selected Stand</h3>
      <div style="margin-bottom:10px">
        <label>Stand ID</label>
        <input id="standId" placeholder="" disabled />
      </div>
      <div class="row">
        <div>
          <label>Status</label>
          <select id="status">
            <option value="available">Available</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div>
          <label>Company (sold only)</label>
          <input id="company" placeholder="Company name…" />
        </div>
      </div>
      <div class="actionsRow">
        <button class="btn" id="saveBtn" style="border-color: rgba(27,94,32,.25); background: rgba(27,94,32,.06)">Save</button>
        <button class="btn" id="markAvailBtn" style="border-color: rgba(229,57,53,.20); background: rgba(229,57,53,.05)">Mark Available</button>
      </div>
      <div class="meta" style="margin-top:10px">Click a stand on the plan or in the list to edit.</div>
    </div>

    <div class="panel">
      <h3>Stands</h3>
      <div style="display:flex; gap:10px; margin:10px 0;">
        <input id="search" placeholder="Search stand or company…" />
        <select id="filter" style="width:160px">
          <option value="all">All</option>
          <option value="sold">Sold</option>
          <option value="available">Available</option>
        </select>
      </div>
      <div class="meta" id="countMeta">0 / 0</div>
      <div class="tableWrap" style="margin-top:8px">
        <table>
          <thead>
            <tr><th style="width:90px">Stand</th><th style="width:110px">Status</th><th>Company</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== CONFIG =====
  const DEFAULT_API_BASE = "https://floorplansaberdeen-bot.workers.dev";
const API_BASE = (() => {
  const override = window.API_BASE;
  const saved = localStorage.getItem("floorplan_api_base");
  const base = (override && typeof override==="string") ? override : ((saved && saved.startsWith("http")) ? saved : DEFAULT_API_BASE);
  return base.replace(/\/+$/,"");
})(); // change if needed
  const STANDS_ENDPOINT = `${API_BASE}/stands`;
  const SETTINGS_ENDPOINT = `${API_BASE}/settings`;
  // ---- Backend selection & resilient fetch ----
  function setApiBase(newBase){
    if(!newBase) return;
    const clean = String(newBase).trim().replace(/\/+$/,"");
    localStorage.setItem("floorplan_api_base", clean);
    location.reload();
  }

  function backendUi(message){
    let el = document.getElementById("backendBanner");
    if(!el){
      el = document.createElement("div");
      el.id = "backendBanner";
      el.style.cssText = "position:fixed;left:12px;right:12px;bottom:12px;z-index:99999;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:flex;gap:12px;align-items:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;font-size:14px;";
      el.innerHTML = `<div style="flex:1;line-height:1.3"></div>
        <button id="backendSetBtn" style="background:#fff;color:#111;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer">Set backend URL</button>
        <button id="backendHideBtn" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer">Hide</button>`;
      document.body.appendChild(el);
      el.querySelector("#backendSetBtn").onclick = () => {
        const current = localStorage.getItem("floorplan_api_base") || DEFAULT_API_BASE;
        const v = prompt("Paste your backend URL (Cloudflare Worker or Google Apps Script Web App):", current);
        if(v) setApiBase(v);
      };
      el.querySelector("#backendHideBtn").onclick = () => el.remove();
    }
    el.firstElementChild.textContent = message || "Backend not reachable.";
  }

  async function safeFetch(url, options){
    try{
      const res = await fetch(url, options);
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt?": "+txt.slice(0,120):""}`);
      }
      return res;
    }catch(err){
      backendUi("Can't reach the backend right now (this is why the page won't load). If Cloudflare is down, paste your Google Apps Script Web App URL instead.");
      throw err;
    }
  }
  const UPDATE_ENDPOINT = `${API_BASE}/update`;
  const RESET_ENDPOINT = `${API_BASE}/reset`;
  const EXPORT_CSV_ENDPOINT = `${API_BASE}/export`;
  const IMPORT_CSV_ENDPOINT = `${API_BASE}/import`;
  const SVG_URL = "event_plan.svg";

  const COLORS = {
    available: getComputedStyle(document.documentElement).getPropertyValue('--available').trim() || "rgba(213,109,50,0.75)",
    sold: getComputedStyle(document.documentElement).getPropertyValue('--sold').trim() || "#e53935",
    line: getComputedStyle(document.documentElement).getPropertyValue('--line').trim() || "rgba(0,0,0,.65)",
    dot: getComputedStyle(document.documentElement).getPropertyValue('--dot').trim() || "rgba(0,0,0,.75)",
  };

  const svgHost = document.getElementById("svgHost");
  const overlaySvg = document.getElementById("overlaySvg");
  const zoomHost = document.getElementById("zoomHost");

  const syncMeta = document.getElementById("syncMeta");
  const eventNameEl = document.getElementById("eventName");
  const pauseBtn = document.getElementById("pauseBtn");
  const exportCsvBtn = document.getElementById("exportCsvBtn");
  const importCsvBtn = document.getElementById("importCsvBtn");
  const resetBtn = document.getElementById("resetBtn");

  const standIdEl = document.getElementById("standId");
  const statusEl = document.getElementById("status");
  const companyEl = document.getElementById("company");
  const saveBtn = document.getElementById("saveBtn");
  const markAvailBtn = document.getElementById("markAvailBtn");

  const searchEl = document.getElementById("search");
  const filterEl = document.getElementById("filter");
  const tbody = document.getElementById("tbody");
  const countMeta = document.getElementById("countMeta");

  const isPhone = () => window.matchMedia("(max-width: 640px)").matches;

  let svgRoot = null;
  let standsData = [];
  let standsById = new Map();
  let standEls = new Map(); // id -> svg element
  let standScreenBoxes = new Map(); // id -> {x,y,w,h,cx,cy}
  let selectedStandId = null;

  let paused = false;
  let pollTimer = null;

  function normId(s){ return (s||"").toString().trim(); }
  function statusNorm(s){ return (s||"").toString().toLowerCase().trim() === "sold" ? "sold" : "available"; }

  async function fetchJson(url, opts={}){
    const isBackend = (typeof url === "string") && (url.startsWith(API_BASE) || url.startsWith(DEFAULT_API_BASE));
    const res = isBackend ? await safeFetch(url, {cache:"no-store", ...opts}) : await fetch(url, {cache:"no-store", ...opts});
    if(!res.ok){
      const txt = await res.text().catch(()=> "");
      throw new Error(`Fetch failed: ${url} (${res.status}) ${txt.slice(0,120)}`);
    }
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    return ct.includes("application/json") ? await res.json() : await res.text();
  }

  async function loadSvg(){
    const r = await fetch(SVG_URL, {cache:"no-store"});
    if(!r.ok) throw new Error(`SVG not found: ${SVG_URL}`);
    const txt = await r.text();
    const wrap = document.createElement("div");
    wrap.innerHTML = txt;
    const s = wrap.querySelector("svg");
    if(!s) throw new Error("Invalid SVG");
    svgHost.querySelectorAll("svg").forEach(x => x.remove());
    svgHost.insertBefore(s, svgHost.firstChild);
    svgRoot = s;
    svgRoot.removeAttribute("width");
    svgRoot.removeAttribute("height");
    svgRoot.style.width = "100%";
    svgRoot.style.height = "100%";
    overlaySvg.innerHTML = ""; // remove any stray shapes (fix quarter circle)
  }

  function findStandElements(){
    standEls.clear();
    const all = svgRoot.querySelectorAll("[id],[data-stand]");
    all.forEach(el => {
      const id = normId(el.getAttribute("data-stand") || el.id);
      if(!id) return;
      if (standsById.has(id) || /^[A-Z]{1,3}\d{1,3}$/.test(id) || /^SB\d{1,3}$/.test(id)) {
        const tag = el.tagName.toLowerCase();
        if(["path","rect","polygon","polyline","circle","ellipse"].includes(tag) || el.getBBox){
          if(!standEls.has(id)) standEls.set(id, el);
        }
      }
    });
  }

  function applyColors(){
    for(const [id, el] of standEls.entries()){
      const s = standsById.get(id);
      const st = statusNorm(s ? s.status : "available");
      el.style.fill = (st === "sold") ? COLORS.sold : COLORS.available;
      el.style.stroke = "rgba(0,0,0,.55)";
      el.style.strokeWidth = "1";
      el.style.cursor = "pointer";
      el.style.transition = "fill 140ms ease";
    }
  }

  function computeStandBoxes(){
    standScreenBoxes.clear();
    const hostRect = svgHost.getBoundingClientRect();
    for(const [id, el] of standEls.entries()){
      try{
        const bb = el.getBBox();
        const m = el.getScreenCTM();
        if(!m) continue;
        const pts = [
          {x: bb.x, y: bb.y},
          {x: bb.x+bb.width, y: bb.y},
          {x: bb.x+bb.width, y: bb.y+bb.height},
          {x: bb.x, y: bb.y+bb.height},
        ].map(p => {
          const pt = svgRoot.createSVGPoint();
          pt.x = p.x; pt.y = p.y;
          const sp = pt.matrixTransform(m);
          return {x: sp.x - hostRect.left, y: sp.y - hostRect.top};
        });
        const xs = pts.map(p=>p.x), ys = pts.map(p=>p.y);
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const box = {x:minX, y:minY, w:maxX-minX, h:maxY-minY};
        box.cx = box.x + box.w/2;
        box.cy = box.y + box.h/2;
        standScreenBoxes.set(id, box);
      }catch(e){}
    }
  }

  function rectsIntersect(a,b){
    return !(a.x+a.w < b.x || b.x+b.w < a.x || a.y+a.h < b.y || b.y+b.h < a.y);
  }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function buildLabelLayout(id){
    const w = isPhone() ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--labelWPhone')) : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--labelWDesktop'));
    const h = isPhone() ? 70 : 74;
    return {w,h,standText:id};
  }

  function chooseLabelPosition(targetBox, label){
    const hostRect = svgHost.getBoundingClientRect();
    const W = hostRect.width, H = hostRect.height;
    const d = isPhone() ? 62 : 92;
    const candidates = [
      {x: targetBox.cx - label.w/2, y: targetBox.cy + d},
      {x: targetBox.cx - label.w/2, y: targetBox.cy - d - label.h},
      {x: targetBox.cx + d, y: targetBox.cy - label.h/2},
      {x: targetBox.cx - d - label.w, y: targetBox.cy - label.h/2},
      {x: targetBox.cx + d*.8, y: targetBox.cy + d*.8},
      {x: targetBox.cx - d*.8 - label.w, y: targetBox.cy + d*.8},
      {x: targetBox.cx + d*.8, y: targetBox.cy - d*.8 - label.h},
      {x: targetBox.cx - d*.8 - label.w, y: targetBox.cy - d*.8 - label.h},
    ];
    const standRects = Array.from(standScreenBoxes.values()).map(b => ({x:b.x-6,y:b.y-6,w:b.w+12,h:b.h+12}));
    function score(c){
      const r = {x: clamp(c.x, 8, W - label.w - 8), y: clamp(c.y, 8, H - label.h - 8), w: label.w, h: label.h};
      let collisions = 0;
      for(const s of standRects){
        if(rectsIntersect(r, s)) collisions++;
      }
      const dy = Math.abs((r.y + r.h/2) - (targetBox.cy + d));
      const dx = Math.abs((r.x + r.w/2) - targetBox.cx);
      const edgePenalty = (r.x<12||r.y<12||r.x+r.w>W-12||r.y+r.h>H-12) ? 2 : 0;
      return {r, metric: collisions*10000 + edgePenalty*800 + dy*2 + dx};
    }
    let best=null;
    for(const c of candidates){
      const s = score(c);
      if(!best || s.metric < best.metric) best=s;
    }
    return best.r;
  }

  function drawOverlay(){
    overlaySvg.innerHTML = ""; // remove any stray shapes (fix quarter circle)
    if(!selectedStandId) return;
    const box = standScreenBoxes.get(selectedStandId);
    if(!box) return;

    const label = buildLabelLayout(selectedStandId);
    const pos = chooseLabelPosition(box, label);

    const sx = box.cx, sy = box.cy;
    const lx = pos.x, ly = pos.y, lw = pos.w, lh = pos.h;
    const px = clamp(sx, lx, lx+lw);
    const py = clamp(sy, ly, ly+lh);

    let ex = px, ey = py;
    const leftDist = Math.abs(px - lx);
    const rightDist = Math.abs(px - (lx+lw));
    const topDist = Math.abs(py - ly);
    const bottomDist = Math.abs(py - (ly+lh));
    const m = Math.min(leftDist, rightDist, topDist, bottomDist);
    if(m === leftDist) ex = lx;
    else if(m === rightDist) ex = lx+lw;
    else if(m === topDist) ey = ly;
    else ey = ly+lh;

    const dotR = isPhone() ? 4.0 : 4.6;

    const NS="http://www.w3.org/2000/svg";
    const line = document.createElementNS(NS,"line");
    line.setAttribute("x1", ex); line.setAttribute("y1", ey);
    line.setAttribute("x2", sx); line.setAttribute("y2", sy);
    line.setAttribute("stroke", COLORS.line);
    line.setAttribute("stroke-width", isPhone()? "3" : "3.2");
    line.setAttribute("stroke-linecap","round");
    line.setAttribute("opacity","0.9");

    const dot = document.createElementNS(NS,"circle");
    dot.setAttribute("cx", sx); dot.setAttribute("cy", sy);
    dot.setAttribute("r", dotR);
    dot.setAttribute("fill", COLORS.dot);

    const g = document.createElementNS(NS,"g");
    g.setAttribute("class","labelBox");

    const rect = document.createElementNS(NS,"rect");
    rect.setAttribute("x", lx); rect.setAttribute("y", ly);
    rect.setAttribute("width", lw); rect.setAttribute("height", lh);
    rect.setAttribute("rx", isPhone()? "16" : "18");
    rect.setAttribute("fill", COLORS.sold);
    rect.setAttribute("opacity","0.96");

    const t1 = document.createElementNS(NS,"text");
    t1.setAttribute("x", lx + lw/2);
    t1.setAttribute("y", ly + (isPhone()? 46 : 48));
    t1.setAttribute("text-anchor","middle");
    t1.setAttribute("font-weight","900");
    t1.setAttribute("font-size", isPhone()? "30" : "30");
    t1.setAttribute("fill","#fff");
    t1.textContent = selectedStandId;

    g.appendChild(rect);
    g.appendChild(t1);

    overlaySvg.appendChild(line);
    overlaySvg.appendChild(dot);
    overlaySvg.appendChild(g);
  }

  function renderZoom(){
    zoomHost.innerHTML = "";
    if(!selectedStandId || !svgRoot) return;

    // Clone SVG for zoom
    const clone = svgRoot.cloneNode(true);
    clone.removeAttribute("width"); clone.removeAttribute("height");
    clone.style.width="100%"; clone.style.height="100%";
    // Make it monochrome (outlines)
    clone.querySelectorAll("[style]").forEach(n => { /* keep */ });
    clone.querySelectorAll("path,rect,polygon,polyline,circle,ellipse").forEach(n => {
      n.style.fill = "transparent";
      n.style.stroke = "rgba(0,0,0,.65)";
      n.style.strokeWidth = "1.2";
    });

    // Focus viewBox around selected stand bbox in SVG coords
    const el = standEls.get(selectedStandId);
    if(!el) { zoomHost.appendChild(clone); return; }
    const bb = el.getBBox();
    const pad = Math.max(bb.width, bb.height) * 0.8 + 20;
    const x = bb.x - pad;
    const y = bb.y - pad;
    const w = bb.width + pad*2;
    const h = bb.height + pad*2;
    clone.setAttribute("viewBox", `${x} ${y} ${w} ${h}`);

    // Add a highlight ring (circle) centered on stand bbox
    const NS="http://www.w3.org/2000/svg";
    const ring = document.createElementNS(NS,"circle");
    ring.setAttribute("cx", bb.x + bb.width/2);
    ring.setAttribute("cy", bb.y + bb.height/2);
    const r = Math.max(bb.width, bb.height) * 0.65 + 10;
    ring.setAttribute("r", r);
    ring.setAttribute("fill","none");
    ring.setAttribute("stroke","rgba(0,0,0,.75)");
    ring.setAttribute("stroke-width","6");
    ring.setAttribute("stroke-linecap","round");
    ring.setAttribute("opacity","0.9");
    clone.appendChild(ring);

    zoomHost.appendChild(clone);
  }

  function setSelected(id){
    selectedStandId = id;
    // form
    const s = standsById.get(id) || {standId:id, status:"available", company:""};
    standIdEl.value = id;
    statusEl.value = statusNorm(s.status);
    companyEl.value = s.company || "";
    // visuals
    computeStandBoxes();
    drawOverlay();
    renderZoom();
    // table highlight
    Array.from(tbody.querySelectorAll("tr")).forEach(tr => {
      tr.classList.toggle("active", tr.dataset.id === id);
    });
  }

  function renderTable(){
    const q = (searchEl.value||"").toLowerCase().trim();
    const f = filterEl.value;
    const rows = standsData
      .filter(s => {
        const st = statusNorm(s.status);
        if(f !== "all" && st !== f) return false;
        const comp = (s.company||"").toLowerCase();
        const id = (s.standId||"").toLowerCase();
        return !q || comp.includes(q) || id.includes(q);
      })
      .sort((a,b) => (a.standId||"").localeCompare(b.standId||""));
    countMeta.textContent = `${rows.length} / ${standsData.length}`;
    tbody.innerHTML = "";
    for(const s of rows){
      const tr = document.createElement("tr");
      tr.dataset.id = s.standId;
      if(s.standId === selectedStandId) tr.classList.add("active");
      const st = statusNorm(s.status);
      tr.innerHTML = `
        <td><strong>${escapeHtml(s.standId)}</strong></td>
        <td><span class="badge ${st==='sold'?'sold':'avail'}">${st==='sold'?'Sold':'Available'}</span></td>
        <td>${escapeHtml(s.company||"")}</td>
      `;
      tr.addEventListener("click", () => setSelected(s.standId));
      tbody.appendChild(tr);
    }
  }

  function bindStandClicks(){
    for(const [id, el] of standEls.entries()){
      el.onpointerdown = null;
      el.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        setSelected(id);
      });
    }
  }

  function escapeHtml(str){
    return (str||"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function refresh(){
    const [settings, stands] = await Promise.all([
      fetchJson(SETTINGS_ENDPOINT).catch(()=>({eventName:"", updatedAt:null})),
      fetchJson(STANDS_ENDPOINT)
    ]);
    standsData = Array.isArray(stands) ? stands : (stands.stands || []);
    standsById = new Map(standsData.map(s => [normId(s.standId), s]));
    if(settings && typeof settings.eventName === "string") eventNameEl.value = settings.eventName;
    const updated = settings.updatedAt || settings.lastUpdated || settings.updated || new Date().toLocaleTimeString();
    syncMeta.textContent = `Synced: ${updated}`;

    if(svgRoot){
      findStandElements();
      applyColors();
      computeStandBoxes();
      bindStandClicks();
      drawOverlay();
      renderZoom();
    }
    renderTable();
  }

  async function saveCurrent(){
    if(!selectedStandId) return;
    const payload = {
      standId: selectedStandId,
      status: statusEl.value,
      company: (statusEl.value === "sold") ? (companyEl.value||"").trim() : ""
    };
    // optimistic update
    const local = standsById.get(selectedStandId) || {};
    local.status = payload.status;
    local.company = payload.company;
    standsById.set(selectedStandId, local);
    standsData = standsData.map(s => s.standId === selectedStandId ? Object.assign({}, s, payload) : s);
    applyColors();
    renderTable();

    await fetchJson(UPDATE_ENDPOINT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    }).catch(err => {
      alert("Save failed. Please try again.\n\n" + err.message);
    });
    await refresh().catch(()=>{});
  }

  async function markAvailable(){
    if(!selectedStandId) return;
    statusEl.value = "available";
    companyEl.value = "";
    await saveCurrent();
  }

  async function saveEventName(){
    const name = (eventNameEl.value||"").trim();
    if(!name) return;
    await fetchJson(`${SETTINGS_ENDPOINT}`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({eventName: name})
    }).catch(()=>{});
    await refresh().catch(()=>{});
  }

  async function exportCsv(){
    const r = await fetch(EXPORT_CSV_ENDPOINT, {cache:"no-store"});
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "stands.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importCsv(){
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = ".csv,text/csv";
    inp.onchange = async () => {
      const file = inp.files && inp.files[0];
      if(!file) return;
      const fd = new FormData();
      fd.append("file", file);
      await fetch(IMPORT_CSV_ENDPOINT, {method:"POST", body: fd}).catch(err => alert("Import failed: " + err.message));
      await refresh().catch(()=>{});
    };
    inp.click();
  }

  async function resetAll(){
    if(!confirm("Reset all stands to Available and clear companies?")) return;
    await fetchJson(RESET_ENDPOINT, {method:"POST"}).catch(err => alert("Reset failed: " + err.message));
    await refresh().catch(()=>{});
  }

  function onResize(){
    if(!svgRoot) return;
    computeStandBoxes();
    drawOverlay();
  }

  function setPaused(v){
    paused = v;
    pauseBtn.textContent = paused ? "Resume sync" : "Pause sync";
    pauseBtn.style.background = paused ? "rgba(0,0,0,.06)" : "#fff";
  }

  // ===== INIT =====
  saveBtn.addEventListener("click", saveCurrent);
  markAvailBtn.addEventListener("click", markAvailable);
  eventNameEl.addEventListener("change", saveEventName);

  searchEl.addEventListener("input", renderTable);
  filterEl.addEventListener("change", renderTable);

  pauseBtn.addEventListener("click", () => setPaused(!paused));
  exportCsvBtn.addEventListener("click", exportCsv);
  importCsvBtn.addEventListener("click", importCsv);
  resetBtn.addEventListener("click", resetAll);

  window.addEventListener("resize", () => {
    clearTimeout(window.__rz);
    window.__rz = setTimeout(onResize, 120);
  });

  (async () => {
    try{
      await loadSvg();
      await refresh();
      pollTimer = setInterval(async () => {
        if(paused) return;
        await refresh().catch(()=>{});
      }, 12000);
    }catch(e){
      console.error(e);
      alert("Failed to load admin:\n\n" + (e.message || e));
    }
  })();
})();
</script>
</body>
</html>