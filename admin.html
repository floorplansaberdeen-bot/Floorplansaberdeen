<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin â€“ Exhibition Floorplan</title>

<style>
  body { font-family: sans-serif; margin: 0; }
  header {
    padding: 10px;
    background: #222;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #svg-container svg { width: 100%; height: auto; cursor: pointer; }
  .stand-available { fill: #4CAF50 !important; }
  .stand-sold { fill: #E53935 !important; }

  #panel {
    padding: 10px;
    border-bottom: 1px solid #ccc;
    display: none;
  }

  textarea { width: 100%; }
</style>
</head>

<body>

<header>
  <strong>Admin</strong>
  <a href="#" id="logout" style="color:#fff;">Logout</a>
</header>

<div id="panel">
  <strong id="panel-id"></strong><br><br>
  <select id="panel-status">
    <option value="available">Available</option>
    <option value="sold">Sold</option>
  </select><br><br>
  <textarea id="panel-company" rows="3"></textarea><br><br>
  <button onclick="save()">Save</button>
</div>

<div id="svg-container"></div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbxEq83BUYJ-oewP_2lPFL0tyol4veM2mhukSTTMCaKCZgEJS5m-f8Jqy1EO_bDc3q3a/exec";

let svgRoot = null;
let standData = [];
let pinnedId = null;

/* =========================
   AUTH
   ========================= */
const ADMIN_PASSWORD = "CHANGE_ME";
if (!sessionStorage.admin) {
  const pw = prompt("Admin password:");
  if (pw !== ADMIN_PASSWORD) location.reload();
  sessionStorage.admin = "1";
}
document.getElementById("logout").onclick = () => {
  sessionStorage.clear();
  location.reload();
};

/* =========================
   SVG LOAD
   ========================= */
fetch("event_plan.svg")
  .then(r => r.text())
  .then(svg => {
    document.getElementById("svg-container").innerHTML = svg;
    svgRoot = document.querySelector("svg");
    svgRoot.addEventListener("click", onSvgClick);
    refresh();
  });

/* =========================
   JSONP LOAD
   ========================= */
function loadData() {
  return new Promise(resolve => {
    const cb = "cb_" + Date.now();
    window[cb] = d => {
      delete window[cb];
      s.remove();
      resolve(d);
    };
    const s = document.createElement("script");
    s.src = `${SCRIPT_URL}?callback=${cb}`;
    document.body.appendChild(s);
  });
}

async function refresh() {
  standData = await loadData();
  applyColours();
}

/* =========================
   CLICK HANDLING
   ========================= */
function onSvgClick(e) {
  let el = e.target;
  while (el && el !== svgRoot) {
    const id = el.getAttribute("data-name") || el.id;
    if (id) return pin(id);
    el = el.parentNode;
  }
}

function pin(id) {
  const row = standData.find(r => r.standId === id);
  if (!row) return;

  pinnedId = id;
  document.getElementById("panel").style.display = "block";
  document.getElementById("panel-id").textContent = id;
  document.getElementById("panel-status").value = row.status;
  document.getElementById("panel-company").value = row.company || "";
}

/* =========================
   SAVE
   ========================= */
function save() {
  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      standId: pinnedId,
      status: document.getElementById("panel-status").value,
      company: document.getElementById("panel-company").value
    })
  }).then(refresh);
}

/* =========================
   COLOURS
   ========================= */
function applyColours() {
  standData.forEach(r => {
    const el = findStand(r.standId);
    if (!el) return;
    el.classList.remove("stand-available", "stand-sold");
    el.classList.add(
      r.status === "sold" ? "stand-sold" : "stand-available"
    );
  });
}

function findStand(id) {
  return [...svgRoot.querySelectorAll("[id],[data-name]")]
    .find(el =>
      el.getAttribute("data-name") === id ||
      el.id === id
    );
}
</script>

</body>
</html>
